<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="GAYI KOMI SELASSI" />

<meta name="date" content="2025-10-19" />

<title>“Modeling Functional Attrition and Quality-of-Life Dynamics in Oncology: A Three-State Multi-State and Predictive Approach (NCT02349412)</title>

<script src="site_libs/header-attrs-2.27/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">My Website</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">“Modeling Functional Attrition and
Quality-of-Life Dynamics in Oncology: A Three-State Multi-State and
Predictive Approach (NCT02349412)</h1>
<h4 class="author">GAYI KOMI SELASSI</h4>
<h4 class="date">2025-10-19</h4>

</div>


<div id="section" class="section level1">
<h1><em>===========================================</em></h1>
</div>
<div id="prediction-et-comparaison-mice-ipcw" class="section level1">
<h1><em>2.Prediction et comparaison MICE &amp; IPCW</em></h1>
</div>
<div id="section-1" class="section level1">
<h1><em>===========================================</em></h1>
<div id="import-and-data-preparation" class="section level3">
<h3><em>1. Import and data preparation</em></h3>
<pre class="r"><code>data_main_clean &lt;- readRDS(&quot;Data_Preparation_&amp;_Descriptive_output/data_main_clean_pred.rds&quot;)</code></pre>
<pre class="r"><code># Remove rows with missing values in specific variables
data_main_clean &lt;- data_main_clean[!is.na(data_main_clean$edu_cat) &amp;
                                   !is.na(data_main_clean$race_cat) &amp;
                                   !is.na(data_main_clean$marital_cat), ]

#glimpse(data_main_clean)</code></pre>
</div>
<div id="modelisation-with-ipcw" class="section level3">
<h3><em>2. Modelisation with IPCW</em></h3>
<p><em>Setup &amp; paramètres</em></p>
<pre class="r"><code>library(dplyr); library(ggplot2); library(caret); library(glmnet)</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre><code>## Loading required package: lattice</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## Loaded glmnet 4.1-9</code></pre>
<pre class="r"><code>library(ranger); library(xgboost); library(pROC); library(tidyr); library(flextable)</code></pre>
<pre><code>## 
## Attaching package: &#39;xgboost&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     slice</code></pre>
<pre><code>## Type &#39;citation(&quot;pROC&quot;)&#39; for a citation.</code></pre>
<pre><code>## 
## Attaching package: &#39;pROC&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     cov, smooth, var</code></pre>
<pre><code>## 
## Attaching package: &#39;tidyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:Matrix&#39;:
## 
##     expand, pack, unpack</code></pre>
<pre class="r"><code>library(xtable); library(doParallel)</code></pre>
<pre><code>## 
## Attaching package: &#39;xtable&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:flextable&#39;:
## 
##     align</code></pre>
<pre><code>## Loading required package: foreach</code></pre>
<pre><code>## Loading required package: iterators</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<pre class="r"><code>outdir &lt;- &quot;outputs_prediction_IPCW&quot;
dir.create(outdir, showWarnings = FALSE)

set.seed(123)
n_splits &lt;- 20        # nombre de splits 80/20 (génère distribution des metrics)
ncores &lt;- parallel::detectCores() - 1
registerDoParallel(cores = ncores)

thresholds &lt;- c(0, -5, -7, -10)
models_to_run &lt;- c(&quot;glmnet&quot;,&quot;rf&quot;,&quot;xgb&quot;)</code></pre>
<p><em>IPCW : estimation, stabilisation, troncatures &amp; diagnostics
(plus comparaison de troncatures)</em></p>
<pre class="r"><code># Estimation des poids IPCW et diagnostics (plus test de plusieurs troncatures)
df_w24 &lt;- data_main_clean %&gt;%
  dplyr::select(patref, state_t24, fact_chg24, everything())

df_w24 &lt;- df_w24 %&gt;% mutate(R24 = ifelse(!is.na(fact_chg24), 1, 0))

# Modèle baseline pour p_obs (documenter la formule)
modR_glm &lt;- glm(R24 ~ age + ecogps + fact_bl + n12 + sex + tumrtyp,
                data = df_w24, family = binomial)

df_w24$p_obs_glm &lt;- predict(modR_glm, type = &quot;response&quot;)

# Poids stabilisés (initial)
df_w24 &lt;- df_w24 %&gt;%
  mutate(weight_ipcw = ifelse(R24 == 1, 1 / p_obs_glm, NA))

mean_pobs_obs &lt;- mean(df_w24$p_obs_glm[df_w24$R24 == 1], na.rm = TRUE)
df_w24 &lt;- df_w24 %&gt;%
  mutate(weight_ipcw = ifelse(R24==1, weight_ipcw * mean_pobs_obs, NA))

# Fonction trimming / troncature paramétrable (percentiles)
trim_weights &lt;- function(w, low = 0.01, high = 0.99) {
  ql &lt;- quantile(w, probs = low, na.rm = TRUE)
  qh &lt;- quantile(w, probs = high, na.rm = TRUE)
  w_t &lt;- pmin(pmax(w, ql), qh)
  return(w_t)
}

# Tester plusieurs troncatures et calculer ESS pour chacune
trunc_options &lt;- list(c(0.01,0.99), c(0.05,0.95), c(0.10,0.90))
trunc_res &lt;- list()
for (t in trunc_options) {
  w_t &lt;- df_w24$weight_ipcw
  w_t[!is.na(w_t)] &lt;- trim_weights(w_t[!is.na(w_t)], low = t[1], high = t[2])
  ess &lt;- (sum(w_t, na.rm=TRUE)^2) / sum((w_t^2), na.rm = TRUE)
  trunc_res[[paste0(&quot;p&quot;,t[1]*100,&quot;_&quot;,t[2]*100)]] &lt;- list(trunc = t, ess = ess,
                                                         summary = summary(w_t),
                                                         quantiles = quantile(w_t, probs = seq(0,1,0.05), na.rm=TRUE))
  # save histogram
  png(file.path(outdir, paste0(&quot;weights_hist_p&quot;,t[1]*100,&quot;_&quot;,t[2]*100,&quot;.png&quot;)), width=700, height=500)
  hist(w_t[!is.na(w_t)], breaks=40, main=paste0(&quot;Weights histogram (&quot;, t[1],&quot; - &quot;, t[2],&quot;)&quot;),
       xlab=&quot;Truncated IPCW&quot;, col=&quot;steelblue&quot;)
  dev.off()
}

# Choose a default truncation to use downstream (document choice)
# ici on choisit 1-99% (conservateur), tu peux changer après revue des histogrammes
df_w24$weight_ipcw_trunc &lt;- NA
df_w24$weight_ipcw_trunc[df_w24$R24==1] &lt;-
  trim_weights(df_w24$weight_ipcw[df_w24$R24==1], low=0.01, high=0.99)

# ESS final &amp; summary
ess_final &lt;- (sum(df_w24$weight_ipcw_trunc, na.rm=TRUE)^2) / sum(df_w24$weight_ipcw_trunc^2, na.rm=TRUE)
cat(&quot;ESS after truncation (1-99%):&quot;, round(ess_final,1), &quot;\n&quot;)</code></pre>
<pre><code>## ESS after truncation (1-99%): 126.9</code></pre>
<pre class="r"><code>write.csv(do.call(rbind, lapply(trunc_res, function(x) {
  data.frame(ess = x$ess)
})), file.path(outdir,&quot;truncation_ess_summary.csv&quot;), row.names = TRUE)

# Save model summary for modR_glm
capture.output(summary(modR_glm), file = file.path(outdir,&quot;modR_glm_summary.txt&quot;))</code></pre>
<pre class="r"><code># ===============================
# Diagnostics ESS + résumé par troncature (avec NA)
# ===============================

compute_diagnostics_df &lt;- function(weights, lower, upper) {
  # Compter NA
  n_na &lt;- sum(is.na(weights))
  
  # Appliquer troncature
  qlow &lt;- quantile(weights, lower, na.rm=TRUE)
  qhigh &lt;- quantile(weights, upper, na.rm=TRUE)
  w_trunc &lt;- pmin(pmax(weights, qlow), qhigh)
  
  # ESS
  ess &lt;- (sum(w_trunc, na.rm=TRUE))^2 / sum(w_trunc^2, na.rm=TRUE)
  
  # Résumés
  summ &lt;- as.numeric(summary(w_trunc))
  
  data.frame(
    Truncation = paste0(lower*100,&quot;-&quot;,upper*100,&quot;%&quot;),
    ESS = round(ess,1),
    Min = round(summ[1],3),
    Q1 = round(summ[2],3),
    Median = round(summ[3],3),
    Mean = round(summ[4],3),
    Q3 = round(summ[5],3),
    Max = round(summ[6],3),
    N_NA = n_na
  )
}

# Tester plusieurs bornes
diag_table &lt;- dplyr::bind_rows(
  compute_diagnostics_df(df_w24$weight_ipcw, 0.01, 0.99),
  compute_diagnostics_df(df_w24$weight_ipcw, 0.05, 0.95),
  compute_diagnostics_df(df_w24$weight_ipcw, 0.10, 0.90)
)

library(knitr)
library(kableExtra)</code></pre>
<pre><code>## Warning: package &#39;kableExtra&#39; was built under R version 4.4.3</code></pre>
<pre><code>## 
## Attaching package: &#39;kableExtra&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:flextable&#39;:
## 
##     as_image, footnote</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     group_rows</code></pre>
<pre class="r"><code>diag_table %&gt;%
  kbl(caption = &quot;Diagnostics of IPCW weights under different truncation bounds&quot;) %&gt;%
  kable_classic(full_width = FALSE, html_font = &quot;Times New Roman&quot;) %&gt;%
  column_spec(1, bold = TRUE) %&gt;%
  column_spec(2:8, width = &quot;6em&quot;) %&gt;%
  column_spec(9, color = &quot;red&quot;, bold = TRUE)</code></pre>
<table class=" lightable-classic" style="font-family: Times New Roman; width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Diagnostics of IPCW weights under different truncation bounds
</caption>
<thead>
<tr>
<th style="text-align:left;">
Truncation
</th>
<th style="text-align:right;">
ESS
</th>
<th style="text-align:right;">
Min
</th>
<th style="text-align:right;">
Q1
</th>
<th style="text-align:right;">
Median
</th>
<th style="text-align:right;">
Mean
</th>
<th style="text-align:right;">
Q3
</th>
<th style="text-align:right;">
Max
</th>
<th style="text-align:right;">
N_NA
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
1-99%
</td>
<td style="text-align:right;width: 6em; ">
126.9
</td>
<td style="text-align:right;width: 6em; ">
0.690
</td>
<td style="text-align:right;width: 6em; ">
0.866
</td>
<td style="text-align:right;width: 6em; ">
1.011
</td>
<td style="text-align:right;width: 6em; ">
1.064
</td>
<td style="text-align:right;width: 6em; ">
1.143
</td>
<td style="text-align:right;width: 6em; ">
2.190
</td>
<td style="text-align:right;font-weight: bold;color: red !important;">
182
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
5-95%
</td>
<td style="text-align:right;width: 6em; ">
129.2
</td>
<td style="text-align:right;width: 6em; ">
0.717
</td>
<td style="text-align:right;width: 6em; ">
0.866
</td>
<td style="text-align:right;width: 6em; ">
1.011
</td>
<td style="text-align:right;width: 6em; ">
1.051
</td>
<td style="text-align:right;width: 6em; ">
1.143
</td>
<td style="text-align:right;width: 6em; ">
1.718
</td>
<td style="text-align:right;font-weight: bold;color: red !important;">
182
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
10-90%
</td>
<td style="text-align:right;width: 6em; ">
131.6
</td>
<td style="text-align:right;width: 6em; ">
0.773
</td>
<td style="text-align:right;width: 6em; ">
0.866
</td>
<td style="text-align:right;width: 6em; ">
1.011
</td>
<td style="text-align:right;width: 6em; ">
1.036
</td>
<td style="text-align:right;width: 6em; ">
1.143
</td>
<td style="text-align:right;width: 6em; ">
1.466
</td>
<td style="text-align:right;font-weight: bold;color: red !important;">
182
</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Sauvegarde CSV pour rapport
write.csv(diag_table, &quot;IPCW_diagnostics_summary.csv&quot;, row.names=FALSE)</code></pre>
<p><em>Bloc C — Repeated random splits (80/20)</em></p>
<pre class="r"><code># =====================================================
# BLOC C : repeated 80/20 splits -&gt; fold-by-fold metrics
# + ajout CI 95% des AUC et comparaisons DeLong / Bootstrap ΔAUC
# =====================================================

recompute_weights_on_train &lt;- TRUE
results_rows &lt;- list()
all_importances &lt;- list()

for (thr in thresholds) {
  cat(&quot;=== Threshold&quot;, thr, &quot;===\n&quot;)
  
  df_thr0 &lt;- df_w24 %&gt;%
    mutate(fact_chg24_bin = ifelse(!is.na(fact_chg24) &amp; fact_chg24 &lt;= thr, 1,
                            ifelse(!is.na(fact_chg24), 0, NA))) %&gt;%
    filter(!is.na(fact_chg24_bin))
  
  if(sum(df_thr0$fact_chg24_bin==1, na.rm=TRUE) &lt; 5) {
    cat(&quot;Too few events for threshold&quot;, thr, &quot;- skipping\n&quot;)
    next
  }
  
  predictors_w24 &lt;- c(&quot;age&quot;, &quot;sex&quot;, &quot;ecogps&quot;, &quot;fact_bl&quot;, &quot;tumrtyp&quot;, &quot;arm&quot;, &quot;cgpart&quot;,
                      &quot;hads_pt_anx_bl&quot;,&quot;hads_pt_dep_bl&quot;, &quot;edu_cat&quot;)
  predictors_w24 &lt;- predictors_w24[predictors_w24 %in% colnames(df_thr0)]
  
  for (s in 1:n_splits) {
    set.seed(1000 + s + as.integer(thr*10))
    idx &lt;- createDataPartition(df_thr0$fact_chg24_bin, p = 0.8, list = FALSE)
    train_df &lt;- df_thr0[idx, ]
    test_df  &lt;- df_thr0[-idx, ]
    
    if(recompute_weights_on_train) {
      modR_train &lt;- glm(R24 ~ age + ecogps + fact_bl + n12 + sex + tumrtyp,
                        data = data.frame(train_df), family = binomial)
      p_obs_train &lt;- predict(modR_train, type=&quot;response&quot;, newdata = train_df)
      train_df$w &lt;- ifelse(train_df$R24==1, (1/p_obs_train) * mean(p_obs_train, na.rm=TRUE), NA)
      p_obs_test &lt;- predict(modR_train, type=&quot;response&quot;, newdata=test_df)
      test_df$w &lt;- ifelse(test_df$R24==1, (1/p_obs_test) * mean(p_obs_train, na.rm=TRUE), NA)
      qlow &lt;- quantile(c(train_df$w, test_df$w), 0.10, na.rm = TRUE)
      qhigh &lt;- quantile(c(train_df$w, test_df$w), 0.90, na.rm = TRUE)
      train_df$w[!is.na(train_df$w)] &lt;- pmin(pmax(train_df$w[!is.na(train_df$w)], qlow), qhigh)
      test_df$w[!is.na(test_df$w)]  &lt;- pmin(pmax(test_df$w[!is.na(test_df$w)], qlow), qhigh)
    } else {
      train_df$w &lt;- train_df$weight_ipcw_trunc
      test_df$w &lt;- test_df$weight_ipcw_trunc
    }
    
    model_train &lt;- train_df %&gt;% select(all_of(c(&quot;fact_chg24_bin&quot;, predictors_w24, &quot;w&quot;)))
    model_test  &lt;- test_df  %&gt;% select(all_of(c(&quot;fact_chg24_bin&quot;, predictors_w24, &quot;w&quot;)))
    
    model_train$fact_chg24_bin &lt;- factor(model_train$fact_chg24_bin, levels = c(0,1), labels = c(&quot;no&quot;,&quot;yes&quot;))
    model_test$fact_chg24_bin &lt;- factor(model_test$fact_chg24_bin, levels = c(0,1), labels = c(&quot;no&quot;,&quot;yes&quot;))
    
    ctrl &lt;- trainControl(method = &quot;cv&quot;, number = 5, classProbs = TRUE,
                         summaryFunction = twoClassSummary, savePredictions = &quot;final&quot;, allowParallel = TRUE)
    
    grid_glmnet &lt;- expand.grid(alpha = 1, lambda = 10^seq(-4, 0, length = 20))
    fit_glmnet &lt;- tryCatch(
      train(fact_chg24_bin ~ ., data = model_train %&gt;% select(-w),
            method = &quot;glmnet&quot;, metric = &quot;ROC&quot;, trControl = ctrl,
            preProcess = c(&quot;center&quot;,&quot;scale&quot;), tuneGrid = grid_glmnet,
            weights = model_train$w),
      error = function(e) { message(&quot;glmnet error: &quot;, e); NULL }
    )
    
    fit_rf &lt;- tryCatch(
      train(fact_chg24_bin ~ ., data = model_train %&gt;% select(-w),
            method = &quot;ranger&quot;, metric = &quot;ROC&quot;, trControl = ctrl,
            tuneLength = 5, importance = &quot;impurity&quot;, weights = model_train$w),
      error = function(e) { message(&quot;rf error: &quot;, e); NULL }
    )
    
    fit_xgb &lt;- tryCatch(
      train(fact_chg24_bin ~ ., data = model_train %&gt;% select(-w),
            method = &quot;xgbTree&quot;, metric = &quot;ROC&quot;, trControl = ctrl,
            tuneLength = 4, weights = model_train$w),
      error = function(e) { message(&quot;xgb error: &quot;, e); NULL }
    )
    
    model_list &lt;- list(glmnet = fit_glmnet, rf = fit_rf, xgb = fit_xgb)
    for (mname in names(model_list)) {
      fit &lt;- model_list[[mname]]
      if(is.null(fit)) {
        results_rows[[length(results_rows)+1]] &lt;- data.frame(
          Threshold = thr, Split = s, Model = mname,
          AUC = NA, AUC_low = NA, AUC_high = NA,
          Brier = NA, Slope = NA,
          Events = sum(model_test$fact_chg24_bin==&quot;yes&quot;),
          n_test = nrow(model_test)
        )
        next
      }
      pred_prob &lt;- predict(fit, newdata = model_test %&gt;% select(-w), type = &quot;prob&quot;)[,&quot;yes&quot;]
      y_test &lt;- ifelse(model_test$fact_chg24_bin == &quot;yes&quot;, 1, 0)
      w_test &lt;- model_test$w
      
      # ROC + CI95%
      roc_obj &lt;- tryCatch(roc(model_test$fact_chg24_bin, pred_prob, weights = w_test), error = function(e) NULL)
      if(!is.null(roc_obj)){
        auc_val &lt;- auc(roc_obj)
        ci_obj &lt;- ci.auc(roc_obj, conf.level=0.95)
        auc_low &lt;- ci_obj[1]
        auc_high &lt;- ci_obj[3]
      } else {
        auc_val &lt;- NA; auc_low &lt;- NA; auc_high &lt;- NA
      }
      
      # Brier
      brier_val &lt;- if(!all(is.na(pred_prob))) weighted.mean((pred_prob - y_test)^2, w = w_test, na.rm = TRUE) else NA
      
      # Calibration slope
      eps &lt;- 1e-6
      lp &lt;- qlogis(pmin(pmax(pred_prob, eps), 1-eps))
      calib_mod &lt;- tryCatch(glm(y_test ~ lp, family = binomial, weights = w_test), error = function(e) NULL)
      slope_val &lt;- if(!is.null(calib_mod)) coef(calib_mod)[2] else NA
      
      # Importance
      varimp_df &lt;- NULL
      if(mname == &quot;glmnet&quot; &amp;&amp; !is.null(fit)) {
        lambda_best &lt;- fit$bestTune$lambda
        coefs &lt;- as.matrix(coef(fit$finalModel, s = lambda_best))
        varimp_df &lt;- data.frame(Variable = rownames(coefs),
                                Coefficient = as.numeric(coefs)) %&gt;%
          dplyr::filter(Variable != &quot;(Intercept)&quot; &amp; Coefficient != 0)
      } else if(mname %in% c(&quot;rf&quot;,&quot;xgb&quot;) &amp;&amp; !is.null(fit)) {
        varimp_df &lt;- varImp(fit)$importance %&gt;%
          tibble::rownames_to_column(&quot;Variable&quot;) %&gt;%
          rename(Importance = Overall)
      }
      all_importances[[paste0(&quot;thr&quot;,thr,&quot;_split&quot;,s,&quot;_&quot;,mname)]] &lt;- varimp_df
      
      results_rows[[length(results_rows)+1]] &lt;- data.frame(
        Threshold = thr, Split = s, Model = mname,
        AUC = as.numeric(auc_val),
        AUC_low = as.numeric(auc_low),
        AUC_high = as.numeric(auc_high),
        Brier = as.numeric(brier_val),
        Slope = as.numeric(slope_val),
        Events = sum(model_test$fact_chg24_bin==&quot;yes&quot;),
        n_test = nrow(model_test)
      )
    }
  }
}</code></pre>
<pre><code>## === Threshold 0 ===</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## === Threshold -5 ===</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## === Threshold -7 ===</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## === Threshold -10 ===</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning in ci.auc.roc(roc_obj, conf.level = 0.95): ci.auc() of a ROC curve with
## AUC == 1 is always 1-1 and can be misleading.
## Warning in ci.auc.roc(roc_obj, conf.level = 0.95): glm.fit: algorithm did not
## converge</code></pre>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning in ci.auc.roc(roc_obj, conf.level = 0.95): ci.auc() of a ROC curve with
## AUC == 1 is always 1-1 and can be misleading.
## Warning in ci.auc.roc(roc_obj, conf.level = 0.95): glm.fit: algorithm did not
## converge</code></pre>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes
## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<pre><code>## Warning: glm.fit: algorithm did not converge</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre><code>## Setting levels: control = no, case = yes</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<pre class="r"><code>results_df_splits &lt;- bind_rows(results_rows)
write.csv(results_df_splits, file.path(outdir,&quot;results_splits_fold_by_fold_CI.csv&quot;), row.names = FALSE)
saveRDS(all_importances, file = file.path(outdir,&quot;varimp_all_splits_CI.rds&quot;))</code></pre>
<pre class="r"><code># BLOC D : résumé mediane / IQR + boxplots / heatmap
library(ggplot2); library(dplyr); library(tidyr)

res_summary &lt;- results_df_splits %&gt;%
  group_by(Threshold, Model) %&gt;%
  summarise(
    AUC_median = median(AUC, na.rm=TRUE),
    AUC_IQR = IQR(AUC, na.rm=TRUE),
    Brier_median = median(Brier, na.rm=TRUE),
    Brier_IQR = IQR(Brier, na.rm=TRUE),
    Slope_median = median(Slope, na.rm=TRUE),
    Slope_IQR = IQR(Slope, na.rm=TRUE),
    n_splits = n(),
    median_events = median(Events, na.rm=TRUE),
    .groups = &quot;drop&quot;
  )

write.csv(res_summary, file.path(outdir,&quot;summary_median_IQR_1.csv&quot;), row.names = FALSE)

# Boxplots AUC
ggplot(results_df_splits, aes(x=factor(Threshold), y=AUC, fill=Model)) +
  geom_boxplot() + labs(title=&quot;AUC by Threshold and Model (repeated splits)&quot;, x=&quot;Threshold&quot;, y=&quot;AUC&quot;) +
  theme_minimal(base_size=13)</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<pre class="r"><code>ggsave(file.path(outdir,&quot;AUC_boxplot_repeated_splits_1.png&quot;), width=8, height=5)

# Boxplots Brier
ggplot(results_df_splits, aes(x=factor(Threshold), y=Brier, fill=Model)) +
  geom_boxplot() + labs(title=&quot;Brier by Threshold and Model (repeated splits)&quot;, x=&quot;Threshold&quot;, y=&quot;Brier&quot;) +
  theme_minimal(base_size=13)</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-7-2.png" width="672" /></p>
<pre class="r"><code>ggsave(file.path(outdir,&quot;Brier_boxplot_repeated_splits_1.png&quot;), width=8, height=5)

# Slopes boxplot with reference line
ggplot(results_df_splits, aes(x=factor(Threshold), y=Slope, fill=Model)) +
  geom_boxplot() + geom_hline(yintercept=1, linetype=&quot;dashed&quot;, color=&quot;red&quot;) +
  labs(title=&quot;Calibration slope by Threshold and Model (repeated splits)&quot;, x=&quot;Threshold&quot;, y=&quot;Slope&quot;) +
  theme_minimal(base_size=13)</code></pre>
<pre><code>## Warning: Removed 1 row containing non-finite outside the scale range
## (`stat_boxplot()`).</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-7-3.png" width="672" /></p>
<pre class="r"><code>ggsave(file.path(outdir,&quot;Slope_boxplot_repeated_splits_1.png&quot;), width=8, height=5)</code></pre>
<pre><code>## Warning: Removed 1 row containing non-finite outside the scale range
## (`stat_boxplot()`).</code></pre>
<pre class="r"><code># Heatmap of medians
res_long &lt;- res_summary %&gt;%
  pivot_longer(cols = c(AUC_median, Brier_median, Slope_median), names_to = &quot;Metric&quot;, values_to = &quot;Value&quot;)

ggplot(res_long, aes(x=factor(Threshold), y=Model, fill=Value)) +
  geom_tile(color=&quot;white&quot;) +
  facet_wrap(~Metric, scales=&quot;free&quot;) +
  geom_text(aes(label = round(Value,2))) +
  labs(title=&quot;Median performance by Threshold and Model&quot;, x=&quot;Threshold&quot;, y=&quot;Model&quot;) +
  theme_minimal(base_size=12)</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-7-4.png" width="672" /></p>
<pre class="r"><code>ggsave(file.path(outdir,&quot;Median_heatmap_1.png&quot;), width=10, height=6)</code></pre>
<pre class="r"><code>saveRDS(all_importances, file = file.path(outdir,&quot;varimp_all_splits_1.rds&quot;))</code></pre>
<pre class="r"><code>all_importances &lt;- readRDS(file.path(outdir,&quot;varimp_all_splits_1.rds&quot;))

# transformer la liste en un tableau harmonisé
varimp_df &lt;- bind_rows(
  lapply(names(all_importances), function(name) {
    df &lt;- all_importances[[name]]
    if (is.null(df) || nrow(df) == 0) return(NULL)
    df$Run &lt;- name
    
    # harmoniser les colonnes
    if (&quot;Coefficient&quot; %in% names(df)) {
      df &lt;- df %&gt;% rename(Importance = Coefficient)
    }
    df
  })
)

# Séparer infos du nom
varimp_df &lt;- varimp_df %&gt;%
  tidyr::separate(Run, into = c(&quot;thr&quot;, &quot;split&quot;, &quot;model&quot;), sep = &quot;_&quot;, remove = FALSE)

# Résumé
summary_varimp &lt;- varimp_df %&gt;%
  group_by(thr, model, Variable) %&gt;%
  summarise(
    MedianImportance = median(abs(Importance), na.rm = TRUE),
    IQRImportance = IQR(abs(Importance), na.rm = TRUE),
    .groups = &quot;drop&quot;
  ) %&gt;%
  arrange(thr, model, desc(MedianImportance))</code></pre>
<pre class="r"><code>library(knitr)
library(kableExtra)

# tableau publication ready
summary_varimp %&gt;%
  mutate(
    MedianImportance = round(MedianImportance, 3),
    IQRImportance = round(IQRImportance, 3)
  ) %&gt;%
  arrange(thr, model, desc(MedianImportance)) %&gt;%
  kable(
    format = &quot;html&quot;,  # mets &quot;latex&quot; si tu compiles en PDF
    booktabs = TRUE,
    caption = &quot;Variable Importance Across Thresholds and Models&quot;,
    col.names = c(&quot;Threshold&quot;, &quot;Model&quot;, &quot;Variable&quot;, &quot;Median |Importance|&quot;, &quot;IQR |Importance|&quot;)
  ) %&gt;%
  kable_styling(
    bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;, &quot;responsive&quot;),
    full_width = FALSE,
    font_size = 12
  ) %&gt;%
  collapse_rows(columns = c(1, 2), valign = &quot;top&quot;)</code></pre>
<table class="table table-striped table-hover table-condensed table-responsive" style="font-size: 12px; width: auto !important; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
Variable Importance Across Thresholds and Models
</caption>
<thead>
<tr>
<th style="text-align:left;">
Threshold
</th>
<th style="text-align:left;">
Model
</th>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:right;">
Median |Importance|
</th>
<th style="text-align:right;">
IQR |Importance|
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="36">
thr-10
</td>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
glmnet
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
1.394
</td>
<td style="text-align:right;">
1.040
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
1.130
</td>
<td style="text-align:right;">
0.398
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.929
</td>
<td style="text-align:right;">
0.423
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.836
</td>
<td style="text-align:right;">
0.293
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
0.403
</td>
<td style="text-align:right;">
0.310
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
0.378
</td>
<td style="text-align:right;">
0.192
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.328
</td>
<td style="text-align:right;">
0.226
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
0.276
</td>
<td style="text-align:right;">
0.338
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
0.147
</td>
<td style="text-align:right;">
0.121
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
0.102
</td>
<td style="text-align:right;">
0.165
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.091
</td>
<td style="text-align:right;">
0.086
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
0.052
</td>
<td style="text-align:right;">
0.180
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
rf
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
77.946
</td>
<td style="text-align:right;">
14.493
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
73.662
</td>
<td style="text-align:right;">
9.286
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
47.665
</td>
<td style="text-align:right;">
23.843
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
12.888
</td>
<td style="text-align:right;">
6.003
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
11.635
</td>
<td style="text-align:right;">
6.425
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
11.027
</td>
<td style="text-align:right;">
7.368
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
9.865
</td>
<td style="text-align:right;">
4.538
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
8.455
</td>
<td style="text-align:right;">
5.205
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
5.762
</td>
<td style="text-align:right;">
5.288
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
3.022
</td>
<td style="text-align:right;">
5.253
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
xgb
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
9.637
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
81.393
</td>
<td style="text-align:right;">
32.061
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
53.596
</td>
<td style="text-align:right;">
11.576
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
39.762
</td>
<td style="text-align:right;">
16.676
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
15.643
</td>
<td style="text-align:right;">
7.338
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
15.243
</td>
<td style="text-align:right;">
13.103
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
14.884
</td>
<td style="text-align:right;">
6.222
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
9.020
</td>
<td style="text-align:right;">
5.910
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
8.698
</td>
<td style="text-align:right;">
8.951
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
8.448
</td>
<td style="text-align:right;">
5.552
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
3.550
</td>
<td style="text-align:right;">
3.660
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="36">
thr-5
</td>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
glmnet
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
1.636
</td>
<td style="text-align:right;">
0.847
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
1.404
</td>
<td style="text-align:right;">
0.759
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
1.028
</td>
<td style="text-align:right;">
0.206
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.909
</td>
<td style="text-align:right;">
0.327
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.465
</td>
<td style="text-align:right;">
0.230
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
0.434
</td>
<td style="text-align:right;">
0.249
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
0.298
</td>
<td style="text-align:right;">
0.268
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
0.260
</td>
<td style="text-align:right;">
0.211
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
0.258
</td>
<td style="text-align:right;">
0.133
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
0.199
</td>
<td style="text-align:right;">
0.132
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.103
</td>
<td style="text-align:right;">
0.093
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
0.065
</td>
<td style="text-align:right;">
0.133
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
rf
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
1.278
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
83.614
</td>
<td style="text-align:right;">
23.016
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
78.780
</td>
<td style="text-align:right;">
13.422
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
59.808
</td>
<td style="text-align:right;">
32.107
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
17.583
</td>
<td style="text-align:right;">
22.957
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
13.424
</td>
<td style="text-align:right;">
16.289
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
13.261
</td>
<td style="text-align:right;">
16.003
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
10.517
</td>
<td style="text-align:right;">
15.189
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
9.285
</td>
<td style="text-align:right;">
18.868
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
8.911
</td>
<td style="text-align:right;">
10.588
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
3.503
</td>
<td style="text-align:right;">
4.696
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
xgb
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
99.472
</td>
<td style="text-align:right;">
13.508
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
90.073
</td>
<td style="text-align:right;">
20.310
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
64.635
</td>
<td style="text-align:right;">
30.481
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
48.341
</td>
<td style="text-align:right;">
20.839
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
14.445
</td>
<td style="text-align:right;">
9.866
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
13.512
</td>
<td style="text-align:right;">
16.387
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
11.891
</td>
<td style="text-align:right;">
5.690
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
11.594
</td>
<td style="text-align:right;">
9.747
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
8.526
</td>
<td style="text-align:right;">
9.199
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
8.432
</td>
<td style="text-align:right;">
12.714
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
2.205
</td>
<td style="text-align:right;">
8.968
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
1.108
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="36">
thr-7
</td>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
glmnet
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
2.019
</td>
<td style="text-align:right;">
0.703
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
1.539
</td>
<td style="text-align:right;">
0.591
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.993
</td>
<td style="text-align:right;">
0.217
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.945
</td>
<td style="text-align:right;">
0.085
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
0.586
</td>
<td style="text-align:right;">
0.210
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
0.440
</td>
<td style="text-align:right;">
0.244
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.427
</td>
<td style="text-align:right;">
0.985
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
0.180
</td>
<td style="text-align:right;">
0.163
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
0.165
</td>
<td style="text-align:right;">
0.162
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
0.154
</td>
<td style="text-align:right;">
0.104
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.137
</td>
<td style="text-align:right;">
0.079
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
0.099
</td>
<td style="text-align:right;">
0.082
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
rf
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
2.460
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
91.909
</td>
<td style="text-align:right;">
16.491
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
80.051
</td>
<td style="text-align:right;">
18.771
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
60.784
</td>
<td style="text-align:right;">
20.893
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
24.022
</td>
<td style="text-align:right;">
11.965
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
13.713
</td>
<td style="text-align:right;">
10.797
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
13.313
</td>
<td style="text-align:right;">
10.698
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
12.101
</td>
<td style="text-align:right;">
13.779
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
10.264
</td>
<td style="text-align:right;">
16.543
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
5.882
</td>
<td style="text-align:right;">
11.582
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
4.930
</td>
<td style="text-align:right;">
4.877
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
xgb
</td>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
12.111
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
83.335
</td>
<td style="text-align:right;">
37.535
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
43.823
</td>
<td style="text-align:right;">
22.552
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
43.107
</td>
<td style="text-align:right;">
15.181
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
17.948
</td>
<td style="text-align:right;">
10.859
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
12.855
</td>
<td style="text-align:right;">
9.156
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
9.517
</td>
<td style="text-align:right;">
13.320
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
8.433
</td>
<td style="text-align:right;">
5.504
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
7.647
</td>
<td style="text-align:right;">
4.952
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
5.544
</td>
<td style="text-align:right;">
6.554
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
5.097
</td>
<td style="text-align:right;">
9.234
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.050
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="36">
thr0
</td>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
glmnet
</td>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.668
</td>
<td style="text-align:right;">
0.465
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.625
</td>
<td style="text-align:right;">
0.524
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
0.261
</td>
<td style="text-align:right;">
0.156
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
0.235
</td>
<td style="text-align:right;">
0.173
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
0.232
</td>
<td style="text-align:right;">
0.207
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
0.165
</td>
<td style="text-align:right;">
0.134
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.127
</td>
<td style="text-align:right;">
0.155
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
0.104
</td>
<td style="text-align:right;">
0.119
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
0.090
</td>
<td style="text-align:right;">
0.031
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.087
</td>
<td style="text-align:right;">
0.031
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
0.080
</td>
<td style="text-align:right;">
0.064
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
0.069
</td>
<td style="text-align:right;">
0.057
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
rf
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
64.921
</td>
<td style="text-align:right;">
13.423
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
57.737
</td>
<td style="text-align:right;">
17.404
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
57.273
</td>
<td style="text-align:right;">
8.574
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
12.209
</td>
<td style="text-align:right;">
9.657
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
8.247
</td>
<td style="text-align:right;">
4.473
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
7.507
</td>
<td style="text-align:right;">
4.593
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
6.579
</td>
<td style="text-align:right;">
3.319
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
6.022
</td>
<td style="text-align:right;">
2.627
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
3.344
</td>
<td style="text-align:right;">
3.209
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
2.439
</td>
<td style="text-align:right;">
2.019
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="12">
xgb
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
68.613
</td>
<td style="text-align:right;">
24.832
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
56.799
</td>
<td style="text-align:right;">
14.638
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
50.070
</td>
<td style="text-align:right;">
15.224
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
13.677
</td>
<td style="text-align:right;">
7.457
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
13.276
</td>
<td style="text-align:right;">
4.670
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
11.002
</td>
<td style="text-align:right;">
6.901
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
10.730
</td>
<td style="text-align:right;">
7.688
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
8.703
</td>
<td style="text-align:right;">
11.484
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
7.085
</td>
<td style="text-align:right;">
7.739
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
4.506
</td>
<td style="text-align:right;">
3.977
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
2.344
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>library(ggplot2)
library(dplyr)

# Renommer la variable trop longue
summary_varimp &lt;- summary_varimp %&gt;%
  mutate(Variable = ifelse(Variable == &quot;tumrtypHepatic/Biliary/Pancreatic/Unknown primary&quot;,
                           &quot;tumrtypHepat/Bili/pan/prim&quot;,
                           Variable))

# Créer les plots pour chaque seuil (thr)
plots &lt;- lapply(unique(summary_varimp$thr), function(threshold) {
  df_thr &lt;- filter(summary_varimp, thr == threshold)
  
  ggplot(df_thr, aes(x = MedianImportance,
                     y = reorder(Variable, MedianImportance),
                     color = model)) +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = MedianImportance - IQRImportance/2,
                       xmax = MedianImportance + IQRImportance/2),
                   height = 0.2, alpha = 0.6) +
    labs(
      title = paste(&quot;Variable Importance IPCW analysis (Thr:&quot;, threshold, &quot;)&quot;),
      x = &quot;Median Importance (± IQR)&quot;,
      y = &quot;Variables&quot;,
      color = &quot;Model&quot;
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = &quot;bold&quot;),
      axis.title.x = element_text(face = &quot;bold&quot;),
      axis.title.y = element_text(face = &quot;bold&quot;),
      legend.position = &quot;bottom&quot;
    )
})

# afficher les 4 premiers plots
plots[[1]]</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<pre class="r"><code>plots[[2]]</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-11-2.png" width="672" /></p>
<pre class="r"><code>plots[[3]]</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-11-3.png" width="672" /></p>
<pre class="r"><code>plots[[4]]</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-11-4.png" width="672" /></p>
<p><em>Bloc E: MICE et prediction</em></p>
<pre class="r"><code># ===============================
# Imputation multiple avec méthodes adaptées
# ===============================

library(mice)</code></pre>
<pre><code>## Warning: package &#39;mice&#39; was built under R version 4.4.3</code></pre>
<pre><code>## 
## Attaching package: &#39;mice&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     filter</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     cbind, rbind</code></pre>
<pre class="r"><code>library(dplyr)

set.seed(123)

# ⚠️ Retirer identifiants avant imputation
df_imp &lt;- data_main_clean %&gt;%
  dplyr::select(-patref)   # enlève l&#39;identifiant

# Vérifier les types
str(df_imp)</code></pre>
<pre><code>## &#39;data.frame&#39;:    319 obs. of  38 variables:
##  $ wk12_dead          : Factor w/ 2 levels &quot;0&quot;,&quot;1&quot;: 2 1 1 1 1 1 1 2 1 1 ...
##  $ wk24_dead          : Factor w/ 2 levels &quot;0&quot;,&quot;1&quot;: 2 1 1 1 2 1 2 2 1 1 ...
##  $ fact_chg12         : num  NA NA -13 8 NA ...
##  $ fact_chg24         : num  NA NA NA 3.67 NA ...
##  $ hads_anx_chg12     : int  NA NA -1 0 NA NA 2 NA -1 5 ...
##  $ hads_dep_chg12     : int  NA NA -3 2 NA NA 1 NA 4 8 ...
##  $ n12                : int  6 1 0 3 2 0 4 3 2 0 ...
##  $ n12_grp            : Factor w/ 5 levels &quot;0 visits&quot;,&quot;1-2 visits&quot;,..: 4 2 1 3 2 1 3 3 2 1 ...
##  $ fact_bl            : num  90 97.3 81 90 73.2 ...
##  $ hads_pt_anx_bl     : int  7 0 8 5 5 16 8 6 13 1 ...
##  $ hads_pt_dep_bl     : int  0 0 11 1 7 13 4 10 9 1 ...
##  $ age                : num  56 71 86 64 54 55 69 75 40 61 ...
##  $ sex                : Factor w/ 2 levels &quot;f&quot;,&quot;m&quot;: 1 2 2 2 1 1 1 1 1 1 ...
##  $ ecogps             : int  0 1 1 0 1 1 2 1 1 1 ...
##  $ tumrtyp            : Factor w/ 3 levels &quot;Esophageal/GEJ/Gastric&quot;,..: 3 3 3 2 3 3 3 3 3 3 ...
##  $ cgpart             : Factor w/ 2 levels &quot;No&quot;,&quot;Yes&quot;: 1 1 2 2 2 2 2 2 1 2 ...
##  $ race1              : Factor w/ 7 levels &quot;American Indian or Alaska Native&quot;,..: 7 7 7 7 7 7 7 7 7 7 ...
##  $ ptethncty          : Factor w/ 4 levels &quot;Hispanic or Latino&quot;,..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ pthighedu          : Factor w/ 8 levels &quot;8th grade or less&quot;,..: 5 4 4 4 6 3 4 5 6 4 ...
##  $ ptmargstat         : Factor w/ 8 levels &quot;Divorced&quot;,&quot;Domestic partnership&quot;,..: 2 1 4 4 4 4 8 4 2 4 ...
##  $ ptrelgn            : Factor w/ 8 levels &quot;Catholic&quot;,&quot;Jewish&quot;,..: 1 6 2 1 7 5 6 7 6 1 ...
##  $ sitetype           : Factor w/ 2 levels &quot;Academic&quot;,&quot;Community&quot;: 2 NA NA 2 1 NA 1 2 NA NA ...
##  $ arm                : Factor w/ 2 levels &quot;1&quot;,&quot;2&quot;: 1 2 2 1 1 2 1 1 2 2 ...
##  $ bsl_assess_complete: int  1 1 1 1 1 1 1 1 1 1 ...
##  $ ptpqpt1_grp        : Factor w/ 3 levels &quot;I prefer not to hear a lot of details&quot;,..: NA NA 2 2 NA NA 2 NA 2 2 ...
##  $ ptpqpt7_grp        : Factor w/ 3 levels &quot;I now have about the right amount of information&quot;,..: NA NA 1 1 NA NA 1 NA 2 1 ...
##  $ ptpqpt9e_grp       : Factor w/ 2 levels &quot;Extremely Helpful&quot;,..: NA NA 2 1 NA NA 1 NA 1 2 ...
##  $ ptpqpt11_grp       : Factor w/ 2 levels &quot;No chance (0% chance)&quot;,..: NA NA 1 1 NA NA 1 NA 1 2 ...
##  $ ptpqpt12_grp       : Factor w/ 2 levels &quot;No&quot;,&quot;Yes&quot;: NA NA 1 2 NA NA 2 NA 1 1 ...
##  $ edu_cat            : chr  &quot;College+&quot; &quot;College+&quot; &quot;College+&quot; &quot;College+&quot; ...
##  $ marital_cat        : chr  &quot;Married/Partnered&quot; &quot;Not married&quot; &quot;Married/Partnered&quot; &quot;Married/Partnered&quot; ...
##  $ race_cat           : chr  &quot;White&quot; &quot;White&quot; &quot;White&quot; &quot;White&quot; ...
##  $ state_t0           : chr  &quot;A&quot; &quot;A&quot; &quot;A&quot; &quot;A&quot; ...
##  $ state_t12          : chr  &quot;D&quot; &quot;F&quot; &quot;A&quot; &quot;A&quot; ...
##  $ state_t24          : chr  &quot;D&quot; &quot;F&quot; &quot;F&quot; &quot;A&quot; ...
##  $ missing12          : num  0 1 0 0 1 1 0 0 1 0 ...
##  $ sitetype2          : Factor w/ 3 levels &quot;Academic&quot;,&quot;Community&quot;,..: 2 3 3 2 1 3 1 2 3 3 ...
##  $ missing24          : num  0 1 1 0 0 1 0 0 0 1 ...</code></pre>
<pre class="r"><code># Initialisation
ini &lt;- mice(df_imp, maxit = 0, printFlag = FALSE)</code></pre>
<pre><code>## Warning: Number of logged events: 8</code></pre>
<pre class="r"><code>meth &lt;- ini$method
pred &lt;- ini$predictorMatrix

# Boucle automatique selon type de variable
for (v in names(df_imp)) {
  if (is.numeric(df_imp[[v]]) &amp; length(unique(df_imp[[v]])) &gt; 2) {
    meth[v] &lt;- &quot;pmm&quot;       # numérique continu
  } else if (is.factor(df_imp[[v]]) &amp; nlevels(df_imp[[v]]) == 2) {
    meth[v] &lt;- &quot;logreg&quot;    # facteur binaire
  } else if (is.factor(df_imp[[v]]) &amp; nlevels(df_imp[[v]]) &gt; 2) {
    meth[v] &lt;- &quot;polyreg&quot;   # facteur multicatégoriel
  } else if (is.numeric(df_imp[[v]]) &amp; length(unique(df_imp[[v]])) == 2) {
    meth[v] &lt;- &quot;logreg&quot;    # binaire encodé en 0/1 mais stocké comme numeric
  }
}

# (Optionnel) Bloquer certaines colonnes comme prédicteurs si nécessaire
# pred[,&quot;sex&quot;] &lt;- 0

# Vérifier configuration
meth</code></pre>
<pre><code>##           wk12_dead           wk24_dead          fact_chg12          fact_chg24 
##            &quot;logreg&quot;            &quot;logreg&quot;               &quot;pmm&quot;               &quot;pmm&quot; 
##      hads_anx_chg12      hads_dep_chg12                 n12             n12_grp 
##               &quot;pmm&quot;               &quot;pmm&quot;               &quot;pmm&quot;           &quot;polyreg&quot; 
##             fact_bl      hads_pt_anx_bl      hads_pt_dep_bl                 age 
##               &quot;pmm&quot;               &quot;pmm&quot;               &quot;pmm&quot;               &quot;pmm&quot; 
##                 sex              ecogps             tumrtyp              cgpart 
##            &quot;logreg&quot;               &quot;pmm&quot;           &quot;polyreg&quot;            &quot;logreg&quot; 
##               race1           ptethncty           pthighedu          ptmargstat 
##           &quot;polyreg&quot;           &quot;polyreg&quot;           &quot;polyreg&quot;           &quot;polyreg&quot; 
##             ptrelgn            sitetype                 arm bsl_assess_complete 
##           &quot;polyreg&quot;            &quot;logreg&quot;            &quot;logreg&quot;                  &quot;&quot; 
##         ptpqpt1_grp         ptpqpt7_grp        ptpqpt9e_grp        ptpqpt11_grp 
##           &quot;polyreg&quot;           &quot;polyreg&quot;            &quot;logreg&quot;            &quot;logreg&quot; 
##        ptpqpt12_grp             edu_cat         marital_cat            race_cat 
##            &quot;logreg&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##            state_t0           state_t12           state_t24           missing12 
##                  &quot;&quot;                  &quot;&quot;                  &quot;&quot;            &quot;logreg&quot; 
##           sitetype2           missing24 
##           &quot;polyreg&quot;            &quot;logreg&quot;</code></pre>
<pre class="r"><code>head(pred)</code></pre>
<pre><code>##                wk12_dead wk24_dead fact_chg12 fact_chg24 hads_anx_chg12
## wk12_dead              0         1          1          1              1
## wk24_dead              1         0          1          1              1
## fact_chg12             1         1          0          1              1
## fact_chg24             1         1          1          0              1
## hads_anx_chg12         1         1          1          1              0
## hads_dep_chg12         1         1          1          1              1
##                hads_dep_chg12 n12 n12_grp fact_bl hads_pt_anx_bl hads_pt_dep_bl
## wk12_dead                   1   1       1       1              1              1
## wk24_dead                   1   1       1       1              1              1
## fact_chg12                  1   1       1       1              1              1
## fact_chg24                  1   1       1       1              1              1
## hads_anx_chg12              1   1       1       1              1              1
## hads_dep_chg12              0   1       1       1              1              1
##                age sex ecogps tumrtyp cgpart race1 ptethncty pthighedu
## wk12_dead        1   1      1       1      1     1         1         1
## wk24_dead        1   1      1       1      1     1         1         1
## fact_chg12       1   1      1       1      1     1         1         1
## fact_chg24       1   1      1       1      1     1         1         1
## hads_anx_chg12   1   1      1       1      1     1         1         1
## hads_dep_chg12   1   1      1       1      1     1         1         1
##                ptmargstat ptrelgn sitetype arm bsl_assess_complete ptpqpt1_grp
## wk12_dead               1       1        0   1                   0           1
## wk24_dead               1       1        0   1                   0           1
## fact_chg12              1       1        0   1                   0           1
## fact_chg24              1       1        0   1                   0           1
## hads_anx_chg12          1       1        0   1                   0           1
## hads_dep_chg12          1       1        0   1                   0           1
##                ptpqpt7_grp ptpqpt9e_grp ptpqpt11_grp ptpqpt12_grp edu_cat
## wk12_dead                1            1            1            1       0
## wk24_dead                1            1            1            1       0
## fact_chg12               1            1            1            1       0
## fact_chg24               1            1            1            1       0
## hads_anx_chg12           1            1            1            1       0
## hads_dep_chg12           1            1            1            1       0
##                marital_cat race_cat state_t0 state_t12 state_t24 missing12
## wk12_dead                0        0        0         0         0         1
## wk24_dead                0        0        0         0         0         1
## fact_chg12               0        0        0         0         0         1
## fact_chg24               0        0        0         0         0         1
## hads_anx_chg12           0        0        0         0         0         1
## hads_dep_chg12           0        0        0         0         0         1
##                sitetype2 missing24
## wk12_dead              1         1
## wk24_dead              1         1
## fact_chg12             1         1
## fact_chg24             1         1
## hads_anx_chg12         1         1
## hads_dep_chg12         1         1</code></pre>
<pre class="r"><code># Imputation multiple (⚡ m=15 imputations)
imp &lt;- mice(df_imp, m = 15, method = meth, predictorMatrix = pred,
            maxit = 10, seed = 123, printFlag = TRUE)</code></pre>
<pre><code>## Warning: Type mismatch for variable(s): missing12
## Imputation method logreg is for categorical data.</code></pre>
<pre><code>## Warning: Type mismatch for variable(s): missing24
## Imputation method logreg is for categorical data.</code></pre>
<pre><code>## 
##  iter imp variable
##   1   1  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   2  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   3  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   4  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   5  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   6  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   7  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   8  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   9  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   10  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   11  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   12  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   13  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   14  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   1   15  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   1  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   2  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   3  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   4  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   5  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   6  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   7  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   8  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   9  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   10  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   11  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   12  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   13  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   14  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   2   15  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   1  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   2  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   3  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   4  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   5  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   6  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   7  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   8  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   9  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   10  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   11  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   12  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   13  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   14  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   3   15  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   1  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   2  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   3  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   4  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   5  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   6  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   7  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   8  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   9  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   10  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   11  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   12  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   13  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   14  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   4   15  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   1  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   2  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   3  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   4  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   5  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   6  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   7  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   8  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   9  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   10  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   11  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   12  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   13  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   14  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   5   15  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   1  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   2  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   3  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   4  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   5  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   6  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   7  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   8  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   9  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   10  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   11  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   12  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   13  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   14  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   6   15  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   1  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   2  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   3  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   4  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   5  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   6  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   7  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   8  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   9  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   10  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   11  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   12  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   13  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   14  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   7   15  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   1  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   2  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   3  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   4  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   5  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   6  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   7  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   8  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   9  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   10  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   11  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   12  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   13  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   14  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   8   15  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   1  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   2  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   3  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   4  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   5  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   6  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   7  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   8  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   9  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   10  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   11  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   12  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   13  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   14  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   9   15  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   1  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   2  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   3  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   4  fact_chg12*  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   5  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   6  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   7  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   8  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   9  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   10  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   11  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   12  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   13  fact_chg12*  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   14  fact_chg12  fact_chg24*  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp
##   10   15  fact_chg12  fact_chg24  hads_anx_chg12  hads_dep_chg12  ptethncty  ptrelgn  sitetype  ptpqpt1_grp  ptpqpt7_grp  ptpqpt9e_grp  ptpqpt11_grp  ptpqpt12_grp</code></pre>
<pre><code>## Warning: Number of logged events: 1784</code></pre>
<pre class="r"><code># Inspecter
imp</code></pre>
<pre><code>## Class: mids
## Number of multiple imputations:  15 
## Imputation methods:
##           wk12_dead           wk24_dead          fact_chg12          fact_chg24 
##                  &quot;&quot;                  &quot;&quot;               &quot;pmm&quot;               &quot;pmm&quot; 
##      hads_anx_chg12      hads_dep_chg12                 n12             n12_grp 
##               &quot;pmm&quot;               &quot;pmm&quot;                  &quot;&quot;                  &quot;&quot; 
##             fact_bl      hads_pt_anx_bl      hads_pt_dep_bl                 age 
##                  &quot;&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##                 sex              ecogps             tumrtyp              cgpart 
##                  &quot;&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##               race1           ptethncty           pthighedu          ptmargstat 
##                  &quot;&quot;           &quot;polyreg&quot;                  &quot;&quot;                  &quot;&quot; 
##             ptrelgn            sitetype                 arm bsl_assess_complete 
##           &quot;polyreg&quot;            &quot;logreg&quot;                  &quot;&quot;                  &quot;&quot; 
##         ptpqpt1_grp         ptpqpt7_grp        ptpqpt9e_grp        ptpqpt11_grp 
##           &quot;polyreg&quot;           &quot;polyreg&quot;            &quot;logreg&quot;            &quot;logreg&quot; 
##        ptpqpt12_grp             edu_cat         marital_cat            race_cat 
##            &quot;logreg&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##            state_t0           state_t12           state_t24           missing12 
##                  &quot;&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##           sitetype2           missing24 
##                  &quot;&quot;                  &quot;&quot; 
## PredictorMatrix:
##                wk12_dead wk24_dead fact_chg12 fact_chg24 hads_anx_chg12
## wk12_dead              0         1          1          1              1
## wk24_dead              1         0          1          1              1
## fact_chg12             1         1          0          1              1
## fact_chg24             1         1          1          0              1
## hads_anx_chg12         1         1          1          1              0
## hads_dep_chg12         1         1          1          1              1
##                hads_dep_chg12 n12 n12_grp fact_bl hads_pt_anx_bl hads_pt_dep_bl
## wk12_dead                   1   1       1       1              1              1
## wk24_dead                   1   1       1       1              1              1
## fact_chg12                  1   1       1       1              1              1
## fact_chg24                  1   1       1       1              1              1
## hads_anx_chg12              1   1       1       1              1              1
## hads_dep_chg12              0   1       1       1              1              1
##                age sex ecogps tumrtyp cgpart race1 ptethncty pthighedu
## wk12_dead        1   1      1       1      1     1         1         1
## wk24_dead        1   1      1       1      1     1         1         1
## fact_chg12       1   1      1       1      1     1         1         1
## fact_chg24       1   1      1       1      1     1         1         1
## hads_anx_chg12   1   1      1       1      1     1         1         1
## hads_dep_chg12   1   1      1       1      1     1         1         1
##                ptmargstat ptrelgn sitetype arm bsl_assess_complete ptpqpt1_grp
## wk12_dead               1       1        0   1                   0           1
## wk24_dead               1       1        0   1                   0           1
## fact_chg12              1       1        0   1                   0           1
## fact_chg24              1       1        0   1                   0           1
## hads_anx_chg12          1       1        0   1                   0           1
## hads_dep_chg12          1       1        0   1                   0           1
##                ptpqpt7_grp ptpqpt9e_grp ptpqpt11_grp ptpqpt12_grp edu_cat
## wk12_dead                1            1            1            1       0
## wk24_dead                1            1            1            1       0
## fact_chg12               1            1            1            1       0
## fact_chg24               1            1            1            1       0
## hads_anx_chg12           1            1            1            1       0
## hads_dep_chg12           1            1            1            1       0
##                marital_cat race_cat state_t0 state_t12 state_t24 missing12
## wk12_dead                0        0        0         0         0         1
## wk24_dead                0        0        0         0         0         1
## fact_chg12               0        0        0         0         0         1
## fact_chg24               0        0        0         0         0         1
## hads_anx_chg12           0        0        0         0         0         1
## hads_dep_chg12           0        0        0         0         0         1
##                sitetype2 missing24
## wk12_dead              1         1
## wk24_dead              1         1
## fact_chg12             1         1
## fact_chg24             1         1
## hads_anx_chg12         1         1
## hads_dep_chg12         1         1
## Number of logged events:  1784 
##   it im            dep meth
## 1  1  1     fact_chg12  pmm
## 2  1  1     fact_chg12  pmm
## 3  1  1     fact_chg24  pmm
## 4  1  1     fact_chg24  pmm
## 5  1  1 hads_anx_chg12  pmm
## 6  1  1 hads_dep_chg12  pmm
##                                                                                                                                                                                                                                                                                                                                                                   out
## 1                                                                                                                               race1Not reported: patient refused or not available, race1Unknown: Patient unsure, race1White, pthigheduI prefer not to answer, ptmargstatI prefer not to answer, ptmargstatUnknown/Not reported, ptrelgnMuslim, missing12, missing24
## 2                                                                                                            mice detected that your data are (nearly) multi-collinear.\nIt applied a ridge penalty to continue calculations, but the results can be unstable.\nDoes your dataset contain duplicates, linear transformation, or factors with unique respondent names?
## 3 wk12_dead1, wk24_dead1, race1Not reported: patient refused or not available, race1Unknown: Patient unsure, race1White, pthigheduI prefer not to answer, ptmargstatI prefer not to answer, ptmargstatUnknown/Not reported, ptrelgnMuslim, ptpqpt1_grpI want to hear as many details as possible in all situations relating to my cancer and its treatment, missing24
## 4                                                                                                            mice detected that your data are (nearly) multi-collinear.\nIt applied a ridge penalty to continue calculations, but the results can be unstable.\nDoes your dataset contain duplicates, linear transformation, or factors with unique respondent names?
## 5                                                                                                                                                           race1Not reported: patient refused or not available, race1Unknown: Patient unsure, pthigheduI prefer not to answer, ptmargstatI prefer not to answer, ptmargstatUnknown/Not reported, ptrelgnMuslim, arm2
## 6                                                                                                                                                           race1Not reported: patient refused or not available, race1Unknown: Patient unsure, pthigheduI prefer not to answer, ptmargstatI prefer not to answer, ptmargstatUnknown/Not reported, ptrelgnMuslim, arm2</code></pre>
<pre class="r"><code>summary(imp)</code></pre>
<pre><code>## Class: mids
## Number of multiple imputations:  15 
## Imputation methods:
##           wk12_dead           wk24_dead          fact_chg12          fact_chg24 
##                  &quot;&quot;                  &quot;&quot;               &quot;pmm&quot;               &quot;pmm&quot; 
##      hads_anx_chg12      hads_dep_chg12                 n12             n12_grp 
##               &quot;pmm&quot;               &quot;pmm&quot;                  &quot;&quot;                  &quot;&quot; 
##             fact_bl      hads_pt_anx_bl      hads_pt_dep_bl                 age 
##                  &quot;&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##                 sex              ecogps             tumrtyp              cgpart 
##                  &quot;&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##               race1           ptethncty           pthighedu          ptmargstat 
##                  &quot;&quot;           &quot;polyreg&quot;                  &quot;&quot;                  &quot;&quot; 
##             ptrelgn            sitetype                 arm bsl_assess_complete 
##           &quot;polyreg&quot;            &quot;logreg&quot;                  &quot;&quot;                  &quot;&quot; 
##         ptpqpt1_grp         ptpqpt7_grp        ptpqpt9e_grp        ptpqpt11_grp 
##           &quot;polyreg&quot;           &quot;polyreg&quot;            &quot;logreg&quot;            &quot;logreg&quot; 
##        ptpqpt12_grp             edu_cat         marital_cat            race_cat 
##            &quot;logreg&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##            state_t0           state_t12           state_t24           missing12 
##                  &quot;&quot;                  &quot;&quot;                  &quot;&quot;                  &quot;&quot; 
##           sitetype2           missing24 
##                  &quot;&quot;                  &quot;&quot; 
## PredictorMatrix:
##                wk12_dead wk24_dead fact_chg12 fact_chg24 hads_anx_chg12
## wk12_dead              0         1          1          1              1
## wk24_dead              1         0          1          1              1
## fact_chg12             1         1          0          1              1
## fact_chg24             1         1          1          0              1
## hads_anx_chg12         1         1          1          1              0
## hads_dep_chg12         1         1          1          1              1
##                hads_dep_chg12 n12 n12_grp fact_bl hads_pt_anx_bl hads_pt_dep_bl
## wk12_dead                   1   1       1       1              1              1
## wk24_dead                   1   1       1       1              1              1
## fact_chg12                  1   1       1       1              1              1
## fact_chg24                  1   1       1       1              1              1
## hads_anx_chg12              1   1       1       1              1              1
## hads_dep_chg12              0   1       1       1              1              1
##                age sex ecogps tumrtyp cgpart race1 ptethncty pthighedu
## wk12_dead        1   1      1       1      1     1         1         1
## wk24_dead        1   1      1       1      1     1         1         1
## fact_chg12       1   1      1       1      1     1         1         1
## fact_chg24       1   1      1       1      1     1         1         1
## hads_anx_chg12   1   1      1       1      1     1         1         1
## hads_dep_chg12   1   1      1       1      1     1         1         1
##                ptmargstat ptrelgn sitetype arm bsl_assess_complete ptpqpt1_grp
## wk12_dead               1       1        0   1                   0           1
## wk24_dead               1       1        0   1                   0           1
## fact_chg12              1       1        0   1                   0           1
## fact_chg24              1       1        0   1                   0           1
## hads_anx_chg12          1       1        0   1                   0           1
## hads_dep_chg12          1       1        0   1                   0           1
##                ptpqpt7_grp ptpqpt9e_grp ptpqpt11_grp ptpqpt12_grp edu_cat
## wk12_dead                1            1            1            1       0
## wk24_dead                1            1            1            1       0
## fact_chg12               1            1            1            1       0
## fact_chg24               1            1            1            1       0
## hads_anx_chg12           1            1            1            1       0
## hads_dep_chg12           1            1            1            1       0
##                marital_cat race_cat state_t0 state_t12 state_t24 missing12
## wk12_dead                0        0        0         0         0         1
## wk24_dead                0        0        0         0         0         1
## fact_chg12               0        0        0         0         0         1
## fact_chg24               0        0        0         0         0         1
## hads_anx_chg12           0        0        0         0         0         1
## hads_dep_chg12           0        0        0         0         0         1
##                sitetype2 missing24
## wk12_dead              1         1
## wk24_dead              1         1
## fact_chg12             1         1
## fact_chg24             1         1
## hads_anx_chg12         1         1
## hads_dep_chg12         1         1
## Number of logged events:  1784 
##   it im            dep meth
## 1  1  1     fact_chg12  pmm
## 2  1  1     fact_chg12  pmm
## 3  1  1     fact_chg24  pmm
## 4  1  1     fact_chg24  pmm
## 5  1  1 hads_anx_chg12  pmm
## 6  1  1 hads_dep_chg12  pmm
##                                                                                                                                                                                                                                                                                                                                                                   out
## 1                                                                                                                               race1Not reported: patient refused or not available, race1Unknown: Patient unsure, race1White, pthigheduI prefer not to answer, ptmargstatI prefer not to answer, ptmargstatUnknown/Not reported, ptrelgnMuslim, missing12, missing24
## 2                                                                                                            mice detected that your data are (nearly) multi-collinear.\nIt applied a ridge penalty to continue calculations, but the results can be unstable.\nDoes your dataset contain duplicates, linear transformation, or factors with unique respondent names?
## 3 wk12_dead1, wk24_dead1, race1Not reported: patient refused or not available, race1Unknown: Patient unsure, race1White, pthigheduI prefer not to answer, ptmargstatI prefer not to answer, ptmargstatUnknown/Not reported, ptrelgnMuslim, ptpqpt1_grpI want to hear as many details as possible in all situations relating to my cancer and its treatment, missing24
## 4                                                                                                            mice detected that your data are (nearly) multi-collinear.\nIt applied a ridge penalty to continue calculations, but the results can be unstable.\nDoes your dataset contain duplicates, linear transformation, or factors with unique respondent names?
## 5                                                                                                                                                           race1Not reported: patient refused or not available, race1Unknown: Patient unsure, pthigheduI prefer not to answer, ptmargstatI prefer not to answer, ptmargstatUnknown/Not reported, ptrelgnMuslim, arm2
## 6                                                                                                                                                           race1Not reported: patient refused or not available, race1Unknown: Patient unsure, pthigheduI prefer not to answer, ptmargstatI prefer not to answer, ptmargstatUnknown/Not reported, ptrelgnMuslim, arm2</code></pre>
<pre class="r"><code>saveRDS(imp, &quot;imp_check2.rds&quot;)</code></pre>
<pre class="r"><code>all.equal(readRDS(&quot;imp_check.rds&quot;), readRDS(&quot;imp_check2.rds&quot;))</code></pre>
<pre><code>## [1] &quot;Component \&quot;date\&quot;: Mean relative difference: 4.907012e-05&quot;</code></pre>
<pre class="r"><code># ===============================
# Post-imputation: Nested CV across imputations (parallel over imputations)
# ===============================

library(caret)
library(glmnet)
library(ranger)
library(xgboost)
library(pROC)
library(doParallel)
library(foreach)
library(dplyr)
library(tidyr)
library(ggplot2)

set.seed(123)

# -------------------------------
# Params (adaptable)
m_imp &lt;- if (exists(&quot;imp&quot;)) imp$m else 15   # si imp existe, utilise imp$m sinon 15
outer_k &lt;- 5
inner_k &lt;- 3
thresholds &lt;- c(0, -5, -7, -10)
ncores &lt;- max(1, parallel::detectCores() - 1)
outdir &lt;- &quot;results_prediction_MICE&quot;
dir.create(outdir, showWarnings = FALSE)

# -------------------------------
# Build list of imputed datasets if not already
if (!exists(&quot;imputed_list&quot;)) {
  if (!exists(&quot;imp&quot;)) stop(&quot;Object &#39;imp&#39; not found. Run mice() first or provide imputed_list.&quot;)
  imputed_list &lt;- lapply(1:imp$m, function(i) complete(imp, action = i))
}

# -------------------------------
# quick checks / predictors
# adapt predictors if necessary (they must exist in imputed datasets)
predictors &lt;- c(&quot;age&quot;, &quot;sex&quot;, &quot;ecogps&quot;, &quot;fact_bl&quot;, &quot;tumrtyp&quot;, &quot;arm&quot;, &quot;cgpart&quot;, &quot;hads_pt_anx_bl&quot;,&quot;hads_pt_dep_bl&quot;, &quot;edu_cat&quot;)
# ensure predictors exist in dataset
missing_preds &lt;- setdiff(predictors, names(imputed_list[[1]]))
if (length(missing_preds) &gt; 0) stop(&quot;Missing predictors in data: &quot;, paste(missing_preds, collapse = &quot;, &quot;))

# -------------------------------
# safe_train wrapper (no stop on error). NOTE: disable caret parallel inside to avoid nested parallel.
safe_train &lt;- function(formula, data, method, trControl, tuneGrid=NULL, preProc=NULL, weights=NULL, ...) {
  out &lt;- tryCatch({
    train(formula,
          data = data,
          method = method,
          metric = &quot;ROC&quot;,
          trControl = trControl,
          tuneGrid = tuneGrid,
          preProcess = preProc,
          ...)
  }, error = function(e) {
    message(&quot;train ERROR (&quot;, method, &quot;): &quot;, e$message)
    return(NULL)
  }, warning = function(w) {
    message(&quot;train WARNING (&quot;, method, &quot;): &quot;, w$message)
    invokeRestart(&quot;muffleWarning&quot;)
  })
  return(out)
}

# -------------------------------
# Fonction pour extraire l’importance des variables de façon robuste
get_varimp &lt;- function(fit, model_name) {
  vim &lt;- tryCatch(varImp(fit), error = function(e) NULL)
  if (is.null(vim)) return(NULL)
  
  df &lt;- NULL
  if (&quot;importance&quot; %in% names(vim)) {
    # cas glmnet (renvoie importance dans $importance)
    df &lt;- vim$importance %&gt;%
      tibble::rownames_to_column(&quot;Variable&quot;) %&gt;%
      rename(Importance = Overall)
  } else if (&quot;Overall&quot; %in% names(vim)) {
    # cas ranger, xgbTree (renvoie directement une colonne Overall)
    df &lt;- vim %&gt;%
      tibble::rownames_to_column(&quot;Variable&quot;) %&gt;%
      rename(Importance = Overall)
  }
  df
}

# -------------------------------
# nested eval function (corrigée)
nested_cv_eval &lt;- function(df, outcome_var = &quot;fact_chg24_bin&quot;, predictors,
                           outer_k = 5, inner_k = 3, seed = 123) {
  set.seed(seed)
  n_events &lt;- sum(df[[outcome_var]] == &quot;yes&quot;, na.rm = TRUE)
  outer_k_use &lt;- ifelse(n_events &lt; 30, 3, outer_k)
  
  # ensure outcome is factor with levels no/yes
  df[[outcome_var]] &lt;- factor(df[[outcome_var]], levels = c(&quot;no&quot;,&quot;yes&quot;))
  outer_folds &lt;- createFolds(df[[outcome_var]], k = outer_k_use, returnTrain = FALSE)
  
  res_list &lt;- list(); fid &lt;- 0
  
  for (i in seq_along(outer_folds)) {
    test_idx &lt;- outer_folds[[i]]
    train_df &lt;- df[-test_idx, , drop = FALSE]
    test_df  &lt;- df[test_idx, , drop = FALSE]
    fid &lt;- fid + 1
    
    # skip if class absent in train/test
    if (length(unique(train_df[[outcome_var]])) &lt; 2 || length(unique(test_df[[outcome_var]])) &lt; 2) {
      message(&quot;Skipping outer fold &quot;, i, &quot; (class absent in train or test)&quot;)
      next
    }
    
    # inner ctrl
    ctrl &lt;- trainControl(method = &quot;cv&quot;, number = inner_k,
                         classProbs = TRUE, summaryFunction = twoClassSummary,
                         savePredictions = &quot;final&quot;, allowParallel = FALSE)
    
    fmla &lt;- as.formula(paste(outcome_var, &quot;~&quot;, paste(predictors, collapse = &quot;+&quot;)))
    
    # LASSO
    grid_glmnet &lt;- expand.grid(alpha = 1, lambda = 10^seq(-3, 0, length = 10))
    fit_glmnet &lt;- safe_train(fmla, train_df, method = &quot;glmnet&quot;, trControl = ctrl,
                             tuneGrid = grid_glmnet, preProc = c(&quot;center&quot;,&quot;scale&quot;))
    
    # RF
    grid_rf &lt;- expand.grid(mtry = max(1, floor(length(predictors)/3)), splitrule=&quot;gini&quot;, min.node.size=5)
    fit_rf &lt;- safe_train(fmla, train_df, method = &quot;ranger&quot;, trControl = ctrl, tuneGrid = grid_rf, importance = &quot;impurity&quot;
)
    
    # XGB
    grid_xgb &lt;- expand.grid(nrounds = 100, max_depth = 3, eta = 0.05, gamma = 0,
                            colsample_bytree = 0.8, min_child_weight = 1, subsample = 0.8)
    fit_xgb &lt;- safe_train(fmla, train_df, method = &quot;xgbTree&quot;, trControl = ctrl, tuneGrid = grid_xgb)
    
    models &lt;- list(glmnet = fit_glmnet, rf = fit_rf, xgb = fit_xgb)
    
    for (mname in names(models)) {
      fit &lt;- models[[mname]]
      
      if (is.null(fit)) {
        res_list[[length(res_list)+1]] &lt;- data.frame(Fold=fid, Model=mname, AUC=NA_real_, Brier=NA_real_, Slope=NA_real_)
        next
      }
      
      # prédictions
      pred_prob &lt;- tryCatch(predict(fit, newdata = test_df, type = &quot;prob&quot;)[, &quot;yes&quot;],
                            error = function(e) { message(&quot;predict error: &quot;, e$message); return(rep(NA_real_, nrow(test_df))) })
      ytest &lt;- ifelse(test_df[[outcome_var]] == &quot;yes&quot;, 1, 0)
      
      # AUC
      if (length(unique(ytest)) &lt; 2 || all(is.na(pred_prob))) {
        aucval &lt;- NA_real_
      } else {
        rocobj &lt;- tryCatch(roc(test_df[[outcome_var]], pred_prob, quiet = TRUE),
                           error = function(e) { message(&quot;roc error: &quot;, e$message); return(NULL) })
        aucval &lt;- if (is.null(rocobj)) NA_real_ else as.numeric(auc(rocobj))
      }
      
      # Brier
      brier &lt;- tryCatch(mean((pred_prob - ytest)^2, na.rm = TRUE), error = function(e) NA_real_)
      
      # slope
      eps &lt;- 1e-6
      pred_clip &lt;- pmin(pmax(pred_prob, eps), 1-eps)
      logit_pred &lt;- qlogis(pred_clip)
      slope &lt;- tryCatch({
        cm &lt;- suppressWarnings(glm(ytest ~ logit_pred, family = binomial))
        as.numeric(coef(cm)[2])
      }, error = function(e) NA_real_)
      
      res_list[[length(res_list)+1]] &lt;- data.frame(Fold=fid, Model=mname, AUC=aucval, Brier=brier, Slope=slope)
      
      # importance variables
      varimp_df &lt;- get_varimp(fit, mname)
      if (!is.null(varimp_df)) {
        varimp_df$Fold &lt;- fid
        varimp_df$Model &lt;- mname
        varimp_df$Threshold &lt;- thr
        varimp_df$Imputation &lt;- imp_i
        saveRDS(varimp_df, file = file.path(
          outdir, paste0(&quot;varimp_thr&quot;,thr,&quot;_&quot;,mname,&quot;_imp&quot;,imp_i,&quot;_fold&quot;,fid,&quot;.rds&quot;)
        ))
      }
    }
  }
  
  if (length(res_list) == 0) return(NULL)
  bind_rows(res_list)
}


# -------------------------------
# Parallel over imputations using foreach %dopar%
cl &lt;- makeCluster(ncores)
registerDoParallel(cl)
cat(&quot;Running over&quot;, ncores, &quot;cores (one imputation per worker)\n&quot;)</code></pre>
<pre><code>## Running over 3 cores (one imputation per worker)</code></pre>
<pre class="r"><code>all_runs &lt;- foreach(imp_i = seq_along(imputed_list), 
                    .packages = c(&quot;dplyr&quot;,&quot;caret&quot;,&quot;glmnet&quot;,&quot;ranger&quot;,&quot;xgboost&quot;,&quot;pROC&quot;), 
                    .combine = &quot;bind_rows&quot;) %dopar% {
  dat_imp &lt;- imputed_list[[imp_i]]
  res_imp_allthr &lt;- list()
  
  for (thr in thresholds) {
    dat_work &lt;- dat_imp %&gt;%
      mutate(fact_chg24_bin = ifelse(fact_chg24 &lt;= thr, 1, 0),
             fact_chg24_bin = factor(fact_chg24_bin, levels = c(0,1), labels = c(&quot;no&quot;,&quot;yes&quot;))) %&gt;%
      filter(!is.na(fact_chg24_bin))
    
    # 🔎 DEBUG : afficher la distribution outcome par imputation et seuil
    message(&quot;Imputation &quot;, imp_i, &quot; | Threshold &quot;, thr, &quot; | Distribution:&quot;)
    message(capture.output(print(table(dat_work$fact_chg24_bin))))
    
    if (nrow(dat_work) &lt; 30) {
      message(&quot;⚠️ Imputation &quot;, imp_i, &quot; threshold &quot;, thr, &quot;: n &lt; 30, skipping&quot;)
      next
    }
    
    res_df &lt;- nested_cv_eval(dat_work, outcome_var = &quot;fact_chg24_bin&quot;, predictors = predictors,
                             outer_k = outer_k, inner_k = inner_k, seed = 1000 + imp_i)
    
    if (!is.null(res_df)) {
      res_df$Imputation &lt;- imp_i
      res_df$Threshold &lt;- thr
      res_imp_allthr[[length(res_imp_allthr)+1]] &lt;- res_df
    }
  }
  
  if (length(res_imp_allthr) == 0) NULL else bind_rows(res_imp_allthr)
                    }


# stop cluster
stopCluster(cl); registerDoSEQ()

# -------------------------------
# Save raw results
if (is.null(all_runs) || nrow(all_runs) == 0) {
  stop(&quot;No results returned: possibly all datasets were too small or all folds skipped.&quot;)
}
write.csv(all_runs, file = file.path(outdir, &quot;nested_results_all_imputations.csv&quot;), row.names = FALSE)

# -------------------------------
# Summary median + IQR per Threshold x Model
summary_df &lt;- all_runs %&gt;%
  group_by(Threshold, Model) %&gt;%
  summarise(
    AUC_median = median(AUC, na.rm = TRUE),
    AUC_IQR = IQR(AUC, na.rm = TRUE),
    Brier_median = median(Brier, na.rm = TRUE),
    Brier_IQR = IQR(Brier, na.rm = TRUE),
    Slope_median = median(Slope, na.rm = TRUE),
    Slope_IQR = IQR(Slope, na.rm = TRUE),
    n_folds = sum(!is.na(AUC)),
    .groups = &quot;drop&quot;
  )

write.csv(summary_df, file = file.path(outdir, &quot;summary_median_IQR.csv&quot;), row.names = FALSE)
print(summary_df)</code></pre>
<pre><code>## # A tibble: 12 × 9
##    Threshold Model  AUC_median AUC_IQR Brier_median Brier_IQR Slope_median
##        &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
##  1       -10 glmnet      0.664  0.158         0.145    0.0444        1.01 
##  2       -10 rf          0.644  0.169         0.150    0.0555        0.656
##  3       -10 xgb         0.663  0.155         0.146    0.0552        0.658
##  4        -7 glmnet      0.629  0.195         0.161    0.0376        0.840
##  5        -7 rf          0.608  0.170         0.169    0.0468        0.497
##  6        -7 xgb         0.625  0.176         0.172    0.0487        0.456
##  7        -5 glmnet      0.671  0.136         0.177    0.0322        0.858
##  8        -5 rf          0.622  0.169         0.184    0.0366        0.666
##  9        -5 xgb         0.661  0.165         0.184    0.0419        0.571
## 10         0 glmnet      0.670  0.0823        0.221    0.0235        0.882
## 11         0 rf          0.645  0.0972        0.227    0.0273        0.728
## 12         0 xgb         0.652  0.0894        0.228    0.0285        0.619
## # ℹ 2 more variables: Slope_IQR &lt;dbl&gt;, n_folds &lt;int&gt;</code></pre>
<pre class="r"><code># -------------------------------
# Plots (boxplots)
p_auc &lt;- ggplot(all_runs, aes(x = Model, y = AUC, fill = Model)) +
  geom_boxplot() + facet_wrap(~Threshold) +
  theme_minimal(base_size = 13) + ggtitle(&quot;AUC distribution by Model and Threshold&quot;)
ggsave(filename = file.path(outdir, &quot;AUC_boxplots.png&quot;), plot = p_auc, width = 10, height = 6)

p_brier &lt;- ggplot(all_runs, aes(x = Model, y = Brier, fill = Model)) +
  geom_boxplot() + facet_wrap(~Threshold) +
  theme_minimal(base_size = 13) + ggtitle(&quot;Brier distribution by Model and Threshold&quot;)
ggsave(filename = file.path(outdir, &quot;Brier_boxplots.png&quot;), plot = p_brier, width = 10, height = 6)

p_slope &lt;- ggplot(all_runs, aes(x = Model, y = Slope, fill = Model)) +
  geom_boxplot() + facet_wrap(~Threshold) +
  theme_minimal(base_size = 13) + ggtitle(&quot;Calibration slope distribution by Model and Threshold&quot;)
ggsave(filename = file.path(outdir, &quot;Slope_boxplots.png&quot;), plot = p_slope, width = 10, height = 6)</code></pre>
<pre><code>## Warning: Removed 2 rows containing non-finite outside the scale range
## (`stat_boxplot()`).</code></pre>
<pre class="r"><code>cat(&quot;DONE — results and plots saved in:&quot;, outdir, &quot;\n&quot;)</code></pre>
<pre><code>## DONE — results and plots saved in: results_prediction_MICE</code></pre>
<pre class="r"><code># Heatmap of medians
res_long_2 &lt;- summary_df %&gt;%
  pivot_longer(cols = c(AUC_median, Brier_median, Slope_median), names_to = &quot;Metric&quot;, values_to = &quot;Value&quot;)

ggplot(res_long_2, aes(x=factor(Threshold), y=Model, fill=Value)) +
  geom_tile(color=&quot;white&quot;) +
  facet_wrap(~Metric, scales=&quot;free&quot;) +
  geom_text(aes(label = round(Value,2))) +
  labs(title=&quot;Median performance by Threshold and Model&quot;, x=&quot;Threshold&quot;, y=&quot;Model&quot;) +
  theme_minimal(base_size=12)</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<pre class="r"><code>ggsave(file.path(outdir,&quot;Median_heatmap_2.png&quot;), width=10, height=6)</code></pre>
<pre class="r"><code>files &lt;- list.files(outdir, pattern=&quot;varimp_.*rds&quot;, full.names=TRUE)
varimp_all &lt;- bind_rows(lapply(files, readRDS))

summary_varimp_mice &lt;- varimp_all %&gt;%
  group_by(Threshold, Model, Variable) %&gt;%
  summarise(MedianImportance = median(Importance, na.rm=TRUE),
            IQRImportance = IQR(Importance, na.rm=TRUE),
            .groups=&quot;drop&quot;)</code></pre>
<pre class="r"><code>library(knitr)
library(kableExtra)

summary_varimp_mice %&gt;%
  arrange(Model, Threshold, desc(MedianImportance)) %&gt;%
  kbl(caption = &quot;Variable importance across models and thresholds&quot;,
      digits = 3, 
      col.names = c(&quot;Threshold&quot;, &quot;Model&quot;, &quot;Variable&quot;, &quot;Median Importance&quot;, &quot;IQR Importance&quot;)) %&gt;%
  collapse_rows(columns = c(1, 2), valign = &quot;top&quot;) %&gt;%  # groupe Threshold et Model
  kable_styling(full_width = TRUE, 
                bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;, &quot;responsive&quot;))</code></pre>
<table class="table table-striped table-hover table-condensed table-responsive" style="margin-left: auto; margin-right: auto;">
<caption>
Variable importance across models and thresholds
</caption>
<thead>
<tr>
<th style="text-align:right;">
Threshold
</th>
<th style="text-align:left;">
Model
</th>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:right;">
Median Importance
</th>
<th style="text-align:right;">
IQR Importance
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-10
</td>
<td style="text-align:left;vertical-align: top !important;" rowspan="48">
glmnet
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
100.000
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
31.970
</td>
<td style="text-align:right;">
100.000
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
17.548
</td>
<td style="text-align:right;">
54.585
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
3.528
</td>
<td style="text-align:right;">
15.613
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
2.390
</td>
<td style="text-align:right;">
20.621
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
10.141
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
3.510
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
6.933
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
9.181
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
20.529
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
8.385
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
16.982
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-7
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
83.980
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
38.142
</td>
<td style="text-align:right;">
62.607
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
37.330
</td>
<td style="text-align:right;">
95.542
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
11.419
</td>
<td style="text-align:right;">
21.103
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
10.730
</td>
<td style="text-align:right;">
35.606
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
9.991
</td>
<td style="text-align:right;">
29.009
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
8.958
</td>
<td style="text-align:right;">
23.831
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
4.348
</td>
<td style="text-align:right;">
31.374
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
3.966
</td>
<td style="text-align:right;">
22.597
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
2.066
</td>
<td style="text-align:right;">
17.553
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
1.961
</td>
<td style="text-align:right;">
11.894
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
7.182
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-5
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
87.973
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
58.621
</td>
<td style="text-align:right;">
67.294
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
31.084
</td>
<td style="text-align:right;">
89.281
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
19.733
</td>
<td style="text-align:right;">
33.300
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
16.605
</td>
<td style="text-align:right;">
30.205
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
9.201
</td>
<td style="text-align:right;">
21.917
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
7.084
</td>
<td style="text-align:right;">
25.350
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
5.795
</td>
<td style="text-align:right;">
17.612
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
5.339
</td>
<td style="text-align:right;">
13.788
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
5.254
</td>
<td style="text-align:right;">
28.645
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
2.127
</td>
<td style="text-align:right;">
11.934
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
0.947
</td>
<td style="text-align:right;">
26.507
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
0
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
97.963
</td>
<td style="text-align:right;">
46.488
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
57.642
</td>
<td style="text-align:right;">
47.627
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
46.071
</td>
<td style="text-align:right;">
91.326
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
13.667
</td>
<td style="text-align:right;">
24.836
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
13.662
</td>
<td style="text-align:right;">
39.017
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
12.196
</td>
<td style="text-align:right;">
37.361
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
7.457
</td>
<td style="text-align:right;">
34.281
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
5.665
</td>
<td style="text-align:right;">
30.767
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
5.236
</td>
<td style="text-align:right;">
18.661
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
4.801
</td>
<td style="text-align:right;">
15.143
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
1.335
</td>
<td style="text-align:right;">
10.513
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
1.056
</td>
<td style="text-align:right;">
14.604
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-10
</td>
<td style="text-align:left;vertical-align: top !important;" rowspan="48">
rf
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
73.645
</td>
<td style="text-align:right;">
15.329
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
65.222
</td>
<td style="text-align:right;">
14.916
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
52.063
</td>
<td style="text-align:right;">
13.118
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
13.423
</td>
<td style="text-align:right;">
4.807
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
11.220
</td>
<td style="text-align:right;">
15.999
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
8.263
</td>
<td style="text-align:right;">
3.959
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
7.983
</td>
<td style="text-align:right;">
3.018
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
6.867
</td>
<td style="text-align:right;">
3.606
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
6.711
</td>
<td style="text-align:right;">
5.149
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
4.904
</td>
<td style="text-align:right;">
4.334
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-7
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
76.106
</td>
<td style="text-align:right;">
15.261
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
65.123
</td>
<td style="text-align:right;">
15.456
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
55.183
</td>
<td style="text-align:right;">
9.756
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
15.054
</td>
<td style="text-align:right;">
5.268
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
11.127
</td>
<td style="text-align:right;">
11.274
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
8.752
</td>
<td style="text-align:right;">
3.711
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
8.409
</td>
<td style="text-align:right;">
3.771
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
6.968
</td>
<td style="text-align:right;">
4.034
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
6.886
</td>
<td style="text-align:right;">
3.161
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
5.350
</td>
<td style="text-align:right;">
4.646
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-5
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
78.456
</td>
<td style="text-align:right;">
13.696
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
67.794
</td>
<td style="text-align:right;">
14.560
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
55.740
</td>
<td style="text-align:right;">
10.190
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
15.578
</td>
<td style="text-align:right;">
5.994
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
11.261
</td>
<td style="text-align:right;">
10.689
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
8.607
</td>
<td style="text-align:right;">
3.614
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
8.269
</td>
<td style="text-align:right;">
3.196
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
7.412
</td>
<td style="text-align:right;">
4.054
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
5.765
</td>
<td style="text-align:right;">
3.673
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
4.303
</td>
<td style="text-align:right;">
3.945
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
0
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
73.502
</td>
<td style="text-align:right;">
9.902
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
61.418
</td>
<td style="text-align:right;">
12.663
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
58.698
</td>
<td style="text-align:right;">
7.293
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
16.381
</td>
<td style="text-align:right;">
4.597
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
10.950
</td>
<td style="text-align:right;">
15.412
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
7.530
</td>
<td style="text-align:right;">
2.842
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
7.217
</td>
<td style="text-align:right;">
4.831
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
5.915
</td>
<td style="text-align:right;">
2.380
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
5.185
</td>
<td style="text-align:right;">
3.557
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
2.608
</td>
<td style="text-align:right;">
3.049
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-10
</td>
<td style="text-align:left;vertical-align: top !important;" rowspan="48">
xgb
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
8.326
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
50.412
</td>
<td style="text-align:right;">
33.030
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
46.176
</td>
<td style="text-align:right;">
26.011
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
33.298
</td>
<td style="text-align:right;">
23.914
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
12.746
</td>
<td style="text-align:right;">
33.315
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
8.286
</td>
<td style="text-align:right;">
9.542
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
6.242
</td>
<td style="text-align:right;">
6.752
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
4.984
</td>
<td style="text-align:right;">
7.610
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
4.294
</td>
<td style="text-align:right;">
4.897
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
4.077
</td>
<td style="text-align:right;">
5.957
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
2.699
</td>
<td style="text-align:right;">
7.147
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
1.485
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-7
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
2.563
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
54.192
</td>
<td style="text-align:right;">
30.370
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
47.965
</td>
<td style="text-align:right;">
23.324
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
35.450
</td>
<td style="text-align:right;">
25.824
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
10.124
</td>
<td style="text-align:right;">
11.861
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
9.721
</td>
<td style="text-align:right;">
28.239
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
8.250
</td>
<td style="text-align:right;">
7.935
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
7.282
</td>
<td style="text-align:right;">
9.349
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
5.283
</td>
<td style="text-align:right;">
6.743
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
4.524
</td>
<td style="text-align:right;">
9.943
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
3.554
</td>
<td style="text-align:right;">
5.180
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
1.792
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
-5
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
6.043
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
56.159
</td>
<td style="text-align:right;">
24.917
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
53.419
</td>
<td style="text-align:right;">
20.474
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
36.851
</td>
<td style="text-align:right;">
21.204
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
9.296
</td>
<td style="text-align:right;">
23.562
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
8.407
</td>
<td style="text-align:right;">
8.328
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
7.081
</td>
<td style="text-align:right;">
5.976
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
6.887
</td>
<td style="text-align:right;">
7.442
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
6.469
</td>
<td style="text-align:right;">
6.367
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
3.682
</td>
<td style="text-align:right;">
8.254
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
2.740
</td>
<td style="text-align:right;">
5.203
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
1.987
</td>
</tr>
<tr>
<td style="text-align:right;vertical-align: top !important;" rowspan="12">
0
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
100.000
</td>
<td style="text-align:right;">
0.000
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
47.006
</td>
<td style="text-align:right;">
18.128
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
46.116
</td>
<td style="text-align:right;">
12.237
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
39.863
</td>
<td style="text-align:right;">
17.518
</td>
</tr>
<tr>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
16.833
</td>
<td style="text-align:right;">
26.619
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
9.674
</td>
<td style="text-align:right;">
8.132
</td>
</tr>
<tr>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
7.456
</td>
<td style="text-align:right;">
6.551
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
6.381
</td>
<td style="text-align:right;">
9.321
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
5.842
</td>
<td style="text-align:right;">
9.424
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
4.021
</td>
<td style="text-align:right;">
5.999
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
1.967
</td>
<td style="text-align:right;">
3.607
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.942
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>library(stringr)

files &lt;- list.files(outdir, pattern = &quot;varimp_.*rds&quot;, full.names = TRUE)
table(sapply(files, function(f) str_extract(f, &quot;_(glmnet|rf|xgb)_&quot;)))</code></pre>
<pre><code>## 
## _glmnet_     _rf_    _xgb_ 
##      300      300      300</code></pre>
<pre class="r"><code>library(ggplot2)
library(stringr)

# renommer pour correspondre aux colonnes existantes
summary_varimp &lt;- summary_varimp_mice
#summary_varimp$Variable &lt;- str_wrap(summary_varimp$Variable, width = 15)
summary_varimp &lt;- summary_varimp %&gt;%
  mutate(Variable = ifelse(Variable == &quot;tumrtypHepatic/Biliary/Pancreatic/Unknown primary&quot;,
                           &quot;tumrtypHepat/Bili/pan/prim&quot;,  # nom plus court
                           Variable))

# boucle sur chaque Threshold et créer un plot
plots &lt;- lapply(unique(summary_varimp$Threshold), function(thr) {
  df_thr &lt;- subset(summary_varimp, Threshold == thr)
  
  ggplot(df_thr, aes(x = MedianImportance,
                     y = reorder(Variable, MedianImportance),
                     color = Model)) +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = MedianImportance - IQRImportance/2,
                       xmax = MedianImportance + IQRImportance/2),
                   height = 0.2, alpha = 0.6) +
    labs(title = paste(&quot;Variable Importance MICE analysis (Thr:&quot;, thr, &quot;)&quot;),
         x = &quot;Median Importance ± IQR&quot;,
         y = &quot;Variables&quot;,
         color = &quot;Model&quot;) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = &quot;bold&quot;),
      axis.title.x = element_text(face = &quot;bold&quot;),
      axis.title.y = element_text(face = &quot;bold&quot;),
      legend.position = &quot;bottom&quot;
    )
})

# Afficher tous les plots
for (i in seq_along(plots)) {
  print(plots[[i]])
}</code></pre>
<p><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-19-1.png" width="672" /><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-19-2.png" width="672" /><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-19-3.png" width="672" /><img src="03_prediction_and_comparison_files/figure-html/unnamed-chunk-19-4.png" width="672" /></p>
<pre class="r"><code># Optionnel : sauvegarder les plots
outdir &lt;- &quot;results_impute_nested&quot;
dir.create(outdir, showWarnings = FALSE)
for (i in seq_along(plots)) {
  ggsave(filename = file.path(outdir, paste0(&quot;varimp_plot_threshold_&quot;, unique(summary_varimp$Threshold)[i], &quot;.png&quot;)),
         plot = plots[[i]], width = 10, height = 6)
}</code></pre>
<pre class="r"><code># ===============================
# Rubin pooling of metrics (AUC, Brier, Slope)
# ===============================

# Function to pool one metric (vector of per-fold values by imputation)
rubin_pool &lt;- function(results_df, metric = &quot;AUC&quot;) {
  pooled_list &lt;- list()
  for (thr in unique(results_df$Threshold)) {
    for (mod in unique(results_df$Model)) {
      sub &lt;- results_df %&gt;% filter(Threshold == thr, Model == mod)
      if (nrow(sub) == 0) next
      # split by imputation
      imp_groups &lt;- split(sub[[metric]], sub$Imputation)
      m &lt;- length(imp_groups)
      if (m &lt; 2) next
      Q_i &lt;- sapply(imp_groups, mean, na.rm=TRUE)     # mean per imputation
      U_i &lt;- sapply(imp_groups, function(x) var(x, na.rm=TRUE)/length(na.omit(x))) # var/ni
      Q_bar &lt;- mean(Q_i, na.rm=TRUE)
      U &lt;- mean(U_i, na.rm=TRUE)
      B &lt;- var(Q_i, na.rm=TRUE)
      T &lt;- U + (1+1/m)*B
      se &lt;- sqrt(T)
      lower &lt;- Q_bar - 1.96*se
      upper &lt;- Q_bar + 1.96*se
      pooled_list[[length(pooled_list)+1]] &lt;- data.frame(
        Threshold=thr, Model=mod, Metric=metric,
        Mean=Q_bar, SE=se, Lower=lower, Upper=upper
      )
    }
  }
  if (length(pooled_list)==0) return(NULL)
  bind_rows(pooled_list)
}

# Pool AUC, Brier, Slope
rubin_auc   &lt;- rubin_pool(all_runs, metric=&quot;AUC&quot;)
rubin_brier &lt;- rubin_pool(all_runs, metric=&quot;Brier&quot;)
rubin_slope &lt;- rubin_pool(all_runs, metric=&quot;Slope&quot;)

rubin_all &lt;- bind_rows(rubin_auc, rubin_brier, rubin_slope)

# Save
write.csv(rubin_all, file=file.path(outdir, &quot;rubin_pooled_results.csv&quot;), row.names=FALSE)
print(rubin_all)</code></pre>
<pre><code>##    Threshold  Model Metric      Mean         SE        Lower     Upper
## 1          0 glmnet    AUC 0.6708030 0.06232704  0.548642016 0.7929640
## 2          0     rf    AUC 0.6447855 0.05283136  0.541236009 0.7483349
## 3          0    xgb    AUC 0.6568237 0.06389828  0.531583104 0.7820644
## 4         -5 glmnet    AUC 0.6587288 0.07894418  0.503998230 0.8134594
## 5         -5     rf    AUC 0.6258429 0.09167156  0.446166652 0.8055192
## 6         -5    xgb    AUC 0.6394907 0.08311130  0.476592552 0.8023888
## 7         -7 glmnet    AUC 0.6479898 0.09467059  0.462435482 0.8335442
## 8         -7     rf    AUC 0.6121985 0.09130224  0.433246131 0.7911509
## 9         -7    xgb    AUC 0.6232051 0.09139969  0.444061725 0.8023485
## 10       -10 glmnet    AUC 0.6711778 0.08172433  0.510998094 0.8313575
## 11       -10     rf    AUC 0.6475717 0.08096341  0.488883393 0.8062600
## 12       -10    xgb    AUC 0.6609411 0.08870711  0.487075148 0.8348070
## 13         0 glmnet  Brier 0.2193398 0.01834273  0.183388058 0.2552916
## 14         0     rf  Brier 0.2282903 0.01893649  0.191174780 0.2654058
## 15         0    xgb  Brier 0.2272037 0.02237721  0.183344420 0.2710631
## 16        -5 glmnet  Brier 0.1792468 0.02769154  0.124971401 0.2335222
## 17        -5     rf  Brier 0.1851700 0.02881359  0.128695365 0.2416446
## 18        -5    xgb  Brier 0.1872217 0.03086085  0.126734428 0.2477090
## 19        -7 glmnet  Brier 0.1641536 0.03010818  0.105141589 0.2231656
## 20        -7     rf  Brier 0.1729990 0.03181463  0.110642322 0.2353557
## 21        -7    xgb  Brier 0.1733727 0.03226702  0.110129313 0.2366160
## 22       -10 glmnet  Brier 0.1536677 0.03465416  0.085745515 0.2215898
## 23       -10     rf  Brier 0.1587619 0.03551459  0.089153311 0.2283705
## 24       -10    xgb  Brier 0.1583254 0.03635796  0.087063821 0.2295870
## 25         0 glmnet  Slope 1.2432321 0.85525081 -0.433059458 2.9195237
## 26         0     rf  Slope 0.7324463 0.34741208  0.051518604 1.4133739
## 27         0    xgb  Slope 0.6401537 0.27569878  0.099784096 1.1805233
## 28        -5 glmnet  Slope 1.1259872 0.95367156 -0.743209109 2.9951834
## 29        -5     rf  Slope 0.6818725 0.35826318 -0.020323287 1.3840684
## 30        -5    xgb  Slope 0.5737703 0.29420983 -0.002880922 1.1504216
## 31        -7 glmnet  Slope 1.1344748 0.93406090 -0.696284599 2.9652341
## 32        -7     rf  Slope 0.5079332 0.40575734 -0.287351236 1.3032176
## 33        -7    xgb  Slope 0.4840409 0.33419814 -0.170987441 1.1390693
## 34       -10 glmnet  Slope 2.1499793 2.72440865 -3.189861692 7.4898202
## 35       -10     rf  Slope 0.6343849 0.41869043 -0.186248392 1.4550181
## 36       -10    xgb  Slope 0.6294004 0.35832281 -0.072912330 1.3317131</code></pre>
<p><em>Bloc R : MNAR sensitivity (delta-adjustment) + nested CV (même
paramètres)</em></p>
<pre class="r"><code># ============================
# MNAR sensitivity analysis — full version with plots
# ============================

# ============================
# MNAR sensitivity analysis
# Applies delta-adjustments to MICE imputations and runs nested_cv_eval
# Uses same nested_cv_eval, predictors and CV parameters you defined earlier
# Saves results and plots in outdir_mnar
# ============================

library(dplyr)
library(foreach)
library(doParallel)
library(ggplot2)
library(readr)
library(tidyr)

# ---- Configuration ----
if (!exists(&quot;imputed_list&quot;)) stop(&quot;imputed_list not found: run mice() first.&quot;)
if(!(&quot;R24&quot; %in% names(data_main_clean))) {
  data_main_clean &lt;- data_main_clean %&gt;% mutate(R24 = ifelse(!is.na(fact_chg24), 1, 0))
}

deltas &lt;- c(0, 5, 7, 10)    # MAR = 0, MNAR scenarios
thresholds &lt;- c(0, -5, -7, -10)
outdir_mnar &lt;- &quot;results_mnar&quot;
dir.create(outdir_mnar, showWarnings = FALSE)

ncores &lt;- max(1, parallel::detectCores() - 1)
cl &lt;- makeCluster(ncores)
registerDoParallel(cl)

predictors &lt;- c(&quot;age&quot;,&quot;sex&quot;,&quot;ecogps&quot;,&quot;fact_bl&quot;,&quot;tumrtyp&quot;,&quot;arm&quot;,&quot;cgpart&quot;,
                &quot;hads_pt_anx_bl&quot;,&quot;hads_pt_dep_bl&quot;,&quot;edu_cat&quot;)
missing_preds &lt;- setdiff(predictors, names(imputed_list[[1]]))
if(length(missing_preds)&gt;0) stop(&quot;Missing predictors: &quot;,paste(missing_preds,collapse=&quot;, &quot;))

# ---- helper: apply delta shift ----
apply_delta_to_imputation &lt;- function(imputed_df, orig_R24, delta) {
  df &lt;- imputed_df
  if(delta != 0) {
    idx_miss &lt;- which(orig_R24 == 0)
    if(length(idx_miss)&gt;0 &amp;&amp; &quot;fact_chg24&quot; %in% names(df)) {
      df$fact_chg24 &lt;- as.numeric(df$fact_chg24)
      df$fact_chg24[idx_miss] &lt;- df$fact_chg24[idx_miss] - delta
    }
  }
  return(df)
}

# ---- MAIN LOOP ----
all_mnar_results &lt;- list()

for(delta in deltas) {
  cat(&quot;Running MNAR delta =&quot;, delta, &quot;\n&quot;)
  delta_dir &lt;- file.path(outdir_mnar, paste0(&quot;delta_minus_&quot;, delta))
  dir.create(delta_dir, showWarnings = FALSE, recursive = TRUE)
  
  results_by_delta &lt;- foreach(imp_i = seq_along(imputed_list),
                              .packages = c(&quot;dplyr&quot;,&quot;caret&quot;,&quot;glmnet&quot;,&quot;ranger&quot;,&quot;xgboost&quot;,&quot;pROC&quot;),
                              .errorhandling=&quot;pass&quot;) %dopar% {
    dat_imp &lt;- imputed_list[[imp_i]]
    if(&quot;patref&quot; %in% names(dat_imp) &amp;&amp; &quot;patref&quot; %in% names(data_main_clean)) {
      dat_imp &lt;- dat_imp[match(data_main_clean$patref, dat_imp$patref), ]
    }
    orig_R24 &lt;- data_main_clean$R24
    dat_imp_mnar &lt;- apply_delta_to_imputation(dat_imp, orig_R24, delta)
    
    res_per_thr &lt;- list()
    for(thr in thresholds) {
      dat_work &lt;- dat_imp_mnar %&gt;%
        mutate(fact_chg24_bin = ifelse(!is.na(fact_chg24) &amp; fact_chg24 &lt;= thr, 1,
                                ifelse(!is.na(fact_chg24), 0, NA))) %&gt;%
        filter(!is.na(fact_chg24_bin))
      
      if(nrow(dat_work)&lt;30 || sum(dat_work$fact_chg24_bin==1)&lt;5) {
        res_per_thr[[as.character(thr)]] &lt;- data.frame(Imputation=imp_i,Delta=delta,
                                                       Threshold=thr,Note=&quot;too_small&quot;)
        next
      }
      
      dat_work$fact_chg24_bin &lt;- factor(dat_work$fact_chg24_bin, levels=c(0,1), labels=c(&quot;no&quot;,&quot;yes&quot;))
      res_df &lt;- tryCatch({
        nested_cv_eval(dat_work, outcome_var=&quot;fact_chg24_bin&quot;, predictors=predictors,
                       outer_k=5, inner_k=3, seed=1000+imp_i+thr)
      }, error=function(e) NULL)
      
      if(!is.null(res_df)) {
        res_df$Imputation &lt;- imp_i; res_df$Delta &lt;- delta; res_df$Threshold &lt;- thr
      }
      res_per_thr[[as.character(thr)]] &lt;- res_df
    }
    res_bind &lt;- bind_rows(res_per_thr)
    saveRDS(res_bind, file=file.path(delta_dir, paste0(&quot;nested_results_imp&quot;,imp_i,&quot;_delta&quot;,delta,&quot;.rds&quot;)))
    res_bind
  }
  
  results_by_delta_combined &lt;- bind_rows(results_by_delta)
  saveRDS(results_by_delta_combined, file=file.path(delta_dir, paste0(&quot;nested_results_all_imputations_delta&quot;,delta,&quot;.rds&quot;)))
  write_csv(results_by_delta_combined, file=file.path(delta_dir, paste0(&quot;nested_results_all_imputations_delta&quot;,delta,&quot;.csv&quot;)))
  all_mnar_results[[paste0(&quot;delta_&quot;,delta)]] &lt;- results_by_delta_combined
}</code></pre>
<pre><code>## Running MNAR delta = 0 
## Running MNAR delta = 5 
## Running MNAR delta = 7 
## Running MNAR delta = 10</code></pre>
<pre class="r"><code>stopCluster(cl); registerDoSEQ()

# ---- Summary median / IQR ----
summary_list &lt;- list()
for(delta in names(all_mnar_results)) {
  df &lt;- all_mnar_results[[delta]]; if(!(&quot;AUC&quot; %in% names(df))) next
  summary_df &lt;- df %&gt;%
    filter(!is.na(AUC)) %&gt;%
    group_by(Threshold, Model, Delta) %&gt;%
    summarise(
      AUC_median = median(AUC, na.rm=TRUE),
      AUC_IQR = IQR(AUC, na.rm=TRUE),
      Brier_median = median(Brier, na.rm=TRUE),
      Brier_IQR = IQR(Brier, na.rm=TRUE),
      Slope_median = median(Slope, na.rm=TRUE),
      Slope_IQR = IQR(Slope, na.rm=TRUE),
      .groups=&quot;drop&quot;
    )
  summary_list[[delta]] &lt;- summary_df
  write_csv(summary_df, file=file.path(outdir_mnar, paste0(&quot;summary_&quot;,delta,&quot;.csv&quot;)))
}
summary_all_deltas &lt;- bind_rows(summary_list)
write_csv(summary_all_deltas, file=file.path(outdir_mnar,&quot;summary_all_deltas.csv&quot;))

# ---- Boxplots AUC / Brier / Slope ----
gg_auc &lt;- ggplot(bind_rows(all_mnar_results), aes(x=factor(Threshold), y=AUC, fill=Model)) +
  geom_boxplot(outlier.alpha=0.3) +
  facet_wrap(~Delta, labeller=label_both) +
  labs(title=&quot;AUC by Model, Threshold, and Delta (MNAR scenarios)&quot;, x=&quot;Threshold&quot;, y=&quot;AUC&quot;) +
  theme_minimal(base_size=13)
ggsave(file.path(outdir_mnar,&quot;AUC_boxplot_MNAR.png&quot;), plot=gg_auc, width=10, height=6)

gg_brier &lt;- ggplot(bind_rows(all_mnar_results), aes(x=factor(Threshold), y=Brier, fill=Model)) +
  geom_boxplot(outlier.alpha=0.3) +
  facet_wrap(~Delta, labeller=label_both) +
  labs(title=&quot;Brier by Model, Threshold, and Delta (MNAR scenarios)&quot;, x=&quot;Threshold&quot;, y=&quot;Brier&quot;) +
  theme_minimal(base_size=13)
ggsave(file.path(outdir_mnar,&quot;Brier_boxplot_MNAR.png&quot;), plot=gg_brier, width=10, height=6)

gg_slope &lt;- ggplot(bind_rows(all_mnar_results), aes(x=factor(Threshold), y=Slope, fill=Model)) +
  geom_boxplot(outlier.alpha=0.3) +
  geom_hline(yintercept=1, linetype=&quot;dashed&quot;, color=&quot;red&quot;) +
  facet_wrap(~Delta, labeller=label_both) +
  labs(title=&quot;Calibration slope by Model, Threshold, and Delta&quot;, x=&quot;Threshold&quot;, y=&quot;Slope&quot;) +
  theme_minimal(base_size=13)
ggsave(file.path(outdir_mnar,&quot;Slope_boxplot_MNAR.png&quot;), plot=gg_slope, width=10, height=6)</code></pre>
<pre><code>## Warning: Removed 19 rows containing non-finite outside the scale range
## (`stat_boxplot()`).</code></pre>
<pre class="r"><code># ---- Heatmap des médianes ----
res_long &lt;- summary_all_deltas %&gt;%
  pivot_longer(cols=c(AUC_median,Brier_median,Slope_median),
               names_to=&quot;Metric&quot;, values_to=&quot;Value&quot;)

gg_heat &lt;- ggplot(res_long, aes(x=factor(Threshold), y=Model, fill=Value)) +
  geom_tile(color=&quot;white&quot;) +
  geom_text(aes(label=round(Value,2)), color=&quot;black&quot;, size=3) +
  facet_grid(Metric~Delta, scales=&quot;free_y&quot;, labeller=label_both) +
  labs(title=&quot;Median performance (MNAR sensitivity)&quot;, x=&quot;Threshold&quot;, y=&quot;Model&quot;) +
  theme_minimal(base_size=12)
ggsave(file.path(outdir_mnar,&quot;Heatmap_MNAR_medians.png&quot;), plot=gg_heat, width=11, height=6)

# ---- Line plot: AUC median vs Delta ----
p_line &lt;- ggplot(summary_all_deltas, aes(x=factor(Delta), y=AUC_median, color=Model, group=Model)) +
  geom_point(size=2) + geom_line() +
  facet_wrap(~Threshold) +
  labs(title=&quot;Median AUC by Delta (MNAR sensitivity)&quot;, x=&quot;Delta shift (points)&quot;, y=&quot;Median AUC&quot;) +
  theme_minimal(base_size=13)
ggsave(file.path(outdir_mnar,&quot;AUC_median_vs_Delta.png&quot;), plot=p_line, width=10, height=6)

cat(&quot;✅ MNAR sensitivity analysis completed — all results &amp; figures saved in:&quot;, outdir_mnar, &quot;\n&quot;)</code></pre>
<pre><code>## ✅ MNAR sensitivity analysis completed — all results &amp; figures saved in: results_mnar</code></pre>
<pre class="r"><code># =====================================================
# 📊 COMPARATIVE PERFORMANCE TABLES: IPCW vs MICE vs MNAR
# =====================================================

library(dplyr)
library(kableExtra)
library(stringr)
library(purrr)</code></pre>
<pre><code>## 
## Attaching package: &#39;purrr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:foreach&#39;:
## 
##     accumulate, when</code></pre>
<pre><code>## The following object is masked from &#39;package:flextable&#39;:
## 
##     compose</code></pre>
<pre><code>## The following object is masked from &#39;package:caret&#39;:
## 
##     lift</code></pre>
<pre class="r"><code>library(htmltools)

# ---------- 1. Dossier de sortie ----------
out_summary &lt;- &quot;output_summary&quot;
dir.create(out_summary, showWarnings = FALSE)

# ---------- 2. Charger les résultats ----------
summary_ipcw &lt;- read.csv(&quot;outputs_prediction_IPCW/summary_median_IQR_1.csv&quot;)
summary_mice &lt;- read.csv(&quot;results_prediction_MICE/summary_median_IQR.csv&quot;)
summary_mnar_d5  &lt;- read.csv(&quot;results_mnar/summary_delta_5.csv&quot;)
summary_mnar_d7  &lt;- read.csv(&quot;results_mnar/summary_delta_7.csv&quot;)
summary_mnar_d10 &lt;- read.csv(&quot;results_mnar/summary_delta_10.csv&quot;)

# ---------- 3. Mise en forme des métriques ----------
format_metric &lt;- function(df, metric){
  df %&gt;%
    select(Threshold, Model,
           Median = paste0(metric, &quot;_median&quot;),
           IQR = paste0(metric, &quot;_IQR&quot;)) %&gt;%
    mutate(value = sprintf(&quot;%.3f [%.3f]&quot;, Median, IQR)) %&gt;%
    select(Threshold, Model, value)
}

merge_metrics &lt;- function(metric){
  ipcw &lt;- format_metric(summary_ipcw, metric) %&gt;% rename(IPCW = value)
  mice &lt;- format_metric(summary_mice, metric) %&gt;% rename(MICE = value)
  d5   &lt;- format_metric(summary_mnar_d5, metric) %&gt;% rename(MNAR_d5 = value)
  d7   &lt;- format_metric(summary_mnar_d7, metric) %&gt;% rename(MNAR_d7 = value)
  d10  &lt;- format_metric(summary_mnar_d10, metric) %&gt;% rename(MNAR_d10 = value)

  full &lt;- reduce(list(ipcw, mice, d5, d7, d10), full_join, by = c(&quot;Threshold&quot;, &quot;Model&quot;))

  # ---------- Interprétation ----------
  full &lt;- full %&gt;%
    mutate(
      Comment = case_when(
        as.numeric(str_extract(MICE, &quot;^[0-9.]+&quot;)) &gt;
          as.numeric(str_extract(IPCW, &quot;^[0-9.]+&quot;)) &amp;
        as.numeric(str_extract(MNAR_d10, &quot;^[0-9.]+&quot;)) &gt;
          as.numeric(str_extract(IPCW, &quot;^[0-9.]+&quot;)) ~ &quot;MICE &gt; IPCW; MNAR robust&quot;,
        
        as.numeric(str_extract(MICE, &quot;^[0-9.]+&quot;)) &gt;
          as.numeric(str_extract(IPCW, &quot;^[0-9.]+&quot;)) &amp;
        as.numeric(str_extract(MNAR_d10, &quot;^[0-9.]+&quot;)) &lt;
          as.numeric(str_extract(MICE, &quot;^[0-9.]+&quot;)) ~ &quot;MICE &gt; IPCW; decline with MNAR&quot;,
        
        as.numeric(str_extract(MICE, &quot;^[0-9.]+&quot;)) &lt;
          as.numeric(str_extract(IPCW, &quot;^[0-9.]+&quot;)) ~ &quot;IPCW slightly better&quot;,
        
        TRUE ~ &quot;Stable across methods&quot;
      )
    )
  full
}

# ---------- 4. Coloration conditionnelle ----------
highlight_cell &lt;- function(val_mice, val_ipcw, val_mnar5, val_mnar7, val_mnar10){
  v_mice &lt;- as.numeric(str_extract(val_mice, &quot;^[0-9.]+&quot;))
  v_ipcw &lt;- as.numeric(str_extract(val_ipcw, &quot;^[0-9.]+&quot;))
  v_d5   &lt;- as.numeric(str_extract(val_mnar5, &quot;^[0-9.]+&quot;))
  v_d7   &lt;- as.numeric(str_extract(val_mnar7, &quot;^[0-9.]+&quot;))
  v_d10  &lt;- as.numeric(str_extract(val_mnar10, &quot;^[0-9.]+&quot;))

  cell &lt;- list(IPCW = val_ipcw, MICE = val_mice,
               MNAR_d5 = val_mnar5, MNAR_d7 = val_mnar7, MNAR_d10 = val_mnar10)

  cell$MICE &lt;- cell_spec(val_mice, &quot;html&quot;,
                         background = ifelse(v_mice &gt; v_ipcw, &quot;#d1ffd1&quot;, &quot;white&quot;))
  cell$MNAR_d5 &lt;- cell_spec(val_mnar5, &quot;html&quot;,
                            background = ifelse(abs(v_mice - v_d5) &lt; 0.02, &quot;#fff7d1&quot;, &quot;white&quot;))
  cell$MNAR_d7 &lt;- cell_spec(val_mnar7, &quot;html&quot;,
                            background = ifelse(abs(v_mice - v_d7) &lt; 0.04, &quot;#fff7d1&quot;, &quot;white&quot;))
  cell$MNAR_d10 &lt;- cell_spec(val_mnar10, &quot;html&quot;,
                             background = ifelse(v_d10 &lt; (v_mice - 0.05), &quot;#ffd1d1&quot;, &quot;white&quot;))
  return(cell)
}

apply_coloring &lt;- function(df){
  df %&gt;%
    rowwise() %&gt;%
    mutate(cells = list(highlight_cell(MICE, IPCW, MNAR_d5, MNAR_d7, MNAR_d10))) %&gt;%
    mutate(
      IPCW = cells$IPCW,
      MICE = cells$MICE,
      MNAR_d5 = cells$MNAR_d5,
      MNAR_d7 = cells$MNAR_d7,
      MNAR_d10 = cells$MNAR_d10
    ) %&gt;%
    select(-cells) %&gt;%
    ungroup()
}

# ---------- 5. Création des tableaux ----------
make_table &lt;- function(metric, title, filename_prefix){
  df_metric &lt;- merge_metrics(metric)
  df_metric &lt;- apply_coloring(df_metric)

  # Sauvegarde CSV brut
  write.csv(df_metric, file.path(out_summary, paste0(filename_prefix, &quot;.csv&quot;)), row.names = FALSE)

  # Tableau publication ready (HTML)
  tbl &lt;- df_metric %&gt;%
    kbl(escape = FALSE,
        caption = paste0(title, &quot; (Median [IQR])&quot;),
        col.names = c(&quot;Threshold&quot;, &quot;Model&quot;, &quot;IPCW&quot;, &quot;MICE&quot;, &quot;MNAR Δ=-5&quot;, &quot;MNAR Δ=-7&quot;, &quot;MNAR Δ=-10&quot;, &quot;Comment&quot;),
        align = &quot;c&quot;) %&gt;%
    kable_styling(full_width = FALSE, bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;, &quot;condensed&quot;)) %&gt;%
    column_spec(1, bold = TRUE, width = &quot;5em&quot;) %&gt;%
    column_spec(2, bold = TRUE, width = &quot;6em&quot;) %&gt;%
    collapse_rows(columns = 1, valign = &quot;top&quot;)

  save_kable(tbl, file = file.path(out_summary, paste0(filename_prefix, &quot;.html&quot;)))
  return(tbl)
}

# ---------- 6. Génération ----------
table_auc   &lt;- make_table(&quot;AUC&quot;,   &quot;Table 1. Comparison of AUC across IPCW, MICE, and MNAR analyses&quot;,   &quot;Table1_AUC&quot;)
table_brier &lt;- make_table(&quot;Brier&quot;, &quot;Table 2. Comparison of Brier score across IPCW, MICE, and MNAR analyses&quot;, &quot;Table2_Brier&quot;)
table_slope &lt;- make_table(&quot;Slope&quot;, &quot;Table 3. Comparison of Calibration slope across IPCW, MICE, and MNAR analyses&quot;, &quot;Table3_Slope&quot;)

# ---------- 7. Affichage ----------
table_auc</code></pre>
<table class="table table-striped table-hover table-condensed" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Table 1. Comparison of AUC across IPCW, MICE, and MNAR analyses (Median
[IQR])
</caption>
<thead>
<tr>
<th style="text-align:center;">
Threshold
</th>
<th style="text-align:center;">
Model
</th>
<th style="text-align:center;">
IPCW
</th>
<th style="text-align:center;">
MICE
</th>
<th style="text-align:center;">
MNAR Δ=-5
</th>
<th style="text-align:center;">
MNAR Δ=-7
</th>
<th style="text-align:center;">
MNAR Δ=-10
</th>
<th style="text-align:center;">
Comment
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-10
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.567 [0.207]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.664
[0.158]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.639
[0.119]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.626
[0.116]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.630
[0.118]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.587 [0.145]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.644
[0.169]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.614
[0.127]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.619
[0.164]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.582
[0.118]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; decline with MNAR
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.569 [0.183]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.663
[0.155]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.623
[0.147]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.614
[0.143]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.625
[0.113]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-7
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.644 [0.079]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.629
[0.195]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.616
[0.121]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.632
[0.120]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.603
[0.115]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.607 [0.167]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.608
[0.170]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.622
[0.127]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.617
[0.117]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.567
[0.084]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; decline with MNAR
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.677 [0.137]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.625
[0.176]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.627
[0.123]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.609
[0.105]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.590
[0.084]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-5
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.655 [0.159]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.671
[0.136]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.643
[0.119]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.635
[0.084]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.632
[0.112]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; decline with MNAR
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.597 [0.163]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.622
[0.169]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.622
[0.125]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.614
[0.099]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.590
[0.090]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; decline with MNAR
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.654 [0.118]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.661
[0.165]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.615
[0.116]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.621
[0.071]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.598
[0.094]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; decline with MNAR
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
0
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.660 [0.176]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.670
[0.082]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.659
[0.098]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.659
[0.098]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.639
[0.097]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; decline with MNAR
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.579 [0.180]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.645
[0.097]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.621
[0.098]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.616
[0.128]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.605
[0.084]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.605 [0.130]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.652
[0.089]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.649
[0.094]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.639
[0.125]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.615
[0.086]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>table_brier</code></pre>
<table class="table table-striped table-hover table-condensed" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Table 2. Comparison of Brier score across IPCW, MICE, and MNAR analyses
(Median [IQR])
</caption>
<thead>
<tr>
<th style="text-align:center;">
Threshold
</th>
<th style="text-align:center;">
Model
</th>
<th style="text-align:center;">
IPCW
</th>
<th style="text-align:center;">
MICE
</th>
<th style="text-align:center;">
MNAR Δ=-5
</th>
<th style="text-align:center;">
MNAR Δ=-7
</th>
<th style="text-align:center;">
MNAR Δ=-10
</th>
<th style="text-align:center;">
Comment
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-10
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.154 [0.074]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.145
[0.044]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.168
[0.041]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.184
[0.035]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.204
[0.038]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.152 [0.051]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.150
[0.055]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.172
[0.045]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.191
[0.036]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.215
[0.036]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.169 [0.080]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.146
[0.055]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.168
[0.048]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.192
[0.036]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.211
[0.036]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-7
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.166 [0.056]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.161
[0.038]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.195
[0.041]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.208
[0.030]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.224
[0.034]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.182 [0.057]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.169
[0.047]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.202
[0.041]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.215
[0.033]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.230
[0.037]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.201 [0.069]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.172
[0.049]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.206
[0.046]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.221
[0.036]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.231
[0.035]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-5
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.167 [0.054]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.177
[0.032]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.214
[0.031]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.219
[0.027]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.230
[0.030]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.157 [0.042]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.184
[0.037]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.216
[0.035]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.223
[0.033]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.239
[0.029]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.181 [0.086]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.184
[0.042]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.217
[0.039]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.223
[0.037]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.240
[0.035]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
0
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.249 [0.033]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.221
[0.023]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.226
[0.022]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.229
[0.028]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.228
[0.023]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.261 [0.068]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.227
[0.027]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.238
[0.022]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.237
[0.034]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.235
[0.023]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.281 [0.065]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.228
[0.029]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.232
[0.027]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.240
[0.037]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.234
[0.029]</span>
</td>
<td style="text-align:center;">
IPCW slightly better
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>table_slope</code></pre>
<table class="table table-striped table-hover table-condensed" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Table 3. Comparison of Calibration slope across IPCW, MICE, and MNAR
analyses (Median [IQR])
</caption>
<thead>
<tr>
<th style="text-align:center;">
Threshold
</th>
<th style="text-align:center;">
Model
</th>
<th style="text-align:center;">
IPCW
</th>
<th style="text-align:center;">
MICE
</th>
<th style="text-align:center;">
MNAR Δ=-5
</th>
<th style="text-align:center;">
MNAR Δ=-7
</th>
<th style="text-align:center;">
MNAR Δ=-10
</th>
<th style="text-align:center;">
Comment
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-10
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.376 [0.801]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">1.005
[1.198]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.901
[1.253]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.953
[1.128]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.984
[1.145]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.286 [0.753]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.656
[0.817]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.595
[0.578]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.562
[0.818]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.451
[0.648]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.133 [0.343]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.658
[0.606]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.535
[0.485]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.427
[0.560]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.497
[0.529]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-7
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.302 [0.374]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.840
[0.773]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.745
[0.970]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.821
[0.871]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.808
[1.130]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.443 [0.966]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.497
[0.624]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.533
[0.699]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.619
[0.530]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.419
[0.527]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; decline with MNAR
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.223 [0.338]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.456
[0.610]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.469
[0.491]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.466
[0.429]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.380
[0.472]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
-5
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.423 [0.789]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.858
[0.727]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.774
[0.615]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.748
[0.521]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.778
[0.786]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.653 [0.818]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.666
[0.668]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.670
[0.655]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.612
[0.537]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.536
[0.558]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; decline with MNAR
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.234 [0.333]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.571
[0.571]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.476
[0.525]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.532
[0.375]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.442
[0.460]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 5em; font-weight: bold;vertical-align: top !important;" rowspan="3">
0
</td>
<td style="text-align:center;width: 6em; font-weight: bold;">
glmnet
</td>
<td style="text-align:center;">
0.656 [1.177]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.882
[0.519]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.842
[0.669]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.855
[0.794]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.801
[0.656]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
rf
</td>
<td style="text-align:center;">
0.239 [0.911]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.728
[0.502]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.645
[0.529]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.644
[0.655]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.598
[0.490]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
<tr>
<td style="text-align:center;width: 6em; font-weight: bold;">
xgb
</td>
<td style="text-align:center;">
0.193 [0.175]
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(209, 255, 209, 255) !important;">0.619
[0.380]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 247, 209, 255) !important;">0.613
[0.402]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.562
[0.464]</span>
</td>
<td style="text-align:center;">
<span
style="     border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: rgba(255, 209, 209, 255) !important;">0.527
[0.417]</span>
</td>
<td style="text-align:center;">
MICE &gt; IPCW; MNAR robust
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>cat(&quot;✅ All tables saved in folder:&quot;, out_summary, &quot;\n&quot;)</code></pre>
<pre><code>## ✅ All tables saved in folder: output_summary</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
