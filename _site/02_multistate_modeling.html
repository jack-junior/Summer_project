<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="GAYI KOMI SELASSI" />

<meta name="date" content="2025-10-19" />

<title>Functional attrition and Quality of Life in Advanced Cancer Trial: modeling patients’ trajectories and evaluating the impact of missing outcome data handling on quality-of-life prognostic</title>

<script src="site_libs/header-attrs-2.27/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">My Website</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Functional attrition and Quality of Life in
Advanced Cancer Trial: modeling patients’ trajectories and evaluating
the impact of missing outcome data handling on quality-of-life
prognostic</h1>
<h4 class="author">GAYI KOMI SELASSI</h4>
<h4 class="date">2025-10-19</h4>

</div>


<div id="section" class="section level1">
<h1><em>===========================================</em></h1>
</div>
<div id="discrete-time-multistate-modeling" class="section level1">
<h1><em>2.Discrete time Multistate Modeling</em></h1>
</div>
<div id="section-1" class="section level1">
<h1><em>===========================================</em></h1>
<div id="global-setup" class="section level3">
<h3><em>1. Global setup</em></h3>
</div>
<div id="import-and-data-preparation" class="section level3">
<h3><em>2. Import and data preparation</em></h3>
<pre class="r"><code>data_main_clean &lt;- readRDS(&quot;Data_Preparation_&amp;_Descriptive_output/data_main_clean_final.rds&quot;)


# Vérifier structure
glimpse(data_main_clean)</code></pre>
<pre><code>## Rows: 352
## Columns: 39
## $ patref              &lt;int&gt; 9103597, 9103612, 9103621, 9103631, 9103689, 91037…
## $ wk12_dead           &lt;fct&gt; 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0,…
## $ wk24_dead           &lt;fct&gt; 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0,…
## $ fact_chg12          &lt;dbl&gt; NA, NA, -13.0000, 8.0000, NA, NA, -13.0000, NA, NA…
## $ fact_chg24          &lt;dbl&gt; NA, NA, NA, 3.6667, NA, NA, NA, NA, -4.0000, NA, N…
## $ hads_anx_chg12      &lt;int&gt; NA, NA, -1, 0, NA, NA, 2, NA, -1, 5, 6, NA, 0, 1, …
## $ hads_dep_chg12      &lt;int&gt; NA, NA, -3, 2, NA, NA, 1, NA, 4, 8, 2, NA, 1, 4, N…
## $ n12                 &lt;int&gt; 6, 1, 0, 3, 2, 0, 4, 3, 2, 0, 1, 4, 2, 0, 5, 2, 4,…
## $ n12_grp             &lt;fct&gt; 5-6 visits, 1-2 visits, 0 visits, 3-4 visits, 1-2 …
## $ fact_bl             &lt;dbl&gt; 90.000, 97.333, 81.000, 90.000, 73.167, 62.000, 65…
## $ hads_pt_anx_bl      &lt;int&gt; 7, 0, 8, 5, 5, 16, 8, 6, 13, 1, 4, 9, 9, 6, 4, 9, …
## $ hads_pt_dep_bl      &lt;int&gt; 0, 0, 11, 1, 7, 13, 4, 10, 9, 1, 3, 7, 5, 5, 1, 2,…
## $ age                 &lt;dbl&gt; 56, 71, 86, 64, 54, 55, 69, 75, 40, 61, 85, 59, 62…
## $ sex                 &lt;fct&gt; f, m, m, m, f, f, f, f, f, f, m, f, m, f, m, m, m,…
## $ ecogps              &lt;int&gt; 0, 1, 1, 0, 1, 1, 2, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1,…
## $ tumrtyp             &lt;fct&gt; Lung, Lung, Lung, Hepatic/Biliary/Pancreatic/Unkno…
## $ cgpart              &lt;fct&gt; No, No, Yes, Yes, Yes, Yes, Yes, Yes, No, Yes, Yes…
## $ race1               &lt;fct&gt; White, White, White, White, White, White, White, W…
## $ ptethncty           &lt;fct&gt; Not Hispanic or Latino, Not Hispanic or Latino, No…
## $ pthighedu           &lt;fct&gt; Bachelor&#39;s degree, Associate degree/some college, …
## $ ptmargstat          &lt;fct&gt; Domestic partnership, Divorced, Married, Married, …
## $ ptrelgn             &lt;fct&gt; Catholic, Other, Jewish, Catholic, Protestant, Not…
## $ sitetype            &lt;fct&gt; Community, NA, NA, Community, Academic, NA, Academ…
## $ arm                 &lt;fct&gt; 1, 2, 2, 1, 1, 2, 1, 1, 2, 2, 2, 2, 1, 2, 1, 1, 1,…
## $ bsl_assess_complete &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ ptpqpt1_grp         &lt;fct&gt; NA, NA, &quot;I want to hear as many details as possibl…
## $ ptpqpt7_grp         &lt;fct&gt; NA, NA, I now have about the right amount of infor…
## $ ptpqpt9e_grp        &lt;fct&gt; NA, NA, Not at all to very helpful, Extremely Help…
## $ ptpqpt11_grp        &lt;fct&gt; NA, NA, No chance (0% chance), No chance (0% chanc…
## $ ptpqpt12_grp        &lt;fct&gt; NA, NA, No, Yes, NA, NA, Yes, NA, No, No, No, NA, …
## $ edu_cat             &lt;fct&gt; College+, College+, College+, College+, High schoo…
## $ marital_cat         &lt;fct&gt; Married/Partnered, Not married, Married/Partnered,…
## $ race_cat            &lt;fct&gt; White, White, White, White, White, White, White, W…
## $ state_t0            &lt;fct&gt; A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A,…
## $ state_t12           &lt;fct&gt; D, F, A, A, F, F, A, D, F, A, A, D, A, A, F, A, F,…
## $ state_t24           &lt;fct&gt; D, F, F, A, D, F, D, D, A, F, F, D, A, A, F, A, F,…
## $ missing12           &lt;dbl&gt; 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1,…
## $ missing24           &lt;dbl&gt; 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 1,…
## $ sitetype2           &lt;fct&gt; Community, Unknown, Unknown, Community, Academic, …</code></pre>
</div>
<div id="select-andvariable-of-interest" class="section level3">
<h3><em>3. Select andvariable of interest</em></h3>
<pre class="r"><code>vars &lt;- c(&quot;patref&quot;,&quot;state_t0&quot;,&quot;state_t12&quot;,&quot;state_t24&quot;,
          &quot;age&quot;,&quot;sex&quot;,&quot;ecogps&quot;,&quot;fact_bl&quot;,&quot;hads_pt_anx_bl&quot;,&quot;hads_pt_dep_bl&quot;,
          &quot;tumrtyp&quot;,&quot;arm&quot;,&quot;edu_cat&quot;,&quot;marital_cat&quot;,&quot;race_cat&quot;, &quot;cgpart&quot;)

data_main_clean &lt;- data_main_clean[, vars] 


# Sauvegarde du jeu de données prêt
#write.csv(data_main_clean, file.path(output_dir, &quot;data_main_clean.csv&quot;), row.names = FALSE)</code></pre>
</div>
<div
id="missingness-patterns-among-baseline-predictor-for-the-model-multi-state"
class="section level3">
<h3><em>4. Missingness patterns among baseline predictor for the model
multi state</em></h3>
<pre class="r"><code>missing_pct &lt;- sapply(data_main_clean, function(x) mean(is.na(x)) * 100)
missing_table &lt;- data.frame(
  Variable = names(missing_pct),
  Missing_Percent = round(missing_pct, 2)
) %&gt;% arrange(desc(Missing_Percent))

kbl(missing_table, caption = &quot;Missingness Percentage by Variable&quot;, row.names = FALSE) %&gt;%
  kable_classic(full_width = FALSE)</code></pre>
<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Missingness Percentage by Variable
</caption>
<thead>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:right;">
Missing_Percent
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
race_cat
</td>
<td style="text-align:right;">
4.55
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_cat
</td>
<td style="text-align:right;">
3.69
</td>
</tr>
<tr>
<td style="text-align:left;">
marital_cat
</td>
<td style="text-align:right;">
1.99
</td>
</tr>
<tr>
<td style="text-align:left;">
patref
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
state_t0
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
state_t12
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
state_t24
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
sex
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
arm
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpart
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>write.csv(missing_table, file.path(output_dir, &quot;missingness_patterns.csv&quot;), row.names = FALSE)</code></pre>
</div>
<div id="delete-lines-with-na-in-race-and-education"
class="section level3">
<h3>*5. Delete lines with NA in race and education</h3>
<pre class="r"><code># Remove rows with missing values in specific variables
data_main_clean &lt;- data_main_clean[!is.na(data_main_clean$edu_cat) &amp;
                                   !is.na(data_main_clean$race_cat) &amp;
                                   !is.na(data_main_clean$marital_cat), ]

glimpse(data_main_clean)</code></pre>
<pre><code>## Rows: 319
## Columns: 16
## $ patref         &lt;int&gt; 9103597, 9103612, 9103621, 9103631, 9103689, 9103736, 9…
## $ state_t0       &lt;fct&gt; A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A, A…
## $ state_t12      &lt;fct&gt; D, F, A, A, F, F, A, D, F, A, A, D, A, F, A, F, A, A, A…
## $ state_t24      &lt;fct&gt; D, F, F, A, D, F, D, D, A, F, F, D, A, F, A, F, A, A, D…
## $ age            &lt;dbl&gt; 56, 71, 86, 64, 54, 55, 69, 75, 40, 61, 85, 59, 62, 61,…
## $ sex            &lt;fct&gt; f, m, m, m, f, f, f, f, f, f, m, f, m, m, m, m, m, f, m…
## $ ecogps         &lt;int&gt; 0, 1, 1, 0, 1, 1, 2, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 2, 1…
## $ fact_bl        &lt;dbl&gt; 90.000, 97.333, 81.000, 90.000, 73.167, 62.000, 65.000,…
## $ hads_pt_anx_bl &lt;int&gt; 7, 0, 8, 5, 5, 16, 8, 6, 13, 1, 4, 9, 9, 4, 9, 6, 1, 6,…
## $ hads_pt_dep_bl &lt;int&gt; 0, 0, 11, 1, 7, 13, 4, 10, 9, 1, 3, 7, 5, 1, 2, 5, 2, 7…
## $ tumrtyp        &lt;fct&gt; Lung, Lung, Lung, Hepatic/Biliary/Pancreatic/Unknown pr…
## $ arm            &lt;fct&gt; 1, 2, 2, 1, 1, 2, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 2, 1, 1…
## $ edu_cat        &lt;fct&gt; College+, College+, College+, College+, High school, Co…
## $ marital_cat    &lt;fct&gt; Married/Partnered, Not married, Married/Partnered, Marr…
## $ race_cat       &lt;fct&gt; White, White, White, White, White, White, White, White,…
## $ cgpart         &lt;fct&gt; No, No, Yes, Yes, Yes, Yes, Yes, Yes, No, Yes, Yes, Yes…</code></pre>
</div>
<div
id="transitions-t0t12-all-start-in-a-multinomial-regression-for-outcome-a-f-d."
class="section level3">
<h3><em>6. Transitions T0→T12 (all start in A): multinomial regression
for outcome {A, F, D}.</em></h3>
</div>
<div id="a.-transitions-t0t12" class="section level3">
<h3><em>6a. Transitions T0→T12</em></h3>
<pre class="r"><code># State codification Standardisation

data_main_clean$state_t12 &lt;- factor(data_main_clean$state_t12, levels = c(&quot;A&quot;,&quot;F&quot;,&quot;D&quot;))
data_main_clean$state_t24 &lt;- factor(data_main_clean$state_t24, levels = c(&quot;A&quot;,&quot;F&quot;,&quot;D&quot;))

# Fonctions to diplay result
mk_results_table &lt;- function(fit, transition_name, alpha = 0.05){
  summ &lt;- summary(fit)
  coefs &lt;- summ$coefficients
  ses   &lt;- summ$standard.errors
  zvals &lt;- coefs / ses
  pvals &lt;- 2 * (1 - pnorm(abs(zvals)))

  out &lt;- map_dfr(seq_len(nrow(coefs)), function(i){
    data.frame(
      Transition = transition_name,
      Outcome = rownames(coefs)[i],
      Variable = colnames(coefs),
      OR = exp(coefs[i,]),
      CI_low = exp(coefs[i,] - 1.96 * ses[i,]),
      CI_high = exp(coefs[i,] + 1.96 * ses[i,]),
      p_value = pvals[i,],
      Signif = ifelse(pvals[i,] &lt; alpha, &quot;*&quot;, &quot;&quot;)
    )
  }) %&gt;%
    mutate(across(c(OR, CI_low, CI_high), round, 2),
           p_value = signif(p_value, 3))
  return(out)
}

# LASSO -&gt; T0→T12
preds_t0_t12 &lt;- c(&quot;age&quot;,&quot;sex&quot;,&quot;ecogps&quot;,&quot;fact_bl&quot;,&quot;hads_pt_anx_bl&quot;,&quot;hads_pt_dep_bl&quot;,
                  &quot;tumrtyp&quot;,&quot;arm&quot;,&quot;edu_cat&quot;,&quot;cgpart&quot;)

X_t0_t12 &lt;- model.matrix(~ . , data = data_main_clean[, preds_t0_t12])
y_t0_t12 &lt;- data_main_clean$state_t12

cvfit_t0_t12 &lt;- cv.glmnet(X_t0_t12, y_t0_t12, family = &quot;multinomial&quot;, alpha = 1)
coefs_list &lt;- coef(cvfit_t0_t12, s = &quot;lambda.min&quot;)

nz_vars &lt;- unique(unlist(lapply(coefs_list, function(m) rownames(m)[as.numeric(m)!=0])))
nz_vars &lt;- setdiff(nz_vars, &quot;(Intercept)&quot;)
selected_preds_t0_t12 &lt;- preds_t0_t12[sapply(preds_t0_t12, function(p) any(grepl(p, nz_vars)))]

fit_multi_t0_t12 &lt;- multinom(reformulate(selected_preds_t0_t12, &quot;state_t12&quot;),
                             data = data_main_clean, trace = FALSE)
results_t0_t12 &lt;- mk_results_table(fit_multi_t0_t12, &quot;T0→T12&quot;)</code></pre>
</div>
<div id="b.-transitions-t12t24" class="section level3">
<h3><em>6b. Transitions T12→T24</em></h3>
<p>Subgroup A at T12 → multinomial regression {A, F, D}</p>
<p>Subgroup F at T12 → multinomial regression {A, F, D}</p>
<pre class="r"><code># Ridge -&gt; T12→T24 (A and F separately)
preds_t12_t24 &lt;- c(&quot;age&quot;,&quot;sex&quot;,&quot;ecogps&quot;,&quot;fact_bl&quot;,&quot;hads_pt_anx_bl&quot;,&quot;tumrtyp&quot;,&quot;arm&quot;)

# A subset
df_A &lt;- subset(data_main_clean, state_t12 == &quot;A&quot;)
X_A &lt;- model.matrix(~ . -1, data = df_A[, preds_t12_t24])
y_A &lt;- df_A$state_t24

cvfit_A &lt;- cv.glmnet(X_A, y_A, family = &quot;multinomial&quot;, alpha = 0)
coefs_A &lt;- coef(cvfit_A, s = &quot;lambda.min&quot;)
nz_vars_A &lt;- unique(unlist(lapply(coefs_A, function(m) rownames(m)[as.numeric(m)!=0])))
nz_vars_A &lt;- setdiff(nz_vars_A, &quot;(Intercept)&quot;)
selected_preds_A &lt;- preds_t12_t24[sapply(preds_t12_t24, function(p) any(grepl(p, nz_vars_A)))]

fit_multi_A &lt;- multinom(reformulate(selected_preds_A, &quot;state_t24&quot;), data = df_A, trace = FALSE)
results_t12_t24_A &lt;- mk_results_table(fit_multi_A, &quot;T12→T24 (A only)&quot;)

# F subset
df_F &lt;- subset(data_main_clean, state_t12 == &quot;F&quot;)
X_F &lt;- model.matrix(~ . -1, data = df_F[, preds_t12_t24])
y_F &lt;- df_F$state_t24

cvfit_F &lt;- cv.glmnet(X_F, y_F, family = &quot;multinomial&quot;, alpha = 0)
coefs_F &lt;- coef(cvfit_F, s = &quot;lambda.min&quot;)
nz_vars_F &lt;- unique(unlist(lapply(coefs_F, function(m) rownames(m)[as.numeric(m)!=0])))
nz_vars_F &lt;- setdiff(nz_vars_F, &quot;(Intercept)&quot;)
selected_preds_F &lt;- preds_t12_t24[sapply(preds_t12_t24, function(p) any(grepl(p, nz_vars_F)))]

fit_multi_F &lt;- multinom(reformulate(selected_preds_F, &quot;state_t24&quot;), data = df_F, trace = FALSE)
results_t12_t24_F &lt;- mk_results_table(fit_multi_F, &quot;T12→T24 (F only)&quot;)</code></pre>
</div>
<div id="c.-result-transitions-t0t12-t12t24" class="section level3">
<h3><em>6c. Result Transitions T0→T12, T12→T24</em></h3>
<pre class="r"><code># Combine and export
results_all &lt;- bind_rows(results_t0_t12, results_t12_t24_A, results_t12_t24_F)
write.csv(results_all, file.path(output_dir, &quot;multinom_results.csv&quot;), row.names = FALSE)

results_all %&gt;%
  kbl(caption = &quot;Multinomial Logistic Regression Results (with OR, 95% CI, p-value)&quot;, row.names = FALSE) %&gt;%
  kable_styling(full_width = FALSE, bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;))</code></pre>
<table class="table table-striped table-hover" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Multinomial Logistic Regression Results (with OR, 95% CI, p-value)
</caption>
<thead>
<tr>
<th style="text-align:left;">
Transition
</th>
<th style="text-align:left;">
Outcome
</th>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:right;">
OR
</th>
<th style="text-align:right;">
CI_low
</th>
<th style="text-align:right;">
CI_high
</th>
<th style="text-align:right;">
p_value
</th>
<th style="text-align:left;">
Signif
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
7.050000e+00
</td>
<td style="text-align:right;">
0.50100
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
0.97
</td>
<td style="text-align:right;">
1.030000e+00
</td>
<td style="text-align:right;">
0.98800
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
0.84
</td>
<td style="text-align:right;">
0.49
</td>
<td style="text-align:right;">
1.460000e+00
</td>
<td style="text-align:right;">
0.54000
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
0.62
</td>
<td style="text-align:right;">
1.600000e+00
</td>
<td style="text-align:right;">
0.98400
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
0.98
</td>
<td style="text-align:right;">
1.030000e+00
</td>
<td style="text-align:right;">
0.87400
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
1.07
</td>
<td style="text-align:right;">
0.97
</td>
<td style="text-align:right;">
1.190000e+00
</td>
<td style="text-align:right;">
0.17400
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
0.99
</td>
<td style="text-align:right;">
0.89
</td>
<td style="text-align:right;">
1.100000e+00
</td>
<td style="text-align:right;">
0.81700
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
1.04
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
3.020000e+00
</td>
<td style="text-align:right;">
0.94600
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
0.65
</td>
<td style="text-align:right;">
0.23
</td>
<td style="text-align:right;">
1.790000e+00
</td>
<td style="text-align:right;">
0.40100
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
2.07
</td>
<td style="text-align:right;">
1.16
</td>
<td style="text-align:right;">
3.690000e+00
</td>
<td style="text-align:right;">
0.01380
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
3.26
</td>
<td style="text-align:right;">
1.31
</td>
<td style="text-align:right;">
8.120000e+00
</td>
<td style="text-align:right;">
0.01130
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
0.57
</td>
<td style="text-align:right;">
0.32
</td>
<td style="text-align:right;">
1.010000e+00
</td>
<td style="text-align:right;">
0.05310
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.450000e+00
</td>
<td style="text-align:right;">
0.07840
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
1.05
</td>
<td style="text-align:right;">
1.01
</td>
<td style="text-align:right;">
1.090000e+00
</td>
<td style="text-align:right;">
0.01020
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
0.73
</td>
<td style="text-align:right;">
0.37
</td>
<td style="text-align:right;">
1.440000e+00
</td>
<td style="text-align:right;">
0.36000
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
2.37
</td>
<td style="text-align:right;">
1.31
</td>
<td style="text-align:right;">
4.290000e+00
</td>
<td style="text-align:right;">
0.00424
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.98
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.010000e+00
</td>
<td style="text-align:right;">
0.12600
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.89
</td>
<td style="text-align:right;">
0.79
</td>
<td style="text-align:right;">
1.010000e+00
</td>
<td style="text-align:right;">
0.07510
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:right;">
1.14
</td>
<td style="text-align:right;">
1.02
</td>
<td style="text-align:right;">
1.280000e+00
</td>
<td style="text-align:right;">
0.02700
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
1.39
</td>
<td style="text-align:right;">
0.32
</td>
<td style="text-align:right;">
5.940000e+00
</td>
<td style="text-align:right;">
0.65800
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
0.60
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
2.500000e+00
</td>
<td style="text-align:right;">
0.48000
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
edu_catHigh school
</td>
<td style="text-align:right;">
1.55
</td>
<td style="text-align:right;">
0.75
</td>
<td style="text-align:right;">
3.220000e+00
</td>
<td style="text-align:right;">
0.23700
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
edu_catLow
</td>
<td style="text-align:right;">
0.84
</td>
<td style="text-align:right;">
0.23
</td>
<td style="text-align:right;">
3.030000e+00
</td>
<td style="text-align:right;">
0.78700
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T0→T12
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
cgpartYes
</td>
<td style="text-align:right;">
0.73
</td>
<td style="text-align:right;">
0.35
</td>
<td style="text-align:right;">
1.540000e+00
</td>
<td style="text-align:right;">
0.41100
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:right;">
2.15
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
1.086600e+02
</td>
<td style="text-align:right;">
0.70300
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.99
</td>
<td style="text-align:right;">
0.96
</td>
<td style="text-align:right;">
1.030000e+00
</td>
<td style="text-align:right;">
0.68200
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
1.14
</td>
<td style="text-align:right;">
0.53
</td>
<td style="text-align:right;">
2.440000e+00
</td>
<td style="text-align:right;">
0.73100
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
1.55
</td>
<td style="text-align:right;">
0.80
</td>
<td style="text-align:right;">
3.000000e+00
</td>
<td style="text-align:right;">
0.19300
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.99
</td>
<td style="text-align:right;">
0.97
</td>
<td style="text-align:right;">
1.020000e+00
</td>
<td style="text-align:right;">
0.66400
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.91
</td>
<td style="text-align:right;">
0.79
</td>
<td style="text-align:right;">
1.050000e+00
</td>
<td style="text-align:right;">
0.19100
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
0.51
</td>
<td style="text-align:right;">
0.10
</td>
<td style="text-align:right;">
2.490000e+00
</td>
<td style="text-align:right;">
0.40400
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
0.62
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
2.780000e+00
</td>
<td style="text-align:right;">
0.53100
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
0.73
</td>
<td style="text-align:right;">
0.34
</td>
<td style="text-align:right;">
1.540000e+00
</td>
<td style="text-align:right;">
0.40700
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:right;">
15.49
</td>
<td style="text-align:right;">
0.12
</td>
<td style="text-align:right;">
1.924840e+03
</td>
<td style="text-align:right;">
0.26500
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
1.050000e+00
</td>
<td style="text-align:right;">
0.90800
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
0.86
</td>
<td style="text-align:right;">
0.31
</td>
<td style="text-align:right;">
2.350000e+00
</td>
<td style="text-align:right;">
0.76400
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
1.57
</td>
<td style="text-align:right;">
0.64
</td>
<td style="text-align:right;">
3.860000e+00
</td>
<td style="text-align:right;">
0.32800
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.98
</td>
<td style="text-align:right;">
0.94
</td>
<td style="text-align:right;">
1.020000e+00
</td>
<td style="text-align:right;">
0.33900
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.80
</td>
<td style="text-align:right;">
0.66
</td>
<td style="text-align:right;">
9.800000e-01
</td>
<td style="text-align:right;">
0.02920
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
5.500000e-01
</td>
<td style="text-align:right;">
0.01060
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
0.24
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
1.070000e+00
</td>
<td style="text-align:right;">
0.06170
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (A only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
0.63
</td>
<td style="text-align:right;">
0.23
</td>
<td style="text-align:right;">
1.730000e+00
</td>
<td style="text-align:right;">
0.37200
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:right;">
19577684.44
</td>
<td style="text-align:right;">
181797.09
</td>
<td style="text-align:right;">
2.108316e+09
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.98
</td>
<td style="text-align:right;">
0.92
</td>
<td style="text-align:right;">
1.050000e+00
</td>
<td style="text-align:right;">
0.61900
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
3.05
</td>
<td style="text-align:right;">
0.89
</td>
<td style="text-align:right;">
1.047000e+01
</td>
<td style="text-align:right;">
0.07630
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
1.27
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
4.430000e+00
</td>
<td style="text-align:right;">
0.70800
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.97
</td>
<td style="text-align:right;">
0.92
</td>
<td style="text-align:right;">
1.020000e+00
</td>
<td style="text-align:right;">
0.27300
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.94
</td>
<td style="text-align:right;">
0.78
</td>
<td style="text-align:right;">
1.130000e+00
</td>
<td style="text-align:right;">
0.49800
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.000000e+00
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.000000e+00
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
0.77
</td>
<td style="text-align:right;">
0.23
</td>
<td style="text-align:right;">
2.560000e+00
</td>
<td style="text-align:right;">
0.66600
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:right;">
279229052.93
</td>
<td style="text-align:right;">
1162210.21
</td>
<td style="text-align:right;">
6.708671e+10
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0.96
</td>
<td style="text-align:right;">
0.89
</td>
<td style="text-align:right;">
1.030000e+00
</td>
<td style="text-align:right;">
0.23900
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
sexm
</td>
<td style="text-align:right;">
3.05
</td>
<td style="text-align:right;">
0.76
</td>
<td style="text-align:right;">
1.222000e+01
</td>
<td style="text-align:right;">
0.11500
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:right;">
1.12
</td>
<td style="text-align:right;">
0.28
</td>
<td style="text-align:right;">
4.470000e+00
</td>
<td style="text-align:right;">
0.86900
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:right;">
0.95
</td>
<td style="text-align:right;">
0.90
</td>
<td style="text-align:right;">
1.010000e+00
</td>
<td style="text-align:right;">
0.07500
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:right;">
0.89
</td>
<td style="text-align:right;">
0.71
</td>
<td style="text-align:right;">
1.100000e+00
</td>
<td style="text-align:right;">
0.27800
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
tumrtypHepatic/Biliary/Pancreatic/Unknown primary
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.000000e+00
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
tumrtypLung
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.000000e+00
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:left;">
<ul>
<li></td>
</tr>
<tr>
<td style="text-align:left;">
T12→T24 (F only)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:left;">
arm2
</td>
<td style="text-align:right;">
1.10
</td>
<td style="text-align:right;">
0.28
</td>
<td style="text-align:right;">
4.370000e+00
</td>
<td style="text-align:right;">
0.89200
</td>
<td style="text-align:left;">
</td>
</tr>
</tbody>
</table></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="average-marginal-effects-ame" class="section level3">
<h3><em>7. Average Marginal Effects (AME)</em></h3>
<pre class="r"><code># ==========================================================
# Purpose: Estimate and visualize the average marginal effects
#          of covariates on state transition probabilities
# ==========================================================

# ---- Load required packages ----
library(dplyr)
library(ggplot2)
library(stringr)
library(kableExtra)

# ---- Define AME function (continuous + categorical) ----
ame_multinom &lt;- function(fit, data, cont_vars = NULL, factor_vars = NULL, delta = 1){
  # Compute predicted probabilities for each observation
  classes &lt;- colnames(predict(fit, newdata = data, type = &quot;probs&quot;))
  base_pred &lt;- as.matrix(predict(fit, newdata = data, type = &quot;probs&quot;))
  
  # ---- Continuous variables ----
  ame_cont &lt;- list()
  if(!is.null(cont_vars)){
    for(v in cont_vars){
      d_cf &lt;- data
      d_cf[[v]] &lt;- d_cf[[v]] + delta
      cf_pred &lt;- as.matrix(predict(fit, newdata = d_cf, type = &quot;probs&quot;))
      diff &lt;- (cf_pred - base_pred) / delta
      ame_v &lt;- colMeans(diff, na.rm = TRUE)
      ame_cont[[v]] &lt;- data.frame(Variable = v, Outcome = classes, AME = as.numeric(ame_v))
    }
  }
  ame_cont &lt;- if(length(ame_cont)) bind_rows(ame_cont) else NULL
  
  # ---- Categorical variables ----
  ame_fact &lt;- list()
  if(!is.null(factor_vars)){
    for(v in factor_vars){
      levs &lt;- levels(data[[v]])
      ref &lt;- levs[1]
      for(lv in levs[-1]){
        d_ref &lt;- data; d_ref[[v]] &lt;- factor(ref, levels = levs)
        d_lv  &lt;- data; d_lv[[v]]  &lt;- factor(lv, levels = levs)
        p_ref &lt;- as.matrix(predict(fit, newdata = d_ref, type = &quot;probs&quot;))
        p_lv  &lt;- as.matrix(predict(fit, newdata = d_lv,  type = &quot;probs&quot;))
        diff  &lt;- p_lv - p_ref
        ame_v &lt;- colMeans(diff, na.rm = TRUE)
        ame_fact[[paste(v, lv, sep = &quot;:&quot;)]] &lt;- data.frame(
          Variable = paste0(v, &quot; (&quot;, lv, &quot; vs &quot;, ref, &quot;)&quot;),
          Outcome  = classes,
          AME      = as.numeric(ame_v)
        )
      }
    }
  }
  ame_fact &lt;- if(length(ame_fact)) bind_rows(ame_fact) else NULL
  
  bind_rows(ame_cont, ame_fact)
}

# ---- Define variables ----
cont_vars_t0_t12 &lt;- intersect(selected_preds_t0_t12, c(&quot;age&quot;,&quot;ecogps&quot;,&quot;fact_bl&quot;,&quot;hads_pt_anx_bl&quot;,&quot;hads_pt_dep_bl&quot;))
factor_vars_t0_t12 &lt;- intersect(selected_preds_t0_t12, c(&quot;sex&quot;,&quot;tumrtyp&quot;,&quot;arm&quot;,&quot;edu_cat&quot;,&quot;cgpart&quot;))

cont_vars_A &lt;- intersect(selected_preds_A, c(&quot;age&quot;,&quot;ecogps&quot;,&quot;fact_bl&quot;,&quot;hads_pt_anx_bl&quot;,&quot;hads_pt_dep_bl&quot;))
factor_vars_A &lt;- intersect(selected_preds_A, c(&quot;sex&quot;,&quot;tumrtyp&quot;,&quot;arm&quot;))

# ---- Compute AMEs for both transitions ----
ame_t0_t12 &lt;- ame_multinom(fit_multi_t0_t12, data_main_clean, cont_vars_t0_t12, factor_vars_t0_t12)
ame_t12_t24 &lt;- ame_multinom(fit_multi_A, df_A, cont_vars_A, factor_vars_A)

# ---- Export AME results ----
write.csv(ame_t0_t12, &quot;output_multistate/AME_T0_T12.csv&quot;, row.names = FALSE)
write.csv(ame_t12_t24, &quot;output_multistate/AME_T12_T24.csv&quot;, row.names = FALSE)</code></pre>
<pre class="r"><code># ==========================================================
# 6. Visualization of AME results (with titles)
# ==========================================================
# Purpose: Display and export AME tables and plots
# ==========================================================

# ---- Define plotting function ----
plot_ame &lt;- function(ame_df, title = &quot;Average Marginal Effects&quot;){
  ame_df &lt;- ame_df %&gt;% mutate(Variable = str_wrap(Variable, width = 40))
  ggplot(ame_df, aes(x = Variable, y = AME, fill = Outcome)) +
    geom_col(position = &quot;dodge&quot;) +
    coord_flip() +
    labs(title = title,
         x = &quot;Covariates&quot;,
         y = &quot;AME (change in predicted probability)&quot;) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = &quot;bold&quot;, hjust = 0.5, size = 14),
      axis.text.y = element_text(angle = 0, hjust = 1, size = 10)
    )
}

# ---- Display formatted tables ----
# T0 → T12
ame_t0_t12 %&gt;%
  kable(&quot;html&quot;, caption = &quot;Average Marginal Effects (T0 → T12)&quot;, row.names = FALSE) %&gt;%
  kable_styling(full_width = FALSE, bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;)) %&gt;%
  column_spec(3, color = ifelse(ame_t0_t12$AME &gt; 0, &quot;blue&quot;, &quot;red&quot;))</code></pre>
<table class="table table-striped table-hover" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Average Marginal Effects (T0 → T12)
</caption>
<thead>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Outcome
</th>
<th style="text-align:right;">
AME
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.0039479
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0019385
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: blue !important;">
0.0058864
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.0818726
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0418247
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: blue !important;">
0.1236972
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.0015707
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: blue !important;">
0.0013029
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0028736
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.0016835
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: blue !important;">
0.0176308
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0159473
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.0090357
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0075950
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_dep_bl
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: blue !important;">
0.0166307
</td>
</tr>
<tr>
<td style="text-align:left;">
sex (m vs f)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.0500690
</td>
</tr>
<tr>
<td style="text-align:left;">
sex (m vs f)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0188364
</td>
</tr>
<tr>
<td style="text-align:left;">
sex (m vs f)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0312326
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Hepatic/Biliary/Pancreatic/Unknown primary vs
Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.0325429
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Hepatic/Biliary/Pancreatic/Unknown primary vs
Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0098174
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Hepatic/Biliary/Pancreatic/Unknown primary vs
Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: blue !important;">
0.0423603
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Lung vs Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.1037935
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Lung vs Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0613217
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Lung vs Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0424718
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_cat (High school vs College+)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.1397043
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_cat (High school vs College+)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: blue !important;">
0.1141851
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_cat (High school vs College+)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: blue !important;">
0.0255192
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_cat (Low vs College+)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.1829959
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_cat (Low vs College+)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: blue !important;">
0.2440861
</td>
</tr>
<tr>
<td style="text-align:left;">
edu_cat (Low vs College+)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0610902
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpart (Yes vs No)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.1085927
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpart (Yes vs No)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0956002
</td>
</tr>
<tr>
<td style="text-align:left;">
cgpart (Yes vs No)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0129925
</td>
</tr>
</tbody>
</table>
<pre class="r"><code># T12 → T24
ame_t12_t24 %&gt;%
  kable(&quot;html&quot;, caption = &quot;Average Marginal Effects (T12 → T24)&quot;, row.names = FALSE) %&gt;%
  kable_styling(full_width = FALSE, bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;)) %&gt;%
  column_spec(3, color = ifelse(ame_t12_t24$AME &gt; 0, &quot;blue&quot;, &quot;red&quot;))</code></pre>
<table class="table table-striped table-hover" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Average Marginal Effects (T12 → T24)
</caption>
<thead>
<tr>
<th style="text-align:left;">
Variable
</th>
<th style="text-align:left;">
Outcome
</th>
<th style="text-align:right;">
AME
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.0013152
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0012628
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0000525
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.0972642
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: blue !important;">
0.0655562
</td>
</tr>
<tr>
<td style="text-align:left;">
ecogps
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: blue !important;">
0.0317081
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.0021842
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0005448
</td>
</tr>
<tr>
<td style="text-align:left;">
fact_bl
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0016394
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.0274111
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0102603
</td>
</tr>
<tr>
<td style="text-align:left;">
hads_pt_anx_bl
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0171508
</td>
</tr>
<tr>
<td style="text-align:left;">
sex (m vs f)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: red !important;">
-0.0082023
</td>
</tr>
<tr>
<td style="text-align:left;">
sex (m vs f)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: blue !important;">
0.0269971
</td>
</tr>
<tr>
<td style="text-align:left;">
sex (m vs f)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0187949
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Hepatic/Biliary/Pancreatic/Unknown primary vs
Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.2974248
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Hepatic/Biliary/Pancreatic/Unknown primary vs
Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0209240
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Hepatic/Biliary/Pancreatic/Unknown primary vs
Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.2765008
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Lung vs Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.2102443
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Lung vs Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0098862
</td>
</tr>
<tr>
<td style="text-align:left;">
tumrtyp (Lung vs Esophageal/GEJ/Gastric)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.2003581
</td>
</tr>
<tr>
<td style="text-align:left;">
arm (2 vs 1)
</td>
<td style="text-align:left;">
A
</td>
<td style="text-align:right;color: blue !important;">
0.0759549
</td>
</tr>
<tr>
<td style="text-align:left;">
arm (2 vs 1)
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;color: red !important;">
-0.0410566
</td>
</tr>
<tr>
<td style="text-align:left;">
arm (2 vs 1)
</td>
<td style="text-align:left;">
D
</td>
<td style="text-align:right;color: red !important;">
-0.0348983
</td>
</tr>
</tbody>
</table>
<pre class="r"><code># ---- Generate plots ----
p1 &lt;- plot_ame(ame_t0_t12, title = &quot;AMEs for T0 → T12 transitions&quot;)
p2 &lt;- plot_ame(ame_t12_t24, title = &quot;AMEs for T12 → T24 transitions (vs A)&quot;)

# ---- Display both plots in Markdown output ----
cat(&quot;\n\n### AME plot for T0 → T12 transitions\n&quot;)</code></pre>
<pre><code>## 
## 
## ### AME plot for T0 → T12 transitions</code></pre>
<pre class="r"><code>print(p1)</code></pre>
<p><img src="02_multistate_modeling_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<pre class="r"><code>cat(&quot;\n\n### AME plot for T12 → T24 transitions\n&quot;)</code></pre>
<pre><code>## 
## 
## ### AME plot for T12 → T24 transitions</code></pre>
<pre class="r"><code>print(p2)</code></pre>
<p><img src="02_multistate_modeling_files/figure-html/unnamed-chunk-9-2.png" width="672" /></p>
<pre class="r"><code># ---- Save high-resolution images ----
ggsave(&quot;output_multistate/plot_AME_T0_T12.png&quot;, plot = p1, width = 9, height = 6, dpi = 300)
ggsave(&quot;output_multistate/plot_AME_T12_T24.png&quot;, plot = p2, width = 9, height = 6, dpi = 300)</code></pre>
</div>
<div id="clinical-profile-simulations-illustrative-scenarios"
class="section level3">
<h3><em>7. Clinical Profile Simulations (Illustrative
Scenarios)</em></h3>
<pre class="r"><code># ==========================================================
# Purpose: Estimate transition probabilities for typical
#          clinical profiles (T0→T12 and T12→T24)
# ==========================================================

library(dplyr)
library(knitr)
library(kableExtra)

# ----------------------------------------------------------
# Define clinical profiles for T0 → T12
# ----------------------------------------------------------
profiles_t0_t12 &lt;- tribble(
  ~age, ~sex, ~ecogps, ~fact_bl, ~hads_pt_anx_bl, ~hads_pt_dep_bl, ~tumrtyp, ~arm, ~edu_cat, ~cgpart,
  45, &quot;f&quot;, 0, 85, 3, 2, &quot;Esophageal/GEJ/Gastric&quot;, &quot;1&quot;, &quot;College+&quot;, &quot;Yes&quot;,
  45, &quot;f&quot;, 0, 85, 12, 6, &quot;Esophageal/GEJ/Gastric&quot;, &quot;1&quot;, &quot;College+&quot;, &quot;Yes&quot;,
  75, &quot;m&quot;, 2, 60, 3, 2, &quot;Hepatic/Biliary/Pancreatic/Unknown primary&quot;, &quot;2&quot;, &quot;Low&quot;, &quot;Yes&quot;,
  75, &quot;m&quot;, 2, 60, 12, 10, &quot;Hepatic/Biliary/Pancreatic/Unknown primary&quot;, &quot;2&quot;, &quot;Low&quot;, &quot;Yes&quot;,
  45, &quot;f&quot;, 0, 85, 3, 2, &quot;Esophageal/GEJ/Gastric&quot;, &quot;1&quot;, &quot;College+&quot;, &quot;No&quot;,
  45, &quot;f&quot;, 0, 85, 12, 6, &quot;Esophageal/GEJ/Gastric&quot;, &quot;1&quot;, &quot;College+&quot;, &quot;No&quot;,
  75, &quot;m&quot;, 2, 60, 3, 2, &quot;Hepatic/Biliary/Pancreatic/Unknown primary&quot;, &quot;2&quot;, &quot;Low&quot;, &quot;No&quot;,
  75, &quot;m&quot;, 2, 60, 12, 10, &quot;Hepatic/Biliary/Pancreatic/Unknown primary&quot;, &quot;2&quot;, &quot;Low&quot;, &quot;No&quot;
) %&gt;%
  mutate(
    across(c(sex, tumrtyp, arm, edu_cat, cgpart), as.character),
    across(c(age, ecogps, fact_bl, hads_pt_anx_bl, hads_pt_dep_bl), as.numeric),
    label = paste(
      ifelse(age &lt; 60, &quot;Young fit&quot;, &quot;Old fragile&quot;),
      ifelse(hads_pt_anx_bl &lt;= 6, &quot;low anxiety&quot;, &quot;high anxiety&quot;),
      ifelse(cgpart == &quot;Yes&quot;, &quot;caregiver&quot;, &quot;no caregiver&quot;),
      tumrtyp,
      edu_cat,
      sep = &quot;, &quot;
    )
  )

# ----------------------------------------------------------
# Define clinical profiles for T12 → T24
# ----------------------------------------------------------
profiles_t12_t24 &lt;- tribble(
  ~label, ~age, ~sex, ~ecogps, ~fact_bl, ~hads_pt_anx_bl, ~tumrtyp, ~arm,
  &quot;Young fit, high anxiety, Esophageal/GEJ, Arm1&quot;, 45, &quot;f&quot;, 0, 85, 12, &quot;Esophageal/GEJ/Gastric&quot;, &quot;1&quot;,
  &quot;Young fit, low anxiety, Lung, Arm1&quot;, 45, &quot;m&quot;, 0, 80, 3, &quot;Lung&quot;, &quot;1&quot;,
  &quot;Young fit, high anxiety, Lung, Arm1&quot;, 45, &quot;m&quot;, 0, 80, 12, &quot;Lung&quot;, &quot;1&quot;,
  &quot;Old fragile, low anxiety, Hepatic/Biliary, Arm2&quot;, 75, &quot;m&quot;, 2, 60, 3, &quot;Hepatic/Biliary/Pancreatic/Unknown primary&quot;, &quot;2&quot;,
  &quot;Old fragile, high anxiety, Hepatic/Biliary, Arm2&quot;, 75, &quot;m&quot;, 2, 60, 12, &quot;Hepatic/Biliary/Pancreatic/Unknown primary&quot;, &quot;2&quot;,
  &quot;Old fragile, low anxiety, Lung, Arm2&quot;, 75, &quot;f&quot;, 2, 65, 3, &quot;Lung&quot;, &quot;2&quot;,
  &quot;Old fragile, high anxiety, Lung, Arm2&quot;, 75, &quot;f&quot;, 2, 65, 12, &quot;Lung&quot;, &quot;2&quot;
) %&gt;%
  mutate(across(c(sex, tumrtyp, arm), as.character))

# ----------------------------------------------------------
# Function to predict probabilities for given profiles
# ----------------------------------------------------------
predict_profiles &lt;- function(model, profiles, selected_preds, reference_data){
  for(col in selected_preds){
    if(col %in% names(profiles)){
      if(is.factor(reference_data[[col]]) || is.character(reference_data[[col]])){
        profiles[[col]] &lt;- factor(profiles[[col]], levels = levels(factor(reference_data[[col]])))
      } else {
        profiles[[col]] &lt;- as.numeric(profiles[[col]])
      }
    }
  }
  probs &lt;- predict(model, newdata = profiles, type = &quot;probs&quot;)
  results &lt;- as.data.frame(probs)
  results$label &lt;- profiles$label
  results &lt;- results %&gt;% relocate(label) %&gt;% mutate(across(where(is.numeric), ~round(.x,3)))
  return(results)
}

# ----------------------------------------------------------
# Function to highlight highest probability per row
# ----------------------------------------------------------
highlight_max_prob &lt;- function(df, prob_cols) {
  df %&gt;%
    rowwise() %&gt;%
    mutate(across(all_of(prob_cols),
                  ~cell_spec(.x, &quot;html&quot;,
                             color = ifelse(.x == max(c_across(all_of(prob_cols))), &quot;white&quot;, &quot;black&quot;),
                             background = ifelse(.x == max(c_across(all_of(prob_cols))), &quot;steelblue&quot;, &quot;white&quot;)))) %&gt;%
    ungroup()
}

# ----------------------------------------------------------
# Predictions and table display
# ----------------------------------------------------------

# ---- T0 → T12 ----
res_profiles_t0_t12 &lt;- predict_profiles(fit_multi_t0_t12, profiles_t0_t12, selected_preds_t0_t12, data_main_clean)
res_profiles_t0_t12_colored &lt;- highlight_max_prob(res_profiles_t0_t12, colnames(res_profiles_t0_t12)[-1])

res_profiles_t0_t12_colored %&gt;%
  kable(&quot;html&quot;, escape = FALSE,
        caption = &quot;Predicted Probabilities for T0 → T12 Transitions by Clinical Profile&quot;,
        row.names = FALSE) %&gt;%
  kable_styling(full_width = FALSE, bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;)) %&gt;%
  column_spec(1, bold = TRUE, color = &quot;blue&quot;) %&gt;%
  add_footnote(&quot;Note: Probabilities of being in A, F or D are calculated versus A (Active) in the previous state.&quot;)</code></pre>
<table class="table table-striped table-hover" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Predicted Probabilities for T0 → T12 Transitions by Clinical Profile
</caption>
<thead>
<tr>
<th style="text-align:left;">
label
</th>
<th style="text-align:left;">
A
</th>
<th style="text-align:left;">
F
</th>
<th style="text-align:left;">
D
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Young fit, low anxiety, caregiver, Esophageal/GEJ/Gastric, College+
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.754</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.222</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.024</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Young fit, high anxiety, caregiver, Esophageal/GEJ/Gastric, College+
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.647</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.341</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.012</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Old fragile, low anxiety, caregiver, Hepatic/Biliary/Pancreatic/Unknown
primary, Low
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.336</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.267</span>
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.397</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Old fragile, high anxiety, caregiver, Hepatic/Biliary/Pancreatic/Unknown
primary, Low
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.281</span>
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.38</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.339</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Young fit, low anxiety, no caregiver, Esophageal/GEJ/Gastric, College+
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.64</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.333</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.028</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Young fit, high anxiety, no caregiver, Esophageal/GEJ/Gastric, College+
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.511</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.476</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.013</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Old fragile, low anxiety, no caregiver,
Hepatic/Biliary/Pancreatic/Unknown primary, Low
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.249</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.349</span>
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.402</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Old fragile, high anxiety, no caregiver,
Hepatic/Biliary/Pancreatic/Unknown primary, Low
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.198</span>
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.475</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.327</span>
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; border:0;" colspan="100%">
<sup>a</sup> Note: Probabilities of being in A, F or D are calculated
versus A (Active) in the previous state.
</td>
</tr>
</tfoot>
</table>
<pre class="r"><code># Export table (without formatting)
write.csv(res_profiles_t0_t12, &quot;output_multistate/Profiles_T0_T12.csv&quot;, row.names = FALSE)

# ---- T12 → T24 ----
res_profiles_t12_t24 &lt;- predict_profiles(fit_multi_A, profiles_t12_t24, selected_preds_A, df_A)
res_profiles_t12_t24_colored &lt;- highlight_max_prob(res_profiles_t12_t24, colnames(res_profiles_t12_t24)[-1])

res_profiles_t12_t24_colored %&gt;%
  kable(&quot;html&quot;, escape = FALSE,
        caption = &quot;Predicted Probabilities for T12 → T24 Transitions by Clinical Profile&quot;,
        row.names = FALSE) %&gt;%
  kable_styling(full_width = FALSE, bootstrap_options = c(&quot;striped&quot;, &quot;hover&quot;)) %&gt;%
  column_spec(1, bold = TRUE, color = &quot;blue&quot;) %&gt;%
  add_footnote(&quot;Note: Probabilities of being in A, F or D are calculated versus A (Active) in the previous state.&quot;)</code></pre>
<table class="table table-striped table-hover" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Predicted Probabilities for T12 → T24 Transitions by Clinical Profile
</caption>
<thead>
<tr>
<th style="text-align:left;">
label
</th>
<th style="text-align:left;">
A
</th>
<th style="text-align:left;">
F
</th>
<th style="text-align:left;">
D
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Young fit, high anxiety, Esophageal/GEJ, Arm1
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.679</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.189</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.131</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Young fit, low anxiety, Lung, Arm1
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.56</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.268</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.172</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Young fit, high anxiety, Lung, Arm1
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.802</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.163</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.034</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Old fragile, low anxiety, Hepatic/Biliary, Arm2
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.548</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.339</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.113</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Old fragile, high anxiety, Hepatic/Biliary, Arm2
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.775</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.203</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.022</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Old fragile, low anxiety, Lung, Arm2
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.431</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.275</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.294</span>
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;color: blue !important;">
Old fragile, high anxiety, Lung, Arm2
</td>
<td style="text-align:left;">
<span
style="     color: white !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: steelblue !important;">0.732</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.198</span>
</td>
<td style="text-align:left;">
<span
style="     color: black !important;border-radius: 4px; padding-right: 4px; padding-left: 4px; background-color: white !important;">0.07</span>
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; border:0;" colspan="100%">
<sup>a</sup> Note: Probabilities of being in A, F or D are calculated
versus A (Active) in the previous state.
</td>
</tr>
</tfoot>
</table>
<pre class="r"><code># Export table (without formatting)
write.csv(res_profiles_t12_t24, &quot;output_multistate/Profiles_T12_T24.csv&quot;, row.names = FALSE)</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
