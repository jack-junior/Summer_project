---
title: "Modeling Functional Attrition and Quality-of-Life Dynamics in Oncology: A
  Three-State Multi-State and Predictive Approach (NCT02349412)"
author: "GAYI KOMI SELASSI"
date: "`r Sys.Date()`"
output: html_document
---


```{r message=FALSE, warning=FALSE, echo=FALSE}
# Load necessary libraries
library(tidyverse)
library(ggplot2)
library(psych)
library(knitr)
library(kableExtra)
library(flextable)
library(tibble)
library(DiagrammeR)
library(scales)
library(janitor)
library(networkD3)
library(htmlwidgets)
library(mstate)
library(etm)
library(tidyr)
library(broom)
library(gt)
library(caret)
library(glmnet)
library(pROC)
library(randomForest)
library(xgboost)
library(yardstick)
library(rsample)
library(vip)
library(gtsummary)
library(rms)

```



# 1. Data Preparation

*Import dataset*
```{r echo=FALSE, message=FALSE, warning=FALSE}
data <- read.csv("dataset_merged.csv")
#colnames(data)
```


*Extract variable of interest for our study*
```{r}
data_main <- data[, c(
  
  # Identifiant
  "patref",
  
  # Vital status
  "wk12_dead", "wk24_dead",
  
  # Outcomes (changement scores)
  "fact_chg12", "fact_chg24", 
  "hads_anx_chg12", "hads_dep_chg12",
  
  # Nombre de visites
  "n12", "n12_grp",
  
  # Baseline variables (cliniques, socio-demo)
  "fact_bl", "hads_pt_anx_bl", "hads_pt_dep_bl",
  "age", "sex", "ecogps", "tumrtyp", "cgpart",
  "race1", "ptethncty", "pthighedu", "ptmargstat",
  "ptrelgn", "sitetype", "arm", "bsl_assess_complete",
  
  # Variables psychosociales
  "ptpqpt1_grp", "ptpqpt7_grp", "ptpqpt9e_grp",
  "ptpqpt11_grp", "ptpqpt12_grp"
)]

```


*Assess missing data*

```{r warning=FALSE}
library(DT)
missing_pct <- sapply(data_main, function(x) mean(is.na(x)) * 100)
missing_pct <- sort(missing_pct[missing_pct > 0], decreasing = TRUE)

missing_table <- data.frame(
  Variable = names(missing_pct),
  Missing_Percent = round(missing_pct, 2)
)

datatable(missing_table,
          colnames = c("Variable", "Missing (%)"),
          caption = "Percentage of Missing Values per Variable")


```


*Correct Typo and data type Harmonization*

```{r include=FALSE}
unique(data_main$age[!grepl("^\\d+$", data_main$age)])

```


```{r}
data_main$age[data_main$age == ">90"] <- "90"
# Copie de sécurité (au cas où)
data_main_clean <- data_main

# delete lines with 100% missing value
data_main_clean <- data_main_clean[!(
  !is.na(data_main_clean$arm) & 
  !is.na(data_main_clean$patref) & 
  rowSums(!is.na(data_main_clean)) == 2
), ]


# 1. Convert age to numeric, ecogps, arm, wk12_dead, wk24_dead

data_main_clean$age <- as.numeric(data_main_clean$age)

#data_main_clean$ecogps <- as.factor(data_main_clean$ecogps)
data_main_clean$arm <- as.factor(data_main_clean$arm)
data_main_clean$wk12_dead <- as.factor(data_main_clean$wk12_dead)
data_main_clean$wk24_dead <- as.factor(data_main_clean$wk24_dead)

# 2. Convert all character variables to factor
char_vars <- sapply(data_main_clean, is.character)
data_main_clean[char_vars] <- lapply(data_main_clean[char_vars], as.factor)

# 3. Vérifier que tout est bien converti
str(data_main_clean)  # ou glimpse(data_main_clean) si tu préfères tidyverse

```


```{r}
# replace "" with NA in factor column
cols_fac <- names(data_main_clean)[sapply(data_main_clean, is.factor)]
for (col in cols_fac) {
  data_main_clean[[col]] <- as.character(data_main_clean[[col]])
  data_main_clean[[col]][data_main_clean[[col]] == ""] <- NA
  data_main_clean[[col]] <- factor(data_main_clean[[col]])
}


data_main_clean <- data_main_clean %>%
  mutate(
    edu_cat = case_when(
      pthighedu %in% c("8th grade or less", "9-11th grade") ~ "Low",
      pthighedu %in% c("High school graduate/GED", "Vocational/technical school") ~ "High school",
      pthighedu %in% c("Associate degree/some college", "Bachelor's degree", "Advanced degree") ~ "College+",
      TRUE ~ NA_character_
    ),
    marital_cat = case_when(
      ptmargstat %in% c("Married", "Domestic partnership") ~ "Married/Partnered",
      ptmargstat %in% c("Never married", "Divorced", "Separated", "Widowed") ~ "Not married",
      ptmargstat %in% c("Unknown/Not reported", "I prefer not to answer", "<NA>") ~ NA_character_,
      TRUE ~ NA_character_
    ),
    race_cat = case_when(
      race1 == "White" ~ "White",
      race1 == "Black or African American" ~ "Black",
      race1 == "Asian" ~ "Asian",
      race1 %in% c("American Indian or Alaska Native", "Native Hawaiian or Other Pacific Islander") ~ "Minority",
      TRUE ~ NA_character_
    )
  )

```








*Define the 3 states clearly*
- A (Active): Alive and completed QoL questionnaire.

- F (Attrition): Alive, but missing QoL questionnaire.

- D (Death): Dead (absorbing).

*Build state variables at T12 and T24*

```{r}

# STEP 0: Restrict to baseline completers
data_main_clean <- subset(data_main_clean, bsl_assess_complete == 1)


# STEP 1: Define states

# At baseline (T0): everyone is "A"
data_main_clean$state_t0 <- "A"

# At week 12 (T12)
data_main_clean$state_t12 <- with(data_main_clean, ifelse(wk12_dead == "1", "D",
                               ifelse(!is.na(fact_chg12), "A", "F")))

# At week 24 (T24)
data_main_clean$state_t24 <- with(data_main_clean, ifelse(wk24_dead == "1", "D",
                               ifelse(!is.na(fact_chg24), "A", "F")))

```



*Mechanism of Missingness / Attrition: justification attrition fonctionelle comme etat week 12*

```{r}
# --- 4. ANALYSE DU MISSINGNESS à 12 semaines
# Définir variable binaire "missing12" : 1 si F (alive but questionnaire missing) ; 0 otherwise (A or D)
data_main_clean$missing12 <- ifelse(data_main_clean$state_t12 == "F", 1, 0)

data_main_clean$sitetype2 <- as.character(data_main_clean$sitetype)
data_main_clean$sitetype2[is.na(data_main_clean$sitetype2)] <- "Unknown"
data_main_clean$sitetype2 <- factor(data_main_clean$sitetype2, 
                                    levels = c("Academic","Community","Unknown"))

miss_preds <- c("age","sex","ecogps","fact_bl","hads_pt_anx_bl","hads_pt_dep_bl",
                "tumrtyp","arm","edu_cat","race_cat","n12","cgpart","sitetype2")

form_miss <- as.formula(paste("missing12 ~", paste(miss_preds, collapse = " + ")))
glm_miss12 <- glm(form_miss, data = data_main_clean, family = binomial)
summary(glm_miss12)



# --- 5. Diagnostics & outputs utiles
# Odds ratios + 95% CI
library(broom)
tidy_miss <- broom::tidy(glm_miss12, conf.int = TRUE, exponentiate = TRUE)
tidy_miss <- tidy_miss %>% select(term, estimate, conf.low, conf.high, p.value)
print(tidy_miss)

# Important : look at site effects
if("site_num" %in% miss_preds) {
  cat("\nTable of missing12 by site_num (counts):\n")
  print(table(data_main_clean$site_num, data_main_clean$missing12))
}
if("sitetype2" %in% miss_preds) {
  cat("\nTable of missing12 by sitetype:\n")
  print(table(data_main_clean$sitetype2, data_main_clean$missing12))
}

```



 *justification attrition fonctionelle comme etat week 12*



```{r}
# --- 4. ANALYSE DU MISSINGNESS à 12 semaines
# Définir variable binaire "missing12" : 1 si F (alive but questionnaire missing) ; 0 otherwise (A or D)
data_main_clean$missing24 <- ifelse(data_main_clean$state_t24 == "F", 1, 0)


miss_preds <- c("age","sex","ecogps","fact_bl","hads_pt_anx_bl","hads_pt_dep_bl",
                "tumrtyp","arm","edu_cat","race_cat","n12","cgpart","sitetype2")

form_miss_24 <- as.formula(paste("missing24 ~", paste(miss_preds, collapse = " + ")))
glm_miss24 <- glm(form_miss_24, data = data_main_clean, family = binomial)
summary(glm_miss24)



# --- 5. Diagnostics & outputs utiles
# Odds ratios + 95% CI
library(broom)
tidy_miss_24 <- broom::tidy(glm_miss24, conf.int = TRUE, exponentiate = TRUE)
tidy_miss_24 <- tidy_miss_24 %>% select(term, estimate, conf.low, conf.high, p.value)
print(tidy_miss_24)

# Important : look at site effects

if("sitetype2" %in% miss_preds) {
  cat("\nTable of missing24 by sitetype:\n")
  print(table(data_main_clean$sitetype2, data_main_clean$missing24))
}

```





# 2. Descriptive analysis

Flow of patients between states (transition counts from T0→T12 and T12→T24).

```{r}
library(dplyr)
library(knitr)
library(kableExtra)

# Transition T0 → T12
tab_t0_t12 <- table(data_main_clean$state_t0, data_main_clean$state_t12)
prop_t0_t12 <- prop.table(tab_t0_t12, margin = 1)

# Transition T12 → T24
tab_t12_t24 <- table(data_main_clean$state_t12, data_main_clean$state_t24)
prop_t12_t24 <- prop.table(tab_t12_t24, margin = 1)

# Fonction pour formatter count (prop%)
format_table <- function(counts, props) {
  matrix(
    paste0(counts, " (", round(100 * props, 1), "%)"),
    nrow = nrow(counts),
    dimnames = dimnames(counts)
  )
}

tab_fmt_t0_t12 <- format_table(tab_t0_t12, prop_t0_t12)
tab_fmt_t12_t24 <- format_table(tab_t12_t24, prop_t12_t24)


# Style tableau T0 → T12
kable(tab_fmt_t0_t12, caption = "Transition T0 → T12: Count (Proportion)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = TRUE, position = "center") %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2") %>%   # En-têtes
  column_spec(1, bold = TRUE)                            # Première colonne en gras

# Style tableau T12 → T24
kable(tab_fmt_t12_t24, caption = "Transition T12 → T24: Count (Proportion)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                full_width = TRUE, position = "center") %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2") %>%
  column_spec(1, bold = TRUE)



```



```{r}
library(DiagrammeR)

grViz("
digraph multi_state {
  graph [layout = dot, rankdir = LR]

  # Styles généraux
  node [style = filled, fontsize = 12, fontname = Helvetica, penwidth = 1.5]
  edge [fontsize = 11, fontname = Helvetica, penwidth = 1.2, color = gray40]

  # États à T0
  T0A [label = 'T0: A', shape = box, fillcolor = lightblue, color = navy]

  # États à T12
  T12A [label = 'T12: A', shape = box, fillcolor = lightblue, color = navy]
  T12D [label = 'T12: D', shape = diamond, fillcolor = lightpink, color = firebrick]
  T12F [label = 'T12: F', shape = ellipse, fillcolor = lightgoldenrod, color = goldenrod4]

  # États à T24
  T24A [label = 'T24: A', shape = box, fillcolor = lightblue, color = navy]
  T24D [label = 'T24: D', shape = diamond, fillcolor = lightpink, color = firebrick]
  T24F [label = 'T24: F', shape = ellipse, fillcolor = lightgoldenrod, color = goldenrod4]

  # Transitions T0 → T12
  T0A -> T12A [label = '192 (54.5%)', color = navy, fontcolor = navy]
  T0A -> T12D [label = '58 (16.5%)', color = firebrick, fontcolor = firebrick]
  T0A -> T12F [label = '102 (29%)', color = goldenrod4, fontcolor = goldenrod4]

  # Transitions T12 → T24
  T12A -> T24A [label = '128 (66.7%)', color = navy, fontcolor = navy]
  T12A -> T24D [label = '23 (12%)', color = firebrick, fontcolor = firebrick]
  T12A -> T24F [label = '41 (21.4%)', color = goldenrod4, fontcolor = goldenrod4]

  T12D -> T24D [label = '58 (100%)', color = firebrick, fontcolor = firebrick]

  T12F -> T24A [label = '20 (19.6%)', color = navy, fontcolor = navy]
  T12F -> T24D [label = '29 (28.4%)', color = firebrick, fontcolor = firebrick]
  T12F -> T24F [label = '53 (52%)', color = goldenrod4, fontcolor = goldenrod4]
}
")

```



*Compare baseline profiles*

```{r warning=FALSE}
library(tableone)

vars <- c("age","sex","ecogps","fact_bl","hads_pt_anx_bl",
          "hads_pt_dep_bl","tumrtyp","arm","edu_cat","race_cat","marital_cat", "n12", "cgpart")

tab1 <- CreateTableOne(vars = vars, data = data_main_clean, test = TRUE)


# Transformer en data.frame
tab_df1 <- as.data.frame(print(tab1, noSpaces = TRUE, printToggle = FALSE))

# Afficher joli tableau
kable(tab_df1, format = "pipe", caption = "Baseline Characteristics")
```



*Baseline characteristics by attrition status at week 12 (A vs F vs D).*

```{r warning=FALSE}
library(tableone)

# Définir l’état à 12 semaines (déjà créé: state_t12)
vars <- c("age","sex","ecogps","fact_bl","hads_pt_anx_bl",
          "hads_pt_dep_bl","tumrtyp","arm","edu_cat","race_cat","marital_cat", "n12", "cgpart")

tab2 <- CreateTableOne(vars = vars, strata = "state_t12", data = data_main_clean, test = TRUE)


# Transformer en data.frame
tab_df2 <- as.data.frame(print(tab2, noSpaces = TRUE, printToggle = FALSE))

# Afficher joli tableau
kable(tab_df2, format = "pipe", caption = "Baseline Characteristics by attrition status at week 12")
```

*Baseline characteristics by attrition status at week 24 (A vs F vs D).*

```{r warning=FALSE}
library(tableone)

vars <- c("age","sex","ecogps","fact_bl","hads_pt_anx_bl",
          "hads_pt_dep_bl","tumrtyp","arm","edu_cat","race_cat","marital_cat", "n12", "cgpart")

tab3 <- CreateTableOne(vars = vars, strata = "state_t24", data = data_main_clean, test = TRUE)


# Transformer en data.frame
tab_df3 <- as.data.frame(print(tab3, noSpaces = TRUE, printToggle = FALSE))

# Afficher joli tableau
kable(tab_df3, format = "pipe", caption = "Baseline Characteristics by attrition status at week 24")
```



# 3. Multi-state modeling

*Transitions T0→T12 (all start in A): multinomial regression for outcome {A, F, D}.*


*Transitions T12→T24:*

Subgroup A at T12 → multinomial regression {A, F, D}

Subgroup F at T12 → multinomial regression {A, F, D}

*Missingness patterns among baseline predictor for the model multi state*

```{r}
library(DT)
library(ggplot2)

# Liste des variables à analyser
vars <- c("age","sex","ecogps","fact_bl","hads_pt_anx_bl",
          "hads_pt_dep_bl","tumrtyp","arm","n12",
          "edu_cat","race_cat", "cgpart")

# Calcul % de NA pour toutes les variables de la liste
missing_pct <- sapply(data_main_clean[vars], function(x) mean(is.na(x)) * 100)

# Trier
missing_pct <- sort(missing_pct, decreasing = TRUE)

# Mettre sous forme de data.frame
missing_table <- data.frame(
  Variable = names(missing_pct),
  Missing_Percent = round(missing_pct, 2)
)

# Tableau interactif
datatable(
  missing_table,
  colnames = c("Variable", "Missing (%)"),
  caption = "Percentage of Missing Values per Selected Variable"
)

# Barplot horizontal avec labels
ggplot(missing_table, aes(x = reorder(Variable, Missing_Percent), 
                          y = Missing_Percent)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = paste0(Missing_Percent, "%")), 
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  labs(title = "Missing Data Percentage per Selected Variable",
       x = "Variable",
       y = "Missing (%)") +
  theme_minimal(base_size = 13) +
  ylim(0, max(missing_table$Missing_Percent) + 10)  # espace pour le texte



```

```{r}
# Remove rows with missing values in specific variables
data_main_clean <- data_main_clean[!is.na(data_main_clean$edu_cat) &
                                   !is.na(data_main_clean$race_cat) &
                                   !is.na(data_main_clean$marital_cat), ]


```

*recheck missingness pattern*

```{r}
# Calcul % de NA pour toutes les variables de la liste
missing_pct <- sapply(data_main_clean[vars], function(x) mean(is.na(x)) * 100)

# Trier
missing_pct <- sort(missing_pct, decreasing = TRUE)

# Mettre sous forme de data.frame
missing_table <- data.frame(
  Variable = names(missing_pct),
  Missing_Percent = round(missing_pct, 2)
)

# Tableau interactif
datatable(
  missing_table,
  colnames = c("Variable", "Missing (%)"),
  caption = "Percentage of Missing Values per Selected Variable"
)

# Barplot horizontal avec labels
ggplot(missing_table, aes(x = reorder(Variable, Missing_Percent), 
                          y = Missing_Percent)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = paste0(Missing_Percent, "%")), 
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  labs(title = "Missing Data Percentage per Selected Variable",
       x = "Variable",
       y = "Missing (%)") +
  theme_minimal(base_size = 13) +
  ylim(0, max(missing_table$Missing_Percent) + 10)  # espace pour le texte


```










Modeling approach for T12 → T24 transitions

"For the T0 → T12 transitions, a Lasso-penalized multinomial logistic regression was used to identify key predictors associated with each transition. For the T12 → T24 transitions, the Lasso did not retain any variables, likely due to weaker signal or smaller sample size in the stratified subgroups. To address this and still model the probabilities of state transitions, we applied a Ridge-penalized multinomial regression for T12 → T24. This approach stabilizes coefficient estimates in the presence of weak signals and avoids over-shrinkage of potentially relevant predictors. We acknowledge the difference in penalization strategy between the two time intervals and justify it based on the data-driven need to obtain meaningful estimates. Predicted probabilities and marginal effects were subsequently computed for both time intervals to characterize the impact of covariates on transition probabilities."

```{r}
library(nnet)
library(glmnet)
library(dplyr)
library(tibble)




# ===============================
# Fonction utilitaire pour résumer un modèle multinomial
# ===============================
mk_results_table <- function(fit, transition_name){
  summ <- summary(fit)
  coefs <- summ$coefficients
  ses   <- summ$standard.errors
  zvals <- coefs / ses
  pvals <- 2 * (1 - pnorm(abs(zvals)))
  
  out <- lapply(seq_len(nrow(coefs)), function(i){
    data.frame(
      Transition = transition_name,
      Outcome  = rownames(coefs)[i],
      Variable = colnames(coefs),
      OR       = exp(coefs[i,]),
      CI_low   = exp(coefs[i,] - 1.96*ses[i,]),
      CI_high  = exp(coefs[i,] + 1.96*ses[i,]),
      p_value  = pvals[i,],
      row.names = NULL
    )
  }) |> bind_rows() |>
    mutate(
      across(c(OR, CI_low, CI_high), ~round(.,2)),
      p_value = signif(p_value, 3)
    )
  
  out
}

# ===============================
# Fonction générique : Lasso/Ridge + refit multinom
# ===============================
fit_glmnet_multinom <- function(df, outcome, predictors, alpha = 1, seed = 123, transition_name){
  set.seed(seed)
  
  X <- model.matrix(~ . -1, data = df[, predictors])
  y <- df[[outcome]]
  
  # CV glmnet
  fit_glm <- cv.glmnet(X, y, family = "multinomial",
                       alpha = alpha, type.multinomial = "grouped")
  
  # Variables non-nulles
  coefs_list <- coef(fit_glm, s = "lambda.min")
  nz_vars <- unique(unlist(lapply(coefs_list, function(m){
    rownames(m)[as.numeric(m) != 0]
  })))
  nz_vars <- setdiff(nz_vars, "(Intercept)")
  
  # Mapper les dummies vers variables originales
  selected_preds <- predictors[sapply(predictors, function(var){
    any(grepl(paste0("^", var), nz_vars))
  })]
  
  # Refit multinom si au moins une variable
  if(length(selected_preds) > 0){
    form <- reformulate(selected_preds, response = outcome)
    fit_multi <- multinom(form, data = df, trace = FALSE)
    results <- mk_results_table(fit_multi, transition_name)
  } else {
    results <- tibble(
      Transition = transition_name,
      Outcome = NA,
      Variable = NA,
      OR = NA,
      CI_low = NA,
      CI_high = NA,
      p_value = NA,
      Note = "No variable retained by GLMNET"
    )
  }
  
  return(results)
}

# ===============================
# Définition des prédicteurs
# ===============================
preds_t0_t12 <- c("age","sex","ecogps","fact_bl",
                  "hads_pt_anx_bl","hads_pt_dep_bl",
                  "tumrtyp","arm","edu_cat","cgpart")

preds_t12_t24 <- c("age","sex","ecogps","fact_bl",
                   "hads_pt_anx_bl","tumrtyp","arm")

# ===============================
# T0 → T12 : Lasso
# ===============================
res_t0_t12 <- fit_glmnet_multinom(
  df = data_main_clean,
  outcome = "state_t12",
  predictors = preds_t0_t12,
  alpha = 1,
  transition_name = "T0→T12"
)

# ===============================
# T12 → T24 (A only) : Ridge
# ===============================
df_A <- subset(data_main_clean, state_t12 == "A")
res_t12_t24_A <- fit_glmnet_multinom(
  df = df_A,
  outcome = "state_t24",
  predictors = preds_t12_t24,
  alpha = 0,
  transition_name = "T12→T24 (A only)"
)

# T12 → T24 (F only) : Ridge
df_F <- subset(data_main_clean, state_t12 == "F")
res_t12_t24_F <- fit_glmnet_multinom(
  df = df_F,
  outcome = "state_t24",
  predictors = preds_t12_t24,
  alpha = 0,
  transition_name = "T12→T24 (F only)"
)

# ===============================
# Combinaison des résultats dans un seul tableau global
# ===============================
results_all <- bind_rows(res_t0_t12, res_t12_t24_A, res_t12_t24_F)

# Résultat final prêt à publier
results_all




```


```{r}
library(nnet)
library(glmnet)
library(dplyr)
library(knitr)
library(kableExtra)

# 1) Make sure reference is A
data_main_clean$state_t12 <- factor(data_main_clean$state_t12, levels = c("A","F","D"))
data_main_clean$state_t24 <- factor(data_main_clean$state_t24, levels = c("A","F","D"))

## ===============================
## --- Fonction pour résumer un multinom et ajouter indicateur significatif
## ===============================
mk_results_table <- function(fit, transition_name, alpha = 0.05){
  summ <- summary(fit)
  coefs <- summ$coefficients
  ses   <- summ$standard.errors
  zvals <- coefs / ses
  pvals <- 2 * (1 - pnorm(abs(zvals)))
  
  out <- lapply(seq_len(nrow(coefs)), function(i){
    data.frame(
      Transition = transition_name,
      Outcome    = rownames(coefs)[i],
      Variable   = colnames(coefs),
      OR         = exp(coefs[i,]),
      CI_low     = exp(coefs[i,] - 1.96*ses[i,]),
      CI_high    = exp(coefs[i,] + 1.96*ses[i,]),
      p_value    = pvals[i,],
      Signif     = ifelse(pvals[i,] < alpha, "*", "")
    )
  }) |> bind_rows()
  
  out %>%
    mutate(across(c(OR, CI_low, CI_high), ~round(., 2)),
           p_value = signif(p_value, 3))
}

## ===============================
## --- T0 -> T12 ---
## ===============================
preds_t0_t12 <- c("age","sex","ecogps","fact_bl",
                  "hads_pt_anx_bl","hads_pt_dep_bl",
                  "tumrtyp","arm","edu_cat","cgpart")

X_t0_t12 <- model.matrix(~ . , data = data_main_clean[, preds_t0_t12])
y_t0_t12 <- data_main_clean$state_t12

fit_t0_t12_glmnet <- cv.glmnet(X_t0_t12, y_t0_t12, family = "multinomial", alpha = 1)

coefs_list_t0_t12 <- coef(fit_t0_t12_glmnet, s = "lambda.min")
nz_vars_t0_t12 <- unique(unlist(lapply(coefs_list_t0_t12, function(m) rownames(m)[as.numeric(m)!=0])))
nz_vars_t0_t12 <- setdiff(nz_vars_t0_t12, "(Intercept)")

map_to_orig <- function(vars, preds){
  preds[sapply(preds, function(p) any(grepl(p, vars)))]
}

selected_preds_t0_t12 <- map_to_orig(nz_vars_t0_t12, preds_t0_t12)
form_t0_t12 <- reformulate(termlabels = selected_preds_t0_t12, response = "state_t12")
fit_multi_t0_t12 <- multinom(form_t0_t12, data = data_main_clean, trace = FALSE)

results_t0_t12 <- mk_results_table(fit_multi_t0_t12, transition_name = "T0→T12")


## ===============================
## --- T12 -> T24 (A only) ---
## ===============================
preds_t12_t24 <- c("age","sex","ecogps","fact_bl",
                   "hads_pt_anx_bl",
                   "tumrtyp","arm")

df_A <- subset(data_main_clean, state_t12 == "A")
X_A <- model.matrix(~ . -1, data = df_A[, preds_t12_t24])
y_A <- df_A$state_t24

set.seed(123)
fit_A_glmnet <- cv.glmnet(X_A, y_A, family = "multinomial", alpha = 0, type.multinomial = "grouped")

coefs_list_A <- coef(fit_A_glmnet, s = "lambda.min")
nz_vars_A <- unique(unlist(lapply(coefs_list_A, function(m) rownames(m)[as.numeric(m) != 0])))
nz_vars_A <- setdiff(nz_vars_A, "(Intercept)")

selected_preds_A <- preds_t12_t24[sapply(preds_t12_t24, function(var) any(grepl(paste0("^", var), nz_vars_A)))]

if(length(selected_preds_A) > 0){
  form_A <- reformulate(termlabels = selected_preds_A, response = "state_t24")
  fit_multi_A <- multinom(form_A, data = df_A, trace = FALSE)
  results_t12_t24_A <- mk_results_table(fit_multi_A, transition_name = "T12→T24 (A only)")
} else {
  results_t12_t24_A <- data.frame(
    Transition = "T12→T24 (A only)",
    Outcome = NA,
    Variable = NA,
    OR = NA,
    CI_low = NA,
    CI_high = NA,
    p_value = NA,
    Signif = NA
  )
}

results_t12_t24_A <- results_t12_t24_A %>%
  mutate(
    Transition = ifelse(!is.na(Transition) & grepl("A only", Transition),
                        "T12→T24",
                        Transition)
  )

## ===============================
## --- Combine results ---
## ===============================
final_results <- bind_rows(results_t0_t12, results_t12_t24_A)

## ===============================
## --- Publication-ready table ---
## ===============================
final_results %>%
  kable("html", caption = "Multinomial Regression Results with ORs, 95% CI and p-values\n(Note: Odds Ratios for D and F are versus A)", row.names = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(7, color = ifelse(final_results$Signif == "*", "red", "black"))

```



2) Effets marginaux moyens (AME) — génériques et robustes

Continues : différence de proba lorsque la variable augmente de +1 (tu peux changer delta).

Facteurs : différence de proba entre chaque niveau et le niveau de référence.

```{r}
# ===============================
# 5) AME pour illustrer effet moyen des covariables
# ===============================
ame_multinom <- function(fit, data, cont_vars = NULL, factor_vars = NULL, delta = 1){
  classes <- colnames(predict(fit, newdata=data, type="probs"))
  base_pred <- as.matrix(predict(fit, newdata=data, type="probs"))

  # AME cont
  ame_cont <- list()
  if(!is.null(cont_vars)){
    for(v in cont_vars){
      d_cf <- data
      d_cf[[v]] <- d_cf[[v]] + delta
      cf_pred <- as.matrix(predict(fit, newdata=d_cf, type="probs"))
      diff <- (cf_pred - base_pred)/delta
      ame_v <- colMeans(diff, na.rm=TRUE)
      ame_cont[[v]] <- data.frame(Variable=v, Outcome=classes, AME=as.numeric(ame_v))
    }
  }
  ame_cont <- if(length(ame_cont)) bind_rows(ame_cont) else NULL

  # AME facteurs
  ame_fact <- list()
  if(!is.null(factor_vars)){
    for(v in factor_vars){
      levs <- levels(data[[v]])
      ref <- levs[1]
      for(lv in levs[-1]){
        d_ref <- data; d_ref[[v]] <- factor(ref, levels=levs)
        d_lv  <- data; d_lv[[v]]  <- factor(lv, levels=levs)
        p_ref <- as.matrix(predict(fit, newdata=d_ref, type="probs"))
        p_lv  <- as.matrix(predict(fit, newdata=d_lv,  type="probs"))
        diff  <- p_lv - p_ref
        ame_v <- colMeans(diff, na.rm=TRUE)
        ame_fact[[paste(v,lv,sep=":")]] <- data.frame(
          Variable = paste0(v," (",lv," vs ",ref,")"),
          Outcome  = classes,
          AME      = as.numeric(ame_v)
        )
      }
    }
  }
  ame_fact <- if(length(ame_fact)) bind_rows(ame_fact) else NULL

  bind_rows(ame_cont, ame_fact)
}

cont_vars_t0_t12 <- intersect(selected_preds_t0_t12, c("age","ecogps","fact_bl","hads_pt_anx_bl","hads_pt_dep_bl"))
factor_vars_t0_t12 <- intersect(selected_preds_t0_t12, c("sex","tumrtyp","arm","edu_cat","cgpart"))

ame_t0_t12 <- ame_multinom(fit_multi_t0_t12, data_main_clean, cont_vars_t0_t12, factor_vars_t0_t12)

cont_vars_A <- intersect(selected_preds_A, c("age","ecogps","fact_bl","hads_pt_anx_bl","hads_pt_dep_bl"))
factor_vars_A <- intersect(selected_preds_A, c("sex","tumrtyp","arm"))

ame_t12_t24 <- ame_multinom(fit_multi_A, df_A, cont_vars_A, factor_vars_A)

# ===============================
# 6) Visualisation AME
# ===============================
plot_ame <- function(ame_df, title="Average Marginal Effects"){
  ame_df <- ame_df %>% mutate(Variable = str_wrap(Variable, width=40))
  ggplot(ame_df, aes(x=Variable, y=AME, fill=Outcome)) +
    geom_col(position="dodge") +
    coord_flip() +
    labs(title=title, x="Covariates", y="AME (change in predicted probability)") +
    theme_minimal(base_size=12) +
    theme(axis.text.y = element_text(angle=0, hjust=1, size=10))
}



library(kableExtra)

# Pour T0 → T12
ame_t0_t12 %>%
  kable("html", caption = "Average Marginal Effects (T0 → T12)", row.names = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover")) %>%
  column_spec(3, color = ifelse(ame_t0_t12$AME > 0, "blue", "red"))

# Pour T12 → T24
ame_t12_t24 %>%
  kable("html", caption = "Average Marginal Effects (T12 → T24)", row.names = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover")) %>%
  column_spec(3, color = ifelse(ame_t12_t24$AME > 0, "blue", "red"))

plot_ame(ame_t0_t12, title="AMEs for T0 → T12 transitions")
plot_ame(ame_t12_t24, title="AMEs for T12 → T24 transitions (vs A)")


```







3) Profils cliniques types (illustration clinique)

```{r}
library(dplyr)
library(knitr)
library(kableExtra)

# ===============================
# Profils cliniques T0 → T12
# ===============================
profiles_t0_t12 <- tribble(
  ~age, ~sex, ~ecogps, ~fact_bl, ~hads_pt_anx_bl, ~hads_pt_dep_bl, ~tumrtyp,  ~arm, ~edu_cat, ~cgpart,
  45, "f", 0, 85, 3, 2, "Esophageal/GEJ/Gastric", "1", "College+", "Yes",
  45, "f", 0, 85, 12, 6, "Esophageal/GEJ/Gastric", "1", "College+", "Yes",
  75, "m", 2, 60, 3, 2, "Hepatic/Biliary/Pancreatic/Unknown primary", "2", "Low", "Yes",
  75, "m", 2, 60, 12, 10, "Hepatic/Biliary/Pancreatic/Unknown primary", "2", "Low", "Yes",
  45, "f", 0, 85, 3, 2, "Esophageal/GEJ/Gastric", "1", "College+", "No",
  45, "f", 0, 85, 12, 6, "Esophageal/GEJ/Gastric", "1", "College+", "No",
  75, "m", 2, 60, 3, 2, "Hepatic/Biliary/Pancreatic/Unknown primary", "2", "Low", "No",
  75, "m", 2, 60, 12, 10, "Hepatic/Biliary/Pancreatic/Unknown primary", "2", "Low", "No"
) %>%
  mutate(
    across(c(sex, tumrtyp, arm, edu_cat, cgpart), as.character),
    across(c(age, ecogps, fact_bl, hads_pt_anx_bl, hads_pt_dep_bl), as.numeric),
    label = paste(
      ifelse(age < 60, "Young fit", "Old fragile"),
      ifelse(hads_pt_anx_bl <= 6, "low anxiety", "high anxiety"),
      ifelse(cgpart == "Yes", "caregiver", "no caregiver"),
      tumrtyp,
      edu_cat,
      sep = ", "
    )
  )

# ===============================
# Profils cliniques T12 → T24
# ===============================
profiles_t12_t24 <- tribble(
  ~label, ~age, ~sex, ~ecogps, ~fact_bl, ~hads_pt_anx_bl, ~tumrtyp, ~arm,

  # Young patients
  #"Young fit, low anxiety, Esophageal/GEJ, Arm1", 45, "f", 0, 85, 3, "Esophageal/GEJ/Gastric", "1",
  "Young fit, high anxiety, Esophageal/GEJ, Arm1", 45, "f", 0, 85, 12, "Esophageal/GEJ/Gastric", "1",
  "Young fit, low anxiety, Lung, Arm1", 45, "m", 0, 80, 3, "Lung", "1",
  "Young fit, high anxiety, Lung, Arm1", 45, "m", 0, 80, 12, "Lung", "1",

  # Older patients
  "Old fragile, low anxiety, Hepatic/Biliary, Arm2", 75, "m", 2, 60, 3, "Hepatic/Biliary/Pancreatic/Unknown primary", "2",
  "Old fragile, high anxiety, Hepatic/Biliary, Arm2", 75, "m", 2, 60, 12, "Hepatic/Biliary/Pancreatic/Unknown primary", "2",
  "Old fragile, low anxiety, Lung, Arm2", 75, "f", 2, 65, 3, "Lung", "2",
  "Old fragile, high anxiety, Lung, Arm2", 75, "f", 2, 65, 12, "Lung", "2"
) %>%
  mutate(
    across(c(sex, tumrtyp, arm), as.character)
  )

# ===============================
# Fonction pour prédire les probabilités
# ===============================
predict_profiles <- function(model, profiles, selected_preds, reference_data){
  for(col in selected_preds){
    if(col %in% names(profiles)){  # <- ignore si la colonne n’existe pas
      if(is.factor(reference_data[[col]]) || is.character(reference_data[[col]])){
        profiles[[col]] <- factor(profiles[[col]], levels=levels(factor(reference_data[[col]])))
      } else { 
        profiles[[col]] <- as.numeric(profiles[[col]]) 
      }
    }
  }
  probs <- predict(model, newdata=profiles, type="probs")
  results <- as.data.frame(probs)
  results$label <- profiles$label
  results <- results %>% relocate(label) %>% mutate(across(where(is.numeric), ~round(.x,3)))
  return(results)
}


# ===============================
# Fonction pour colorer la probabilité max
# ===============================
highlight_max_prob <- function(df, prob_cols) {
  df %>%
    rowwise() %>%
    mutate(across(all_of(prob_cols),
                  ~cell_spec(.x, "html",
                             color = ifelse(.x == max(c_across(all_of(prob_cols))), "white", "black"),
                             background = ifelse(.x == max(c_across(all_of(prob_cols))), "steelblue", "white")))) %>%
    ungroup()
}

# ===============================
# Prédictions et affichage
# ===============================
# T0 → T12
res_profiles_t0_t12 <- predict_profiles(fit_multi_t0_t12, profiles_t0_t12, selected_preds_t0_t12, data_main_clean)
res_profiles_t0_t12_colored <- highlight_max_prob(res_profiles_t0_t12, colnames(res_profiles_t0_t12)[-1])

res_profiles_t0_t12_colored %>%
  kable("html", escape = FALSE,
        caption = "Predicted Probabilities for T0 → T12 Transitions by Clinical Profile",
        row.names = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, bold = TRUE, color = "blue") %>%
  add_footnote("Note: Probabilities of being in A, F or D are calculated versus A (Active) in the previous state.")

# T12 → T24
res_profiles_t12_t24 <- predict_profiles(fit_multi_A, profiles_t12_t24, selected_preds_A, df_A)
res_profiles_t12_t24_colored <- highlight_max_prob(res_profiles_t12_t24, colnames(res_profiles_t12_t24)[-1])

res_profiles_t12_t24_colored %>%
  kable("html", escape = FALSE,
        caption = "Predicted Probabilities for T12 → T24 Transitions by Clinical Profile",
        row.names = FALSE) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover")) %>%
  column_spec(1, bold = TRUE, color = "blue") %>%
  add_footnote("Note: Probabilities of being in A, F or D are calculated versus A (Active) in the previous state.")


```



